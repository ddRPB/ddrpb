<?xml version="1.0" encoding="UTF-8" ?>

<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:p="http://primefaces.org/ui"
    template="/WEB-INF/layouts/main.xhtml"
    >

    <!-- Definition of bradcrumbs place holder -->
    <ui:define name="breadcrumbs">
        <p:breadCrumb>
            <p:menuitem value="#{msg.home}" title="#{msg.home}" url="/home.faces" />
            <p:menuitem value="Data" title="Data" url="#" />
            <p:menuitem value="#{msg.study} Data Query" title=" #{msg.study} Data Query" url="/edc/studyDataQuery.faces" />
        </p:breadCrumb>
    </ui:define>

    <ui:define name="content">

        <p:tabView id="tabView">

            <p:tab title="#{msg.study} Data Query">

                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                            value="#{msg.menu_help}"
                            title="#{msg.menu_help}"
                            icon="ui-icon-help"
                            disabled="True"
                            />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Form -->
                <p:panelGrid
                    columns="2"
                    cellpadding="4"
                    style="margin:0 auto;float: left;"
                    >

                    <!-- Show user the active study -->
                    <h:outputLabel value="Base-#{msg.study}:" for="txtStudyIdentifier" />
                    <h:outputText id="txtStudyIdentifier" value="#{mbQueryData.mainBean.activeStudy.uniqueIdentifier}" />

                    <!-- Criteria Data Table -->

                    <!-- Logical operator (empty for first item) -->

                    <!-- Study -->
                    <h:outputLabel value="Cross-#{msg.study}:#{msg.label_required_suffix}" for="ddlStudies" />
                    <p:selectOneMenu
                        id="ddlStudies"
                        value="#{mbQueryData.selectedStudy}"
                        converter="omnifaces.SelectItemsConverter"
                        filter="true"
                        filterMatchMode="contains"
                        var="studyIter"
                        required="true"
                        panelStyle="width:150px"
                        style="width:300px"
                        >
                        <p:ajax update=":form:tabView:ddlSites,:form:tabView:ddlCrfFieldAnnotations" />
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                        <f:selectItems
                            value="#{mbQueryData.studies}"
                            itemLabel="#{study.name}"
                            itemValue="#{study}"
                            var="study"
                            />
                            <p:column>
                                <h:outputText value="#{studyIter.name}" title="#{studyIter.title}" />
                            </p:column>
                    </p:selectOneMenu>

                    <!-- EDC Study Sites -->
                    <h:outputLabel value="Site:" for="ddlSites" />
                    <p:selectOneMenu
                        id="ddlSites"
                        value="#{mbQueryData.selectedStudySite}"
                        converter="omnifaces.SelectItemsConverter"
                        filter="true"
                        filterMatchMode="contains"
                        var="siteIter"
                        panelStyle="width:150px"
                        style="width:300px"
                        disabled="#{not mbQueryData.selectedStudy.isEdcStudyMultiCentre}"
                        >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                        <f:selectItems
                            value="#{mbQueryData.selectedStudy.edcStudy.studySites}"
                            var="site"
                            itemLabel="#{site.name}"
                            itemValue="#{site}"
                            />
                        <p:column>
                            <h:outputText value="#{siteIter.name}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Annotated CRF items -->
                    <h:outputLabel value="#{msg.crfFieldAnnotation_plural}:#{msg.label_required_suffix}" for="ddlCrfFieldAnnotations" />
                    <p:selectManyMenu
                        id="ddlCrfFieldAnnotations"
                        value="#{mbQueryData.selectedAnnotations}"
                        converter="omnifaces.SelectItemsConverter"
                        style="width:350px"
                        required="true"
                        filter="true"
                        filterMatchMode="contains"
                        showCheckbox="true"
                        var="annotation"
                        scrollHeight="220"
                        >
                        <p:ajax />
                        <f:selectItems
                            value="#{mbQueryData.selectedStudy.crfFieldAnnotations}"
                            var="annoIter"
                            itemValue="#{annoIter}"
                            itemLabel="#{annoIter.annotationType.name}"
                            itemDescription="#{annoIter.annotationType.description}"
                            />
                        <p:column>
                            <h:outputText
                                value="#{annotation.annotationType.name}"
                                title="#{annotation.eventDefinitionOid} -> #{annotation.formOid}: #{annotation.annotationType.description}"
                                />
                        </p:column>
                    </p:selectManyMenu>

                    <!-- Comparator -->

                    <!-- Value -->
                    
                </p:panelGrid>
            </p:tab>

            <p:tab title="#{msg.studySubject_plural}">

                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Left -->
                    <p:toolbarGroup align="left">

                        <p:commandButton
                            id="btnQueryData"
                            value="#{msg.menu_reload}"
                            icon="ui-icon-refresh"
                            style="float: left;"
                            immediate="true"
                            process="@this"
                            update=":form:tabView:dtEntities, :growl"
                            oncomplete="PF('entitiesTable').filter()"
                            actionListener="#{mbQueryData.queryData}"
                            />

                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                            value="#{msg.menu_print}"
                            title="#{msg.studySubject_print}"
                            icon="ui-icon-print"
                            >
                            <p:printer target="dtEntities" />
                        </p:commandButton>
                        <p:commandButton
                            value="#{msg.menu_help}"
                            title="#{msg.menu_help}"
                            icon="ui-icon-help"
                            disabled="True"
                            />
                    </p:toolbarGroup>

                </p:toolbar>

                <!-- Data table -->
                <p:dataTable
                    id="dtEntities"
                    var="entity"
                    value="#{mbQueryData.studySubjects}"
                    widgetVar="entitiesTable"
                    resizableColumns="true"
                    draggableColumns="false"
                    paginator="true"
                    rows="15"
                    rowsPerPageTemplate="15,25,50,100"
                    emptyMessage="#{msg.search_empty}"
                    rowKey="#{entity.studySubjectId}"
                    rowIndexVar="rowIndex"
                    filteredValue="#{mbQueryData.filteredStudySubjects}"
                    sortMode="multiple"
                    sortOrder="ASCENDING"
                    sortBy="#{mbQueryData.subjectsPreSortOrder}"
                    disabledTextSelection="false"
                    >

                    <!-- Table header -->
                    <f:facet name="header">
                        <h:outputText value="#{mbQueryData.mainBean.activeStudy.uniqueIdentifier}" style="float:left" />
                        <p:commandButton id="btnEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler
                            datasource="dtEntities"
                            trigger=":form:tabView:dtEntities:btnEntitiesToggler"
                            style="width:450px"
                            >
                            <p:ajax event="toggle" listener="#{mbQueryData.onSubjectEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- StudySubjectID -->
                    <p:column
                        id="colStudySubjectId"
                        sortBy="#{entity.studySubjectId}"
                        filterBy="#{entity.studySubjectId}"
                        filterMatchMode="contains"
                        visible="#{mbQueryData.subjectsColumnVisibilityList[1]}"
                        style="width:10%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.studySubject_studySubjectId}" />
                        </f:facet>
                        <h:outputText value="#{entity.studySubjectId}" style="float: left;" />
                    </p:column>

                    <!-- PID -->
                    <p:column
                        sortBy="#{entity.pid}"
                        filterBy="#{entity.pid}"
                        filterMatchMode="contains"
                        visible="#{mbQueryData.subjectsColumnVisibilityList[2]}"
                        style="width:10%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.studySubject_personId}" />
                        </f:facet>
                        <h:outputText value="#{entity.pid}" style="font-family:consolas, courier new,monospace;float: left;" />
                    </p:column>

                    <!-- Column for each selected annotation -->
                    <p:columns
                        value="#{mbQueryData.selectedAnnotations}"
                        var="selAnnotation"
                        style="width:10%"
                        columnIndexVar="colIndex"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{selAnnotation.annotationType.name}" title="#{selAnnotation.eventDefinitionOid} -> #{selAnnotation.formOid}: #{selAnnotation.annotationType.description}" />
                        </f:facet>

                        <!-- All event occurences annotation -->
                        <p:dataTable
                            id="dtEvents"
                            var="event"
                            value="#{studySubject.getEventOccurrencesForEventDef(dicomStudyEvent)}"
                            widgetVar="subjectEventsTable"
                            emptyMessage="#{msg.search_empty}"
                            rowKey="#{event.studyEventRepeatKey}"
                            rowIndexVar="subjectEventRowIndex"
                            disabledTextSelection="false"
                            >

                            <!-- Row -->
                            <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                                <h:outputText value="#{subjectEventRowIndex + 1}" />
                            </p:column>

                            <!-- All annotated ItemData in Event -->
                            <p:columns
                                value="#{mbDicomMatrix.rpbStudy.findAnnotatedItemDefinitionsForEventDef('DICOM_STUDY_INSTANCE_UID', dicomStudyEvent)}"
                                var="dicomStudyItemDefinition"
                                style="width:10%"
                                columnIndexVar="col2Index"
                                >
                                <f:facet name="header">
                                    <h:outputText value="#{dicomStudyItemDefinition.label}" title="#{dicomStudyItemDefinition.description}" />
                                </f:facet>

                                <h:inputText
                                    value="#{mbDicomMatrix.loadDicomStudyType(studySubject, event, dicomStudyItemDefinition)}"
                                    title="#{mbDicomMatrix.loadDicomStudyLegend(studySubject, event, dicomStudyItemDefinition)}"
                                    styleClass="#{mbDicomMatrix.loadDicomStudyStatus(studySubject, event, dicomStudyItemDefinition)}"
                                    readonly="true"
                                    />
                            </p:columns>
                        </p:dataTable>


                    </p:columns>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbQueryData.studySubjects.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbQueryData.studySubjects.size() == 1}" />
                        <h:outputFormat
                            value="#{msg.search_results_status_n}"
                            rendered="#{mbQueryData.studySubjects.size() > 1}"
                            >
                            <f:param value="#{mbQueryData.studySubjects.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtEntities" fileName="#{msg.studySubject_plural}-query" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtEntities" fileName="#{msg.studySubject_plural}-query" />
                    </h:commandLink>
                </p:panel>
            </p:tab>

        </p:tabView>
    </ui:define>

    <!-- Definition of dialogs place holder -->
    <ui:define name="dialogs" />
</ui:composition>