<?xml version="1.0" encoding="UTF-8" ?>

<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:p="http://primefaces.org/ui"
    template="/WEB-INF/layouts/main.xhtml"
    >

    <!-- Metadata -->
    <ui:define name="metadata">
        <f:metadata>
            <!-- View query strings -->
            <f:viewParam name="pid" value="#{mbPatient.newSearchPerson.pid}" />
            <f:event type="preRenderView" listener="#{mbPatient.onLoad}" />
        </f:metadata>
    </ui:define>

    <!-- Definition of breadcrumbs placeholder -->
    <ui:define name="breadcrumbs">
        <p:breadCrumb>
            <p:menuitem value="#{msg.home}" title="#{msg.home}" url="/home.faces" />
            <p:menuitem value="#{msg.person_pid}" title="#{msg.person_pid} - Patient Centric View" url="/pid/pidCRUD.faces" />
        </p:breadCrumb>
    </ui:define>

    <!-- Definition of page content placeholder -->
    <ui:define name="content">

        <!-- Main Tab -->
        <p:tabView id="tabView" activeIndex="#{mbPatient.tab.activeIndex}">

            <!-- Patient PIDs and IDAT -->
            <p:tab title="#{msg.person_patient_plural}">

                <!-- Patient Search Form -->
                <p:accordionPanel id="pnlSearchPatient" multiple="true">

                    <p:tab title="#{msg.search_mode}">
                        <p:panelGrid columnClasses="column" columns="2">
                            <!-- Search Mode -->
                            <h:outputLabel value="#{msg.person_idat}:" />
                            <p:inputSwitch value="#{mbPatient.idatSearchMode}">
                                <p:ajax update=":form:tabView:pnlSearchPatient:pnlSearchCriteria, :growl" />
                            </p:inputSwitch>
                        </p:panelGrid>
                    </p:tab>

                    <!-- Search Criteria -->
                    <p:tab title="#{msg.search_criteria}">

                        <p:panelGrid id="pnlSearchCriteria" columnClasses="column" columns="2">

                            <!-- PID - pseudonym -->
                            <h:outputLabel value="#{msg.person_pid}: #{msg.label_required_suffix}" for="txtPid" rendered="#{!mbPatient.idatSearchMode}" />
                            <p:inputText
                                id="txtPid"
                                value="#{mbPatient.newSearchPerson.pid}"
                                required="true"
                                requiredMessage="#{msg.person_pid} #{msg.validation_required}!"
                                rendered="#{!mbPatient.idatSearchMode}"
                                />

                            <!-- FirstName -->
                            <h:outputLabel value="#{msg.person_firstname}: #{msg.label_required_suffix}" for="txtFirstName" rendered="#{mbPatient.idatSearchMode}" />
                            <p:inputText
                                    id="txtFirstName"
                                    value="#{mbPatient.newSearchPerson.firstname}"
                                    required="true"
                                    requiredMessage="#{msg.person_firstname} is mandatory!"
                                    rendered="#{mbPatient.idatSearchMode}"
                                    />

                            <!-- LastName -->
                            <h:outputLabel value="#{msg.person_surname}: #{msg.label_required_suffix}" for="txtLastName" rendered="#{mbPatient.idatSearchMode}" />
                            <p:inputText
                                    id="txtLastName"
                                    value="#{mbPatient.newSearchPerson.surname}"
                                    required="true"
                                    requiredMessage="#{msg.person_surname} is mandatory!"
                                    rendered="#{mbPatient.idatSearchMode}"
                                    />

                            <!-- Birthdate -->
                            <h:outputLabel value="#{msg.person_birthdate}: #{msg.label_required_suffix}" for="dateOfBirth" rendered="#{mbPatient.idatSearchMode}" />
                            <p:calendar
                                    id="dateOfBirth"
                                    pattern="dd.MM.yyyy"
                                    value="#{mbPatient.newSearchPerson.birthdate}"
                                    required="true"
                                    requiredMessage="#{msg.person_birthdate} is mandatory!"
                                    rendered="#{mbPatient.idatSearchMode}"
                                    />

                            <!-- City -->
                            <h:outputLabel value="#{msg.person_city}: " for="txtCity" rendered="#{mbPatient.idatSearchMode}" />
                            <p:inputText id="txtCity" value="#{mbPatient.newSearchPerson.city}" rendered="#{mbPatient.idatSearchMode}" />

                            <!-- ZIP -->
                            <h:outputLabel value="#{msg.person_zip}:" for="txtZip" rendered="#{mbPatient.idatSearchMode}" />
                            <p:inputText id="txtZip" value="#{mbPatient.newSearchPerson.zipcode}" rendered="#{mbPatient.idatSearchMode}" />

                            <!-- Commands -->
                            <f:facet name="footer">
                                <p:commandButton
                                    title="#{msg.icon_search}"
                                    value="#{msg.icon_search}"
                                    action="#{mbPatient.searchPatient}"
                                    icon="ui-icon-search"
                                    ajax="false"
                                    update=":form:tabView:dtEntities, :form:tabView:dtStudySubjects, :form:tabView:dtDicomStudies, :growl"
                                    disabled="#{!userContext.hasRole('ROLE_PID_SEARCH')}"
                                    />
                                <p:commandButton
                                    value="#{msg.menu_reset}"
                                    title="#{msg.menu_reset}"
                                    type="reset"
                                    icon="ui-icon-close"
                                    />
                            </f:facet>
                        </p:panelGrid>
                    </p:tab>
                </p:accordionPanel>

                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Left -->
                    <p:toolbarGroup align="left">

                        <p:commandButton
                                value="#{msg.menu_new}"
                                title="#{msg.person_patient_new}"
                                icon="ui-icon-document"
                                oncomplete="PF('newEntityDialog').show();"
                                style="float: left;"
                                immediate="true"
                                update=":newEntityForm:newDisplay"
                                process="@this"
                                actionListener="#{mbPatient.prepareNewEntity}"
                                disabled="#{!userContext.hasRole('ROLE_PID_NEW')}"
                                />

                        <p:commandButton
                                value="#{msg.menu_reload}"
                                title="#{msg.person_patient_reload}"
                                icon="ui-icon-refresh"
                                style="float: left;"
                                immediate="true"
                                process="@this"
                                update=":form:tabView:dtEntities, :growl"
                                actionListener="#{mbPatient.loadAllPids}"
                                disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                                />

                        <p:commandButton
                                value="#{msg.menu_reidentify}"
                                icon="ui-icon-unlocked"
                                style="float: left;"
                                immediate="true"
                                process="@this"
                                update=":form:tabView:dtEntities, :growl"
                                actionListener="#{mbPatient.depseudonymiseAllPids(true)}"
                                disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                                />
                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                            value="#{msg.menu_help}"
                            title="#{msg.menu_help}"
                            icon="ui-icon-help"
                            onclick="target='_blank'"
                            ajax="false"
                            immediate="true"
                            action="#{mbMain.navigateToHelp('x1-250004')}"
                            />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- PIDs -->
                <p:dataTable
                    id="dtEntities"
                    var="person"
                    value="#{mbPatient.entityList}"
                    widgetVar="pidsTable"
                    resizableColumns="true"
                    draggableColumns="false"
                    paginator="true"
                    rows="15"
                    rowsPerPageTemplate="15,25,50"
                    emptyMessage="#{msg.search_empty}"
                    selection="#{mbPatient.selectedEntity}"
                    selectionMode="single"
                    rowKey="#{person.pid}"
                    rowIndexVar="rowIndex"
                    filteredValue="#{mbPatient.filteredEntities}"
                    sortMode="multiple"
                    sortBy="#{mbPatient.preSortOrder}"
                    disabledTextSelection="false"
                    >

                    <!--AJAX onclick on datatable row -->
                    <p:ajax event="rowSelect" listener="#{mbPatient.loadPatientDetails}" update=":form:tabView:dtStudySubjects, :form:tabView:dtDicomStudies, :growl" />

                    <!-- Data table header -->
                    <f:facet name="header">
                        <h:outputText value="[#{mbMain.myAccount.partnerSite.identifier}] = #{mbMain.myAccount.partnerSite.name}" title="#{mbMain.myAccount.partnerSite.description}" style="float:left" />
                        <p:commandButton id="btnEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler
                                datasource="dtEntities"
                                trigger=":form:tabView:dtEntities:btnEntitiesToggler"
                                style="width:450px"
                                >
                            <p:ajax event="toggle" listener="#{mbPatient.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" toggleable="false" exportable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- PID -->
                    <p:column
                        headerText="#{msg.person_pid}"
                        sortBy="#{person.pid}"
                        style="width:7%"
                        visible="#{mbPatient.columnVisibilityList[0]}"
                        >
                        <h:outputText value="#{person.pid}" style="float: left; font-family:consolas, courier new,monospace;" />
                    </p:column>

                    <!-- Lastname -->
                    <p:column
                        id="colLastName"
                        sortBy="#{person.surname}"
                        filterBy="#{person.surname}"
                        filterMatchMode="contains"
                        style="width:15%"
                        visible="#{mbPatient.columnVisibilityList[1]}"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.person_surname}" />
                        </f:facet>
                        <h:outputText value="#{person.surname}"  style="float: left;" />
                    </p:column>

                    <!-- Firstname -->
                    <p:column
                        id="colFirstName"
                        sortBy="#{person.firstname}"
                        filterBy="#{person.firstname}"
                        filterMatchMode="contains"
                        style="width:15%"
                        visible="#{mbPatient.columnVisibilityList[2]}"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.person_firstname}" />
                        </f:facet>
                        <h:outputText value="#{person.firstname}"  style="float: left;" />
                    </p:column>

                    <!-- Birthdate -->
                    <p:column
                        id="colDateOfBirth"
                        sortBy="#{person.birthdate}"
                        filterBy="#{person.birthdateString}"
                        filterMatchMode="contains"
                        visible="#{mbPatient.columnVisibilityList[3]}"
                        style="width:15%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.person_birthdate}" />
                        </f:facet>
                        <h:outputText value="#{person.birthdateString}" />
                    </p:column>

                    <!-- Birth name -->
                    <p:column
                        id="colBirthName"
                        sortBy="#{person.birthname}"
                        filterBy="#{person.birthname}"
                        filterMatchMode="contains"
                        style="width:15%"
                        visible="#{mbPatient.columnVisibilityList[4]}"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.person_birthname}" />
                        </f:facet>
                        <h:outputText value="#{person.birthname}" style="float: left;" />
                    </p:column>

                    <!-- Place of residence -->
                    <p:column
                        sortBy="#{person.city}"
                        filterBy="#{person.city}"
                        filterMatchMode="contains"
                        visible="#{mbPatient.columnVisibilityList[5]}"
                        style="width:15%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.person_city}" />
                        </f:facet>
                        <h:outputText value="#{person.city}" style="float: left;" />
                    </p:column>

                    <!-- ZIP of residence -->
                    <p:column
                        sortBy="#{person.zipcode}"
                        filterBy="#{person.zipcode}"
                        filterMatchMode="contains"
                        visible="#{mbPatient.columnVisibilityList[6]}"
                        style="width:5%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.person_zip}" />
                        </f:facet>
                        <h:outputText value="#{person.zipcode}" style="float: left;" />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                        headerText="#{msg.menu_commands}"
                        exportable="false"
                        style="width:8%"
                        toggleable="false"
                        >
                        <p:commandButton
                                icon="ui-icon-contact"
                                title="#{msg.menu_edit}"
                                update=":entityDetailsForm:editDisplay"
                                immediate="true"
                                process="@this"
                                oncomplete="PF('editEntityDialog').show();"
                                >
                                <f:setPropertyActionListener
                                    value="#{person}"
                                    target="#{mbPatient.selectedEntity}"
                                    />
                        </p:commandButton>
                    </p:column>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbPatient.entityList.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbPatient.entityList.size() == 1}" />
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbPatient.entityList.size() > 1}"
                                >
                            <f:param value="#{mbPatient.entityList.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Block table -->
                <p:blockUI block="dtEntities" trigger="dtEntities">
                    #{msg.loading}<br /><p:graphicImage name="icons/ajaxloading.gif" />
                </p:blockUI>
                
                <!-- Export -->
                <p:panel header="#{msg.menu_export}" rendered="#{userContext.hasRole('ROLE_ADMIN')}"
                         style="width: auto">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtEntities" fileName="#{msg.person_patient_plural}" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtEntities" fileName="#{msg.person_patient_plural}" />
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- Patient participating in Studies -->
            <p:tab title="#{msg.study_plural}">

                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Left -->
                    <p:toolbarGroup align="left">

                        <p:commandButton
                                value="#{msg.menu_reload}"
                                title="#{msg.studySubject_reload}"
                                icon="ui-icon-refresh"
                                style="float: left;"
                                immediate="true"
                                process="@this"
                                update=":form:tabView:dtStudySubjects, :growl"
                                actionListener="#{mbPatient.loadPatientStudySubjects}"
                                />
                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                            value="#{msg.menu_print}"
                            title="#{msg.studySubject_print}"
                            icon="ui-icon-print"
                            >
                            <p:printer target="dtStudySubjects" />
                        </p:commandButton>
                        <p:commandButton
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                onclick="target='_blank'"
                                ajax="false"
                                immediate="true"
                                action="#{mbMain.navigateToHelp('x1-250004')}"
                                />
                    </p:toolbarGroup>

                </p:toolbar>

                <!-- Patient StudySubjects -->
                <p:dataTable
                    id="dtStudySubjects"
                    var="studySubject"
                    value="#{mbPatient.selectedEntity.studySubjects}"
                    widgetVar="studySubjectsTable"
                    resizableColumns="true"
                    draggableColumns="false"
                    paginator="true"
                    rows="15"
                    rowsPerPageTemplate="15,25,50"
                    emptyMessage="#{msg.search_empty}"
                    selection="#{mbStudySubject.selectedEntity}"
                    selectionMode="single"
                    rowKey="#{studySubject.protocolStudySubjectId}"
                    rowIndexVar="rowIndex"
                    filteredValue="#{mbStudySubject.filteredEntities}"
                    sortMode="multiple"
                    sortBy="#{mbStudySubject.preSortOrder}"
                    disabledTextSelection="false"
                    >
                    <!-- Data table header -->
                    <f:facet name="header">
                        <h:outputText value="#{mbMain.myAccount.partnerSite.identifier}-#{mbPatient.selectedEntity.pid}" style="float:left" />
                        <p:commandButton id="btnStudySubjectToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler
                                datasource="dtStudySubjects"
                                trigger=":form:tabView:dtStudySubjects:btnStudySubjectToggler"
                                style="width:450px"
                                >
                            <p:ajax event="toggle" listener="#{mbStudySubject.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" toggleable="false" exportable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- StudySubject ID -->
                    <p:column
                        id="colStudySubjectId"
                        headerText="#{msg.studySubject_studySubjectId}"
                        sortBy="#{studySubject.studySubjectId}"
                        filterBy="#{studySubject.studySubjectId}"
                        filterMatchMode="contains"
                        visible="#{mbStudySubject.columnVisibilityList[0]}"
                        style="width:20%"
                        >
                        <h:outputText value="#{studySubject.studySubjectId}" style="float: left;" />
                    </p:column>

                    <!-- Secondary ID -->
                    <p:column
                        headerText="#{msg.studySubject_secondaryId}"
                        sortBy="#{studySubject.secondaryId}"
                        filterBy="#{studySubject.secondaryId}"
                        filterMatchMode="contains"
                        visible="#{mbStudySubject.columnVisibilityList[1]}"
                        style="width:10%"
                        >
                        <h:outputText value="#{studySubject.secondaryId}" style="float: left;" />
                    </p:column>

                    <!-- Gender -->
                    <p:column
                        headerText="#{msg.studySubject_gender}"
                        sortBy="#{studySubject.sex}"
                        visible="#{mbStudySubject.columnVisibilityList[2]}"
                        style="width:10%"
                        >
                        <h:outputText value="#{studySubject.sex}" />
                    </p:column>

                    <!-- EnrollmentDate-->
                    <p:column
                        headerText="#{msg.studySubject_enrollmentDate}"
                        sortBy="#{studySubject.dateEnrollment}"
                        filterBy="#{studySubject.dateEnrollmentString}"
                        filterMatchMode="contains"
                        visible="#{mbStudySubject.columnVisibilityList[3]}"
                        style="width:12%"
                        >
                        <h:outputText value="#{studySubject.dateEnrollmentString}" />
                    </p:column>

                    <!-- Parent study name -->
                    <p:column
                        headerText="#{msg.study}"
                        sortBy="#{studySubject.study.getOcStudyName()}"
                        filterBy="#{studySubject.study.getOcStudyName()}"
                        filterMatchMode="contains"
                        visible="#{mbStudySubject.columnVisibilityList[4]}"
                        style="width:25%"
                        >
                        <h:outputText value="#{studySubject.study.getOcStudyName()}" title="#{studySubject.study.getOcStudyUniqueIdentifier()}" style="float: left;" />
                    </p:column>

                    <!-- Site name -->
                    <p:column
                        headerText="#{msg.account_partnerSite}"
                        sortBy="#{studySubject.study.getOcSiteName()}"
                        filterBy="#{studySubject.study.getOcSiteName()}"
                        filterMatchMode="contains"
                        visible="#{mbStudySubject.columnVisibilityList[5]}"
                        style="width:15%"
                        >
                        <h:outputText value="#{studySubject.study.getOcSiteName()}" title="#{studySubject.study.getOcSiteIdentifier()}" style="float: left;" />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                        headerText="#{msg.menu_commands}"
                        exportable="false"
                        toggleable="false"
                        style="width:10%"
                        >
                        <!-- Redirect -->
                        <p:commandButton
                            title="#{msg.studySubject} Lookup"
                            icon="ui-icon-arrowthick-1-e"
                            immediate="true"
                            process="@this"
                            actionListener="#{mbPatient.redirectToEdc(studySubject)}"
                            update=":growl"
                            />
                    </p:column>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbPatient.selectedEntity.studySubjects.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbPatient.selectedEntity.studySubjects.size() == 1}" />
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbPatient.selectedEntity.studySubjects.size() > 1}"
                                >
                            <f:param value="#{mbPatient.selectedEntity.studySubjects.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

            </p:tab>

            <!-- Patient has DICOM data in research PACS -->
            <p:tab title="DICOM">
                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Left -->
                    <p:toolbarGroup align="left">
                        <p:commandButton
                            value="#{msg.menu_reload}"
                            title="#{msg.dicomStudy_reload}"
                            icon="ui-icon-refresh"
                            style="float: left;"
                            immediate="true"
                            process="@this"
                            update=":form:tabView:dtDicomStudies, :growl"
                            actionListener="#{mbPatient.loadPatientDicomStudies}"
                            />
                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                            value="#{msg.menu_print}"
                            title="#{msg.dicomStudy_print}"
                            icon="ui-icon-print"
                            >
                            <p:printer target="dtDicomStudies" />
                        </p:commandButton>
                        <p:commandButton
                            value="#{msg.menu_help}"
                            title="#{msg.menu_help}"
                            icon="ui-icon-help"
                            onclick="target='_blank'"
                            ajax="false"
                            immediate="true"
                            action="#{mbMain.navigateToHelp('x1-250004')}"
                            />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Patient DicomStudies -->
                <p:dataTable
                    id="dtDicomStudies"
                    var="dicomStudy"
                    value="#{mbPatient.selectedEntity.dicomStudies}"
                    widgetVar="dicomStudiesTable"
                    resizableColumns="true"
                    draggableColumns="false"
                    paginator="true"
                    rows="15"
                    rowsPerPageTemplate="15,25,50,100"
                    emptyMessage="#{msg.search_empty}"
                    selection="#{mbDicomStudy.selectedEntity}"
                    selectionMode="single"
                    rowKey="#{dicomStudy.studyInstanceUID}"
                    rowIndexVar="rowIndex"
                    filteredValue="#{mbDicomStudy.filteredEntities}"
                    sortMode="multiple"
                    sortBy="#{mbDicomStudy.preSortOrder}"
                    disabledTextSelection="false"
                    >

                    <!-- Data table header -->
                    <f:facet name="header">
                        <h:outputText value="#{mbMain.myAccount.partnerSite.identifier}-#{mbPatient.selectedEntity.pid}" style="float:left" />
                        <p:commandButton id="btnDicomStudyToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler
                                datasource="dtDicomStudies"
                                trigger=":form:tabView:dtDicomStudies:btnDicomStudyToggler"
                                style="width:450px"
                                >
                            <p:ajax event="toggle" listener="#{mbStudySubject.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row expansion -->
                    <p:column toggleable="false" exportable="false" filterable="false" style="width:10px">
                        <p:rowToggler />
                    </p:column>

                    <!-- Row -->
                    <p:column headerText="#" toggleable="false" exportable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- StudyInstance UID -->
                    <p:column
                        id="colDicomStudyUid"
                        headerText="#{msg.dicomStudy_studyInstanceUID}"
                        sortBy="#{dicomStudy.studyInstanceUID}"
                        filterBy="#{dicomStudy.studyInstanceUID}"
                        filterMatchMode="contains"
                        visible="#{mbDicomStudy.columnVisibilityList[0]}"
                        style="width:20%"
                        >
                        <h:outputText value="#{dicomStudy.studyInstanceUID}" style="float: left;" />
                    </p:column>

                    <!-- DICOM study description-->
                    <p:column
                        headerText="#{msg.dicomStudy_studyDescription}"
                        sortBy="#{dicomStudy.studyDescription}"
                        filterBy="#{dicomStudy.studyDescription}"
                        filterMatchMode="contains"
                        visible="#{mbDicomStudy.columnVisibilityList[1]}"
                        style="width:40%"
                        >
                        <h:outputText value="#{dicomStudy.studyDescription}" style="float: left;" />
                    </p:column>

                    <!-- DICOM study type deduced from series modalities -->
                    <p:column
                        headerText="#{msg.dicomStudy_modalities}"
                        sortBy="#{dicomStudy.studyType}"
                        filterBy="#{dicomStudy.studyType}"
                        filterMatchMode="contains"
                        visible="#{mbDicomStudy.columnVisibilityList[2]}"
                        style="width:10%"
                        >
                        <h:outputText value="#{dicomStudy.studyType}" style="float: left;"  />
                    </p:column>

                    <!-- Date -->
                    <p:column
                        headerText="#{msg.dicomStudy_studyDate}"
                        sortBy="#{dicomStudy.dateStudy}"
                        filterBy="#{dicomStudy.dateStudyString}"
                        filterMatchMode="contains"
                        visible="#{mbDicomStudy.columnVisibilityList[3]}"
                        style="width:10%"
                        >
                        <h:outputText value="#{dicomStudy.dateStudyString}" />
                    </p:column>

                    <!-- DicomSeries -->
                    <p:rowExpansion>

                        <p:dataTable
                            id="dtDicomSeries"
                            var="dicomSeries"
                            value="#{dicomStudy.studySeries}"
                            widgetVar="dicomSeriesTable"
                            resizableColumns="true"
                            draggableColumns="false"
                            paginator="true"
                            rows="15"
                            rowsPerPageTemplate="15,25,50,100"
                            emptyMessage="#{msg.search_empty}"
                            selection="#{mbDicomSerie.selectedEntity}"
                            selectionMode="single"
                            rowKey="#{dicomSeries.seriesInstanceUID}"
                            rowIndexVar="subRowIndex"
                            filteredValue="#{mbDicomSerie.filteredEntities}"
                            sortMode="multiple"
                            sortBy="#{mbDicomSerie.preSortOrder}"
                            disabledTextSelection="false"
                            >

                            <!-- Table header -->
                            <f:facet name="header">
                                <p:commandButton id="btnDicomSeriesEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                                <p:columnToggler
                                    datasource="dtDicomSeries"
                                    trigger=":form:tabView:dtDicomStudies:dtDicomSeries:btnDicomSeriesEntitiesToggler"
                                    style="width:450px"
                                    >
                                    <p:ajax event="toggle" listener="#{mbDicomSerie.onEntityToggle}" />
                                </p:columnToggler>
                            </f:facet>

                            <!-- Row -->
                            <p:column headerText="#" toggleable="false" exportable="false" style="width:5%">
                                <h:outputText value="#{subRowIndex + 1}" />
                            </p:column>

                            <!-- SeriesInstance UID -->
                            <p:column
                                id="colDicomSerieUid"
                                headerText="#{msg.dicomSeries_seriesInstanceUID}"
                                sortBy="#{dicomSeries.seriesInstanceUID}"
                                filterBy="#{dicomSeries.seriesInstanceUID}"
                                filterMatchMode="contains"
                                visible="#{mbDicomSerie.columnVisibilityList[0]}"
                                style="width:10%"
                                >
                                <h:outputText value="#{dicomSeries.seriesInstanceUID}" style="float: left;" />
                            </p:column>

                            <!-- Description -->
                            <p:column
                                headerText="#{msg.dicomSeries_seriesDescription}"
                                sortBy="#{dicomSeries.seriesDescription}"
                                filterBy="#{dicomSeries.seriesDescription}"
                                filterMatchMode="contains"
                                visible="#{mbDicomSerie.columnVisibilityList[1]}"
                                style="width:40%"
                                >
                                <h:outputText value="#{dicomSeries.seriesDescription}" style="float: left;" />
                            </p:column>

                            <!-- Modality -->
                            <p:column
                                headerText="#{msg.dicomSeries_modality}"
                                sortBy="#{dicomSeries.seriesModality}"
                                filterBy="#{dicomSeries.seriesModality}"
                                filterMatchMode="contains"
                                visible="#{mbDicomSerie.columnVisibilityList[2]}"
                                style="width:10%"
                                >
                                <h:outputText value="#{dicomSeries.seriesModality}" style="float: left;" />
                            </p:column>

                            <!-- Time -->
                            <p:column
                                headerText="#{msg.dicomSeries_seriesTime}"
                                sortBy="#{dicomSeries.timeSeries}"
                                filterBy="#{dicomSeries.timeSeriesString}"
                                filterMatchMode="contains"
                                visible="#{mbDicomSerie.columnVisibilityList[3]}"
                                style="width:7%"
                                >
                                <h:outputText value="#{dicomSeries.timeSeriesString}" />
                            </p:column>

                            <!-- Footer -->
                            <f:facet name="footer">
                                <h:outputText value="#{msg.search_results_status_0}" rendered="#{dicomStudy.studySeries.size() == 0}" />
                                <h:outputText value="#{msg.search_results_status_1}" rendered="#{dicomStudy.studySeries.size() == 1}" />
                                <h:outputFormat
                                    value="#{msg.search_results_status_n}"
                                    rendered="#{dicomStudy.studySeries.size() > 1}"
                                    >
                                    <f:param value="#{dicomStudy.studySeries.size()}" />
                                </h:outputFormat>
                            </f:facet>
                        </p:dataTable>
                    </p:rowExpansion>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbPatient.selectedEntity.dicomStudies.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbPatient.selectedEntity.dicomStudies.size() == 1}" />
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbPatient.selectedEntity.dicomStudies.size() > 1}"
                                >
                            <f:param value="#{mbPatient.selectedEntity.dicomStudies.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

            </p:tab>

            <!-- Patient has biospecimens data in Biobank -->
            <!-- Postponed until vendor neutral interfaces are available for biobank -->
<!--            <p:tab title="#{msg.specimen_plural}">-->

<!--                &lt;!&ndash; Toolbar &ndash;&gt;-->
<!--                <p:toolbar>-->
<!--                    &lt;!&ndash; Left &ndash;&gt;-->
<!--                    <p:toolbarGroup align="left">-->
<!--                        <p:commandButton-->
<!--                                value="#{msg.menu_reload}"-->
<!--                                title="#{msg.specimen_reload}"-->
<!--                                icon="ui-icon-refresh"-->
<!--                                style="float: left;"-->
<!--                                immediate="true"-->
<!--                                process="@this"-->
<!--                                update=":form:tabView:dtSpecimenEntities, :growl"-->
<!--                                actionListener="#{mbPatient.loadPatientSpecimens}"-->
<!--                        />-->
<!--                    </p:toolbarGroup>-->

<!--                    &lt;!&ndash; Right &ndash;&gt;-->
<!--                    <p:toolbarGroup align="right">-->
<!--                        <p:commandButton-->
<!--                            value="#{msg.menu_print}"-->
<!--                            title="#{msg.specimen_print}"-->
<!--                            icon="ui-icon-print"-->
<!--                            >-->
<!--                            <p:printer target="dtSpecimenEntities" />-->
<!--                        </p:commandButton>-->
<!--                        <p:commandButton-->
<!--                            value="#{msg.menu_help}"-->
<!--                            title="#{msg.menu_help}"-->
<!--                            icon="ui-icon-help"-->
<!--                            onclick="target='_blank'"-->
<!--                            ajax="false"-->
<!--                            immediate="true"-->
<!--                            action="#{mbMain.navigateToHelp('x1-240003')}"-->
<!--                            />-->
<!--                    </p:toolbarGroup>-->
<!--                </p:toolbar>-->

<!--                &lt;!&ndash; Tree Table&ndash;&gt;-->
<!--                <p:treeTable-->
<!--                    id="dtSpecimenEntities"-->
<!--                    var="bioSpecimen"-->
<!--                    value="#{mbPatient.specimenRoot}"-->
<!--                    widgetVar="specimenEntitiesTable"-->
<!--                    resizableColumns="true"-->
<!--                    draggableColumns="false"-->
<!--                    emptyMessage="#{msg.search_empty}"-->
<!--                    selection="#{mbBioLookup.selectedEntity}"-->
<!--                    sortBy="#{bioSpecimen.sampleId}"-->
<!--                    >-->

<!--                    &lt;!&ndash; Data table header &ndash;&gt;-->
<!--                    <f:facet name="header">-->
<!--                        <h:outputText value="#{mbMain.myAccount.partnerSite.identifier}-#{mbPatient.selectedEntity.pid}" style="float:left" />-->
<!--                    </f:facet>-->

<!--                    &lt;!&ndash; SampleID &ndash;&gt;-->
<!--                    <p:column-->
<!--                        id="colSampleId"-->
<!--                        headerText="#{msg.specimen_sampleId}"-->
<!--                        sortBy="#{bioSpecimen.sampleId}"-->
<!--                        style="width:10%"-->
<!--                        >-->
<!--                        <h:outputText value="#{bioSpecimen.sampleId}" style="float: left;" />-->
<!--                    </p:column>-->

<!--                    &lt;!&ndash; Type &ndash;&gt;-->
<!--                    <p:column-->
<!--                        headerText="#{msg.specimen_type}"-->
<!--                        sortBy="#{bioSpecimen.type}"-->
<!--                        style="width:7%"-->
<!--                        >-->
<!--                        <h:outputText value="#{bioSpecimen.type}" style="float: left;" />-->
<!--                    </p:column>-->

<!--                    &lt;!&ndash; Kind &ndash;&gt;-->
<!--                    <p:column-->
<!--                        headerText="#{msg.specimen_kind}"-->
<!--                        sortBy="#{bioSpecimen.kind}"-->
<!--                        style="width:10%"-->
<!--                        >-->
<!--                        <h:outputText value="#{bioSpecimen.kind}" style="float: left;" />-->
<!--                    </p:column>-->

<!--                    &lt;!&ndash; AmountRest&ndash;&gt;-->
<!--                    <p:column-->
<!--                        headerText="Rest"-->
<!--                        sortBy="#{bioSpecimen.amountRest}"-->
<!--                        style="width:10%"-->
<!--                        >-->
<!--                        <h:outputText value="#{bioSpecimen.amountRest}" style="float: right;" />-->
<!--                    </p:column>-->

<!--                    &lt;!&ndash; Unit &ndash;&gt;-->
<!--                    <p:column-->
<!--                        headerText="Unit"-->
<!--                        sortBy="#{bioSpecimen.amountRestUnit}"-->
<!--                        style="width:10%"-->
<!--                        >-->
<!--                        <h:outputText value="#{bioSpecimen.amountRestUnit}" style="float: left;" />-->
<!--                    </p:column>-->

<!--                    &lt;!&ndash; SamplingDate &ndash;&gt;-->
<!--                    <p:column-->
<!--                        headerText="Sampling"-->
<!--                        sortBy="#{bioSpecimen.samplingDate}"-->
<!--                        style="width:10%"-->
<!--                        >-->
<!--                        <h:outputText value="#{bioSpecimen.samplingDate}" style="float: left;" />-->
<!--                    </p:column>-->

<!--                    &lt;!&ndash; Commands &ndash;&gt;-->
<!--                    <p:column-->
<!--                        headerText="#{msg.menu_commands}"-->
<!--                        exportable="false"-->
<!--                        toggleable="false"-->
<!--                        style="width:11%"-->
<!--                        >-->
<!--                        &lt;!&ndash; Edit &ndash;&gt;-->
<!--                        &lt;!&ndash;<p:commandButton&ndash;&gt;-->
<!--                            &lt;!&ndash;title="#{msg.menu_edit}"&ndash;&gt;-->
<!--                            &lt;!&ndash;icon="ui-icon-contact"&ndash;&gt;-->
<!--                            &lt;!&ndash;immediate="true"&ndash;&gt;-->
<!--                            &lt;!&ndash;process="@this"&ndash;&gt;-->
<!--                            &lt;!&ndash;update=":entityDetailsForm:editDisplay"&ndash;&gt;-->
<!--                            &lt;!&ndash;oncomplete="PF('editEntityDialog').show();"&ndash;&gt;-->
<!--                            &lt;!&ndash;&gt;&ndash;&gt;-->
<!--                            &lt;!&ndash;<f:setPropertyActionListener&ndash;&gt;-->
<!--                                &lt;!&ndash;value="#{bioSpecimen}"&ndash;&gt;-->
<!--                                &lt;!&ndash;target="#{mbBioLookup.selectedEntity}"&ndash;&gt;-->
<!--                                &lt;!&ndash;/>&ndash;&gt;-->
<!--                        &lt;!&ndash;</p:commandButton>&ndash;&gt;-->
<!--                    </p:column>-->

<!--                    &lt;!&ndash; Footer &ndash;&gt;-->
<!--                    <f:facet name="footer">-->
<!--                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbBioLookup.entityList.size() == 0}" />-->
<!--                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbBioLookup.entityList.size() == 1}" />-->
<!--                        <h:outputFormat value="#{msg.search_results_status_n}" rendered="#{mbBioLookup.entityList.size() > 1}">-->
<!--                            <f:param value="#{mbPatient.selectedEntity.bioSpecimens.size()}" />-->
<!--                        </h:outputFormat>-->
<!--                    </f:facet>-->
<!--                </p:treeTable>-->
<!--            </p:tab>-->
        </p:tabView>
    </ui:define>

    <!-- Definition of dialogs placeholder -->
    <ui:define name="dialogs">

        <!-- New -->
        <p:dialog
            id="dlgNewEntity"
            header="#{msg.person_patient_new}"
            widgetVar="newEntityDialog"
            resizable="false"
            ajax="true"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >

            <!-- Form -->
            <h:form id="newEntityForm">
                <p:panelGrid
                    id="newDisplay"
                    columns="2"
                    cellpadding="4"
                    style="margin:0 auto;"
                    >

                    <!-- Partner Site -->
                    <h:outputLabel value="#{msg.partnerSite} #{msg.partnerSite_identifier}:" for="txtPartnerSiteIdentifierNew" />
                    <h:outputText id="txtPartnerSiteIdentifierNew" value="[#{mbMain.myAccount.partnerSite.identifier}] = #{mbMain.myAccount.partnerSite.name}" title="#{mbMain.myAccount.partnerSite.description}" />

                    <!-- PID -->
                    <h:outputLabel value="#{msg.person_pid}:" for="txtPatientPidNew" />
                    <h:outputText id="txtPatientPidNew" value="#{mbPatient.newEntity.pid}" style="font-family:consolas, courier new,monospace;" />

                    <!-- Firstname -->
                    <h:outputLabel value="#{msg.person_firstname}: #{msg.label_required_suffix}" for="txtPatientFirstNameNew" />
                    <p:inputText
                            id="txtPatientFirstNameNew"
                            value="#{mbPatient.newEntity.firstname}"
                            required="true"
                            requiredMessage="#{msg.person_firstname} is mandatory!"
                            />

                    <!-- Lastname -->
                    <h:outputLabel value="#{msg.person_surname}: #{msg.label_required_suffix}" for="txtPatientLastNameNew" />
                    <p:inputText
                            id="txtPatientLastNameNew"
                            value="#{mbPatient.newEntity.surname}"
                            required="true"
                            requiredMessage="#{msg.person_surname} is mandatory!"
                            />

                    <!-- Birthdate -->
                    <h:outputLabel value="#{msg.person_birthdate}: #{msg.label_required_suffix}" for="calPatientBirthdateNew" />
                    <p:calendar
                            id="calPatientBirthdateNew"
                            pattern="dd.MM.yyyy"
                            navigator="true"
                            showOn="button"
                            value="#{mbPatient.newEntity.birthdate}"
                            required="true"
                            requiredMessage="#{msg.person_birthdate} is mandatory!"
                            />

                    <!-- Birthname -->
                    <h:outputLabel value="#{msg.person_birthname}:" for="txtPatientBirthNameNew" />
                    <p:inputText
                            id="txtPatientBirthNameNew"
                            value="#{mbPatient.newEntity.birthname}"
                            title="#{msg.person_birthname} is recommended to ensure the uniqueness of PID"
                            />

                    <!-- Place of residence -->
                    <h:outputLabel value="#{msg.person_city}:" for="txtPatientResidenceNew" />
                    <p:inputText
                            id="txtPatientResidenceNew"
                            value="#{mbPatient.newEntity.city}"
                            title="#{msg.person_city} is recommended to ensure the uniqueness of PID"
                            />

                    <!-- ZIP of residence -->
                    <h:outputLabel value="#{msg.person_zip}:" for="txtPatientResidenceZipNew" />
                    <p:inputText
                            id="txtPatientResidenceZipNew"
                            value="#{mbPatient.newEntity.zipcode}"
                            title="#{msg.person_zip} is recommended to ensure the uniqueness of PID"
                            />

                    <!-- Force Sureness about the new patient data => force new PID if possible patient match -->
                    <h:outputText value="I am sure that patient data is correct and I want to create a new PID number:" rendered="#{!mbPatient.isSure}" />
                    <p:selectBooleanCheckbox rendered="#{!mbPatient.isSure}" value="#{mbPatient.newEntity.isSure}" />

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_generate} PID"
                                update=":form:tabView:dtEntities, :newEntityForm, :growl"
                                icon="ui-icon-disk"
                                actionListener="#{mbPatient.doCreateEntity}"
                                process="@this newEntityForm"
                                />
                        <p:commandButton value="#{msg.menu_reset}" type="reset" icon="ui-icon-close" />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Edit -->
        <p:dialog
              id="dlgEntityDetails"
              header="#{msg.person_patient_edit}"
              widgetVar="editEntityDialog"
              resizable="false"
              appendToBody="true"
              modal="true"
              closeOnEscape="true"
              >

            <!-- Form -->
            <h:form id="entityDetailsForm">
                <p:panelGrid
                        id="editDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Partner Site -->
                    <h:outputLabel value="#{msg.partnerSite} #{msg.partnerSite_identifier}:" for="txtPartnerSiteIdentifierEdit" />
                    <h:outputText id="txtPartnerSiteIdentifierEdit" value="[#{mbMain.myAccount.partnerSite.identifier}] = #{mbMain.myAccount.partnerSite.name}" title="#{mbMain.myAccount.partnerSite.description}" />

                    <!-- PID -->
                    <h:outputLabel value="#{msg.person_pid}:" for="txtPatientPidEdit" />
                    <h:outputText id="txtPatientPidEdit" value="#{mbPatient.selectedEntity.pid}" style="font-family:consolas, courier new,monospace;" />

                    <!-- Firstname -->
                    <h:outputLabel value="#{msg.person_firstname}: #{msg.label_required_suffix}" for="txtPatientFirstNameEdit" />
                    <p:inputText
                            id="txtPatientFirstNameEdit"
                            value="#{mbPatient.selectedEntity.firstname}"
                            requiredMessage="#{msg.person_firstname} is mandatory!"
                            required="true"
                            />

                    <!-- Lastname -->
                    <h:outputLabel value="#{msg.person_surname}: #{msg.label_required_suffix}" for="txtPatientLastNameEdit" />
                    <p:inputText
                            id="txtPatientLastNameEdit"
                            value="#{mbPatient.selectedEntity.surname}"
                            requiredMessage="#{msg.person_surname} is mandatory!"
                            required="true"
                            />

                    <!-- Birthdate -->
                    <h:outputLabel value="#{msg.person_birthdate}: #{msg.label_required_suffix}" for="calPatientBirthdateEdit" />
                    <p:calendar
                            id="calPatientBirthdateEdit"
                            pattern="dd.MM.yyyy"
                            value="#{mbPatient.selectedEntity.birthdate}"
                            requiredMessage="D#{msg.person_birthdate} is mandatory!"
                            required="true"
                            />

                    <!-- Birstname -->
                    <h:outputLabel value="#{msg.person_birthname}:" for="txtPatientBirthNameEdit" />
                    <p:inputText
                            id="txtPatientBirthNameEdit"
                            value="#{mbPatient.selectedEntity.birthname}"
                            title="#{msg.person_birthname} is recommended to ensure the uniqueness of PID"
                            />

                    <!-- Place of residence -->
                    <h:outputLabel value="#{msg.person_city}:" for="txtPatientResidenceEdit" />
                    <p:inputText
                            id="txtPatientResidenceEdit"
                            value="#{mbPatient.selectedEntity.city}"
                            title="#{mbPatient.selectedEntity.city} is recommended to ensure the uniqueness of PID"
                            />

                    <!-- ZIP of residence -->
                    <h:outputLabel value="#{msg.person_zip}:" for="txtPatientResidenceZipEdit" />
                    <p:inputText
                            id="txtPatientResidenceZipEdit"
                            value="#{mbPatient.selectedEntity.zipcode}"
                            title="#{msg.person_zip} is recommended to ensure the uniqueness of PID"
                            />

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                icon="ui-icon-disk"
                                update=":form:tabView:dtEntities, :entityDetailsForm, :growl"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgEntityDetails','entityDetailsForm');"
                                actionListener="#{mbPatient.doUpdateEntity}"
                                process="@this entityDetailsForm"
                                disabled="#{!userContext.hasRole('ROLE_PID_EDIT')}"
                                />
                        <p:commandButton
                                value="#{msg.menu_reidentify}"
                                icon="ui-icon-unlocked"
                                update=":form:tabView:dtEntities, :entityDetailsForm, :growl"
                                immediate="true"
                                process="@this"
                                actionListener="#{mbPatient.depseudonymiseSelectedPid(mbPatient.selectedEntity.pid)}"
                                disabled="#{!userContext.hasRole('ROLE_REIDENTIFY')}"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Submit from dialog -->
        <script type="text/javascript">
            function handleSubmitRequest(xhr, status, args, dialogName, formName) {
                dialog = jQuery('#'+dialogName);
                if(args.validationFailed) {
                    dialog.effect("shake", { times:3 }, 100);
                }
                else {
                    clearForm(formName);
                    PF('newEntityDialog').hide();
                    PF('editEntityDialog').hide();
                }
            }
            function clearForm(formName) {
                jQuery('#'+formName).each(function() {
                    this.reset();
                });
            }
        </script>
    </ui:define>
</ui:composition>