<?xml version="1.0" encoding="UTF-8" ?>

<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:p="http://primefaces.org/ui"
    xmlns:o="http://omnifaces.org/ui"
    template="/WEB-INF/layouts/main.xhtml"
    >

    <!-- Definition of breadcrumbs place holder -->
    <ui:define name="breadcrumbs">
        <p:breadCrumb>
            <p:menuitem value="#{msg.home}" title="#{msg.home}" url="/home.faces" />
            <p:menuitem value="CTMS" title="Clinical Trial Management System" url="#" />
            <p:menuitem value="#{msg.study_plural}" title="#{msg.study_plural}" url="/ctms/studies.faces" />
        </p:breadCrumb>
    </ui:define>

    <!-- Definition of page content place holder -->
    <ui:define name="content">

        <!-- Enums -->
        <o:importConstants type="de.dktk.dd.rpb.core.domain.ctms.EnumProtocolType" />

        <!-- TabView -->
        <p:tabView id="tabView" activeIndex="#{mbCtmsStudy.tab.activeIndex}" scrollable="true">

            <!-- Studies -->
            <p:tab title="#{msg.study_plural}">

                <!-- Search Form - StudyTags-->
                <p:accordionPanel id="pnlSearch" multiple="true" activeIndex="-1">
                    <p:tab title="#{msg.search_criteria}">
                        <p:panelGrid
                            id="panelGrid"
                            columns="2"
                            cellpadding="4"
                            style="margin:0 auto;"
                            >

                            <!-- Toolbar Commands -->
                            <h:outputLabel value="#{msg.menu_commands}:" />
                            <p:toolbar id="toolbar">
                                <!-- Left -->
                                <p:toolbarGroup align="left" id="toolbarGroup">

                                    <!-- New -->
                                    <p:commandButton
                                        id="btnNewSearchCrit"
                                        title="#{msg.menu_new}"
                                        icon="ui-icon-document"
                                        immediate="true"
                                        process="@this"
                                        update=":form:tabView:pnlSearch:btnNewSearchCrit, :form:tabView:pnlSearch:btnSaveSearchCrit, :form:tabView:pnlSearch:btnCancelSearchCrit, :form:tabView:pnlSearch:ddlNewStudyTagTypeCrit"
                                        actionListener="#{mbCtmsStudy.prepareNewStudyTag}"
                                        disabled="#{mbCtmsStudy.newTag != null}"
                                        />

                                    <!-- Commit-->
                                    <p:commandButton
                                        id="btnSaveSearchCrit"
                                        title="Add"
                                        icon="ui-icon-disk"
                                        process="@this panelGrid"
                                        update=":form:tabView:pnlSearch:dtStudyTagsCrit, :form:tabView:pnlSearch:ddlNewStudyTagTypeCrit, :form:tabView:pnlSearch:btnNewSearchCrit, :form:tabView:pnlSearch:btnSaveSearchCrit, :form:tabView:pnlSearch:btnCancelSearchCrit, :form:tabView:pnlSearch:btnSearchStudy, :growl"
                                        actionListener="#{mbCtmsStudy.saveNewTagTypeCriteria}"
                                        disabled="#{mbCtmsStudy.newTag == null}"
                                        />

                                    <!-- Cancel -->
                                    <p:commandButton
                                        id="btnCancelSearchCrit"
                                        title="#{msg.menu_reset}"
                                        icon="ui-icon-close"
                                        immediate="true"
                                        process="@this"
                                        update=":form:tabView:pnlSearch:dtStudyTagsCrit, :form:tabView:pnlSearch:ddlNewStudyTagTypeCrit, :form:tabView:pnlSearch:btnCancelSearchCrit, :form:tabView:pnlSearch:btnNewSearchCrit, :form:tabView:pnlSearch:btnSaveSearchCrit, :growl"
                                        actionListener="#{mbCtmsStudy.cancelNewStudyTag}"
                                        disabled="#{mbCtmsStudy.newTag == null}"
                                        />
                                </p:toolbarGroup>
                            </p:toolbar>

                            <!-- New tag criterium type-->
                            <h:outputLabel value="Tag type:" />
                            <p:selectOneMenu
                                id="ddlNewStudyTagTypeCrit"
                                value="#{mbCtmsStudy.newTag.type}"
                                converter="#{studyTagTypeConverter}"
                                style="width:350px"
                                disabled="#{mbCtmsStudy.newTag == null}"
                                filter="true"
                                filterMatchMode="contains"
                                var="searchStudyTagTypeNewIter"
                                >
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" noSelectionOption="true" />
                                <f:selectItems
                                    value="#{mbStudyTagType.entityList}"
                                    var="critStudyTagType"
                                    itemLabel="#{critStudyTagType.name}"
                                    itemValue="#{critStudyTagType}"
                                    itemDescription="#{critStudyTagType.description}"
                                    />
                                <p:column>
                                    <h:outputText value="#{searchStudyTagTypeNewIter.name}" />
                                </p:column>
                            </p:selectOneMenu>

                            <!-- StudyTags -->
                            <h:outputLabel value="Tags:" for="dtStudyTagsCrit" />
                            <p:dataTable
                                id="dtStudyTagsCrit"
                                var="cirtTag"
                                value="#{mbCtmsStudy.tagSearchCriteria}"
                                paginator="true"
                                rows="10"
                                editable="true"
                                editMode="cell"
                                widgetVar="critCellTags"
                                style="width:400px"
                                >
                                <p:ajax event="cellEdit" listener="#{mbCtmsStudy.onCellEdit}" update=":growl" />

                                <p:column sortBy="#{cirtTag.type.name}">
                                    <f:facet name="header">
                                        <h:outputText value="Type" />
                                    </f:facet>
                                    <p:cellEditor>
                                        <f:facet name="output">
                                            <h:outputText value="#{cirtTag.type.name}" title="#{cirtTag.type.description}" style="float:left;" />
                                        </f:facet>
                                        <f:facet name="input">
                                            <h:outputText value="#{cirtTag.type.name}" title="#{cirtTag.type.description}" style="float:left;" />
                                        </f:facet>
                                    </p:cellEditor>
                                </p:column>

                                <p:column headerText="Value">
                                    <p:cellEditor>
                                        <f:facet name="output">
                                            <h:outputText
                                                value="#{cirtTag.value}"
                                                rendered="#{cirtTag.type.isBoolean == false}"
                                                />
                                            <h:selectOneMenu value="#{cirtTag.value}" rendered="#{cirtTag.type.isBoolean}" style="width:100px" disabled="true">
                                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                                <f:selectItems
                                                        value="#{mbCtmsStudy.tagBooleanList}"
                                                        var="bool"
                                                        itemLabel="#{bool}"
                                                        itemValue="#{bool}"
                                                        />
                                            </h:selectOneMenu>
                                        </f:facet>
                                        <f:facet name="input">
                                            <p:inputText
                                                value="#{cirtTag.value}"
                                                required="#{cirtTag.type.isRequired}"
                                                rendered="#{cirtTag.type.isBoolean == false}"
                                                />
                                            <h:selectOneMenu value="#{cirtTag.value}" rendered="#{cirtTag.type.isBoolean}" style="width:100px">
                                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                                <f:selectItems
                                                    value="#{mbCtmsStudy.tagBooleanList}"
                                                    var="bool"
                                                    itemLabel="#{bool}"
                                                    itemValue="#{bool}"
                                                    />
                                            </h:selectOneMenu>
                                        </f:facet>
                                    </p:cellEditor>
                                </p:column>
                            </p:dataTable>

                            <!-- Footer -->
                            <f:facet name="footer">
                                <p:commandButton
                                    id="btnSearchStudy"
                                    title="#{msg.icon_search}"
                                    value="#{msg.icon_search}"
                                    action="#{mbCtmsStudy.searchStudy}"
                                    icon="ui-icon-search"
                                    update=":form:tabView:dtEntities, :growl"
                                    process="@this"
                                    disabled="#{mbCtmsStudy.tagSearchCriteria == null or mbCtmsStudy.tagSearchCriteria.size() == 0}"
                                    />
                                </f:facet>
                        </p:panelGrid>
                    </p:tab>
                </p:accordionPanel>

                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Left -->
                    <p:toolbarGroup align="left">
                        <p:commandButton
                                value="#{msg.menu_new}"
                                title="#{msg.study_new}"
                                icon="ui-icon-document"
                                oncomplete="PF('newEntityDialog').show();"
                                style="float: left;"
                                immediate="true"
                                update=":newEntityForm:newDisplay"
                                process="@this"
                                actionListener="#{mbCtmsStudy.prepareNewEntity(mbStudyTagType.requiredStudyTagTypes)}"
                                />
                        <p:commandButton
                                value="#{msg.menu_reload}"
                                title="#{msg.study_reload}"
                                icon="ui-icon-refresh"
                                style="float: left;"
                                immediate="true"
                                process="@this"
                                update=":form:tabView:dtEntities, :growl"
                                actionListener="#{mbCtmsStudy.load}"
                                />
                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                                value="#{msg.menu_print}"
                                title="#{msg.study_print}"
                                icon="ui-icon-print"
                                >
                            <p:printer target="dtEntities" />
                        </p:commandButton>
                        <p:commandButton
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                disabled="True"
                                />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Data table -->
                <p:dataTable
                    id="dtEntities"
                    var="entity"
                    value="#{mbCtmsStudy.entityList}"
                    widgetVar="entitiesTable"
                    resizableColumns="true"
                    draggableColumns="false"
                    paginator="true"
                    rows="15"
                    rowsPerPageTemplate="15,25,50,100"
                    emptyMessage="#{msg.search_empty}"
                    rowKey="#{entity.id}"
                    selection="#{mbCtmsStudy.selectedEntity}"
                    selectionMode="single"
                    rowIndexVar="rowIndex"
                    filteredValue="#{mbCtmsStudy.filteredEntities}"
                    sortMode="multiple"
                    sortBy="#{mbCtmsStudy.preSortOrder}"
                    disabledTextSelection="false"
                    >

                    <!--AJAX onclick on datatable row -->
                    <p:ajax event="rowSelect" update=":form:tabView:dtTumourEntities, :form:tabView:dtTimelineEntities, :form:tabView:tlStudyTimeLineEvents, :form:tabView:dtPersonnelEntities, :form:tabView:dtOrganisationsEntities, :form:tabView:pnlStudyTreatmentArmConfig, :form:tabView:dtArms, :form:tabView:dtCriteria, :form:tabView:dtTrialSites, :form:tabView:displayRandomisation, :form:tabView:dtStudyDocs" />

                    <!-- Table header -->
                    <f:facet name="header">
                        <p:commandButton id="btnEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler datasource="dtEntities" trigger=":form:tabView:dtEntities:btnEntitiesToggler">
                            <p:ajax event="toggle" listener="#{mbCtmsStudy.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- Procotol ID -->
                    <p:column
                        sortBy="#{entity.protocolId}"
                        filterBy="#{entity.protocolId}"
                        filterMatchMode="contains"
                        style="width:10%"
                        visible="#{mbCtmsStudy.columnVisibilityList[0]}"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.study_protocolId}" />
                        </f:facet>
                        <h:outputText value="#{entity.protocolId}" style="float:left;" />
                    </p:column>

                    <!-- Short Label -->
                    <p:column
                        id="colStudyName"
                        sortBy="#{entity.name}"
                        filterBy="#{entity.name}"
                        filterMatchMode="contains"
                        style="width:20%"
                        visible="#{mbCtmsStudy.columnVisibilityList[1]}"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.study_name}" />
                        </f:facet>
                        <h:outputText value="#{entity.name}" style="float:left;" />
                    </p:column>

                    <!-- Title -->
                    <p:column
                        sortBy="#{entity.title}"
                        filterBy="#{entity.title}"
                        filterMatchMode="contains"
                        style="width:20%"
                        visible="#{mbCtmsStudy.columnVisibilityList[2]}"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.study_title}" />
                        </f:facet>
                        <h:outputText value="#{entity.title}" style="float:left;" />
                    </p:column>

                    <!-- Tumour Entities -->
                    <p:column
                            style="width:20%"
                            visible="#{mbCtmsStudy.columnVisibilityList[3]}"
                            filterMatchMode="contains"
                            filterBy="#{entity.tumourEntitiesString()}"
                            >
                        <f:facet name="header">
                            <h:outputText value="#{msg.study_tumourEntities}" />
                        </f:facet>
                        <h:outputText value="#{entity.tumourEntitiesString()}" style="float:left;" />
                    </p:column>

                    <!-- Phase -->
                    <p:column
                        sortBy="#{entity.phase.name}"
                        filterBy="#{entity.phase.name}"
                        filterMatchMode="in"
                        style="width:10%"
                        visible="#{mbCtmsStudy.columnVisibilityList[4]}"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.study_phase}" />
                        </f:facet>
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                    label="#{msg.studyPhase_plural}"
                                    onchange="PF('entitiesTable').filter()"
                                    panelStyle="width:160px"
                                    scrollHeight="150"
                                    >
                                <f:selectItems
                                        value="#{mbStudyPhase.entityList}"
                                        var="studyPhase"
                                        itemLabel="#{studyPhase.name}"
                                        itemValue="#{studyPhase.name}"
                                        itemDescription="#{studyPhase.description}"
                                        />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{entity.phase.name}" title="#{entity.phase.description}" style="float:left;" />
                    </p:column>

                    <!-- SponsoringType -->
                    <p:column
                        sortBy="#{entity.sponsoringType.name}"
                        filterBy="#{entity.sponsoringType.name}"
                        filterMatchMode="in"
                        style="width:10%"
                        visible="#{mbCtmsStudy.columnVisibilityList[5]}"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.study_sponsoringType}" />
                        </f:facet>
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                    label="#{msg.sponsoringType_plural}"
                                    onchange="PF('entitiesTable').filter()"
                                    panelStyle="width:120px"
                                    scrollHeight="80"
                                    >
                                <f:selectItems
                                        value="#{mbSponsoringType.entityList}"
                                        var="sponsoringType"
                                        itemLabel="#{sponsoringType.name}"
                                        itemValue="#{sponsoringType.name}"
                                        itemDescription="#{sponsoringType.description}"
                                        />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{entity.sponsoringType.name}" title="#{entity.sponsoringType.description}" style="float:left;" />
                    </p:column>

                    <!-- Status -->
                    <p:column
                        sortBy="#{entity.status.name}"
                        filterBy="#{entity.status.name}"
                        filterMatchMode="in"
                        visible="#{mbCtmsStudy.columnVisibilityList[6]}"
                        style="width:10%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.study_status}" />
                        </f:facet>
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                    label="#{msg.studyStatus_plural}"
                                    onchange="PF('entitiesTable').filter()"
                                    panelStyle="width:220px"
                                    scrollHeight="150"
                                    >
                                <f:selectItems
                                        value="#{mbStudyStatus.entityList}"
                                        var="studyStatus"
                                        itemLabel="#{studyStatus.name}"
                                        itemValue="#{studyStatus.name}"
                                        itemDescription="#{studyStatus.description}"
                                        />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{entity.status.name}" title="#{entity.status.description}" style="float:left;" />
                    </p:column>

                    <!-- ProtocolType -->
                    <p:column
                        sortBy="#{entity.enumProtocolType.toString()}"
                        filterBy="#{entity.enumProtocolType.toString()}"
                        filterMatchMode="in"
                        style="width:10%"
                        visible="#{mbCtmsStudy.columnVisibilityList[7]}"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.study_protocolType}" />
                        </f:facet>
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                    label="#{msg.enumProtocolType_plural}"
                                    onchange="PF('entitiesTable').filter()"
                                    panelStyle="width:150px"
                                    >
                                <f:selectItems
                                    value="#{EnumProtocolType}"
                                    var="protocolTypeEnum"
                                    itemValue="#{protocolTypeEnum}"
                                    itemLabel="#{protocolTypeEnum.label}"
                                    />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{entity.enumProtocolType.label}" style="float:left;" />
                    </p:column>

                    <!-- Timing -->
                    <p:column
                        sortBy="#{entity.timing.name}"
                        filterBy="#{entity.timing.name}"
                        filterMatchMode="in"
                        visible="#{mbCtmsStudy.columnVisibilityList[8]}"
                        style="width:10%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.study_timing}" />
                        </f:facet>
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                label="#{msg.timePerspective_plural}"
                                onchange="PF('entitiesTable').filter()"
                                panelStyle="width:120px"
                                scrollHeight="80"
                                >
                                <f:selectItems
                                    value="#{mbTimePerspective.entityList}"
                                    var="timing"
                                    itemLabel="#{timing.name}"
                                    itemValue="#{timing.name}"
                                    itemDescription="#{timing.description}"
                                    />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{entity.timing.name}" title="#{entity.timing.description}" style="float:left;" />
                    </p:column>

                    <!-- All study tags -->
                    <p:columns
                        value="#{mbStudyTagType.entityList}"
                        var="studyTagType"
                        style="width:10%"
                        columnIndexVar="colIndex"
                        visible="#{mbCtmsStudy.columnVisibilityList[9 + colIndex]}"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{studyTagType.name}" title="#{studyTagType.description}" />
                        </f:facet>
                        <h:selectBooleanCheckbox
                            value="#{entity.getBooleanTagValue(studyTagType.name)}"
                            rendered="#{entity.isTagBoolean(studyTagType.name)}"
                            disabled="true"
                            />
                        <h:outputText
                            value="#{entity.getTagValue(studyTagType.name)}"
                            rendered="#{!entity.isTagBoolean(studyTagType.name)}"
                            style="float:left;"
                            />
                    </p:columns>

                    <!-- Commands -->
                    <p:column
                        headerText="#{msg.menu_commands}"
                        exportable="false"
                        style="width:10%"
                        toggleable="false"
                        >
                        <p:commandButton
                            icon="ui-icon-contact"
                            title="#{msg.menu_edit}"
                            update=":entityDetailsForm"
                            immediate="true"
                            process="@this"
                            oncomplete="PF('editEntityDialog').show();"
                            >
                            <f:setPropertyActionListener
                                value="#{entity}"
                                target="#{mbCtmsStudy.selectedEntity}"
                                />
                        </p:commandButton>

                        <p:commandButton
                            title="#{msg.menu_delete}"
                            icon="ui-icon-trash"
                            update=":deleteEntityForm"
                            immediate="true"
                            process="@this"
                            oncomplete="PF('deleteEntityDialog').show();"
                            rendered="#{userContext.hasRole('ROLE_ADMIN')}"
                            >
                            <f:setPropertyActionListener
                                value="#{entity}"
                                target="#{mbCtmsStudy.selectedEntity}"
                                />
                        </p:commandButton>
                    </p:column>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbCtmsStudy.entityList.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbCtmsStudy.entityList.size() == 1}" />
                        <h:outputFormat
                            value="#{msg.search_results_status_n}"
                            rendered="#{mbCtmsStudy.entityList.size() > 1}"
                            >
                            <f:param value="#{mbCtmsStudy.entityList.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Block table -->
                <p:blockUI block="dtEntities" trigger="dtEntities">
                    LOADING<br /><p:graphicImage name="icons/ajaxloading.gif" />
                </p:blockUI>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtEntities" fileName="#{msg.study_plural}" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtEntities" fileName="#{msg.study_plural}" />
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- Tumour Entities -->
            <p:tab title="#{msg.study_tumourEntities}">

                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Left -->
                    <p:toolbarGroup align="left">
                        <p:commandButton
                                value="#{msg.menu_new}"
                                title="Assign a new Tumour Entity"
                                icon="ui-icon-document"
                                oncomplete="PF('newTumourEntityDialog').show();"
                                style="float: left;"
                                immediate="true"
                                update=":newTumourEntityForm:newTumourEntityDisplay"
                                process="@this"
                                actionListener="#{mbCtmsStudy.prepareNewTumourEntities}"
                                />
                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                                value="#{msg.menu_print}"
                                title="#{msg.tumourEntity_print}"
                                icon="ui-icon-print"
                                >
                            <p:printer target="dtTumourEntities" />
                        </p:commandButton>
                        <p:commandButton
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                disabled="True"
                                />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Data table -->
                <p:dataTable
                        id="dtTumourEntities"
                        var="tumourEntity"
                        value="#{mbCtmsStudy.selectedEntity.tumourEntities}"
                        widgetVar="tumourEntitiesTable"
                        resizableColumns="true"
                        draggableColumns="false"
                        paginator="true"
                        rows="15"
                        rowsPerPageTemplate="15,25,50"
                        emptyMessage="#{msg.search_empty}"
                        rowKey="#{tumourEntity.id}"
                        selection="#{mbTumourEntity.selectedEntity}"
                        selectionMode="single"
                        rowIndexVar="rowIndex"
                        filteredValue="#{mbTumourEntity.filteredEntities}"
                        sortMode="multiple"
                        sortBy="#{mbTumourEntity.preSortOrder}"
                        disabledTextSelection="false"
                        >

                    <!-- Table header -->
                    <f:facet name="header">
                        <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" style="float:left" />
                        <p:commandButton id="btnTumourEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler
                                datasource="dtTumourEntities"
                                trigger=":form:tabView:dtTumourEntities:btnTumourEntitiesToggler"
                                style="width:450px"
                                >
                            <p:ajax event="toggle" listener="#{mbTumourEntity.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- Name -->
                    <p:column
                            id="colTumourEntityName"
                            sortBy="#{tumourEntity.name}"
                            filterBy="#{tumourEntity.name}"
                            filterMatchMode="contains"
                            style="width:20%"
                            visible="#{mbTumourEntity.columnVisibilityList[0]}"
                            >
                        <f:facet name="header">
                            <h:outputText value="#{msg.tumourEntity_name}" />
                        </f:facet>
                        <h:outputText value="#{tumourEntity.name}" style="float:left;" />
                    </p:column>

                    <!-- Description -->
                    <p:column
                            sortBy="#{tumourEntity.description}"
                            filterBy="#{tumourEntity.description}"
                            filterMatchMode="contains"
                            style="width:30%"
                            visible="#{mbTumourEntity.columnVisibilityList[1]}"
                            >
                        <f:facet name="header">
                            <h:outputText value="#{msg.tumourEntity_description}" />
                        </f:facet>
                        <h:outputText value="#{tumourEntity.description}" />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                            headerText="#{msg.menu_commands}"
                            exportable="false"
                            style="width:17%"
                            toggleable="false"
                            >
                        <p:commandButton
                                title="#{msg.menu_delete}"
                                icon="ui-icon-trash"
                                update=":deleteTumourEntityForm:deleteTumourEntityDisplay"
                                immediate="true"
                                process="@this"
                                oncomplete="PF('deleteTumourEntityDialog').show();"
                                >
                            <f:setPropertyActionListener
                                    value="#{tumourEntity}"
                                    target="#{mbTumourEntity.selectedEntity}"
                                    />
                        </p:commandButton>
                    </p:column>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbCtmsStudy.selectedEntity.tumourEntities.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbCtmsStudy.selectedEntity.tumourEntities.size() == 1}" />
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbCtmsStudy.selectedEntity.tumourEntities.size() > 1}"
                                >
                            <f:param value="#{mbCtmsStudy.selectedEntity.tumourEntities.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtTumourEntities" fileName="#{msg.tumourEntity_plural}" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtTumourEntities" fileName="#{msg.tumourEntity_plural}" />
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- Eligibility Criteria -->
            <!--<p:tab title="#{msg.study_eligibilityCriteria}">-->

            <!--</p:tab>-->

            <!-- TimeLineEvents -->
            <p:tab title="#{msg.study_timeLineEvents}">

                <!-- TimeLine-->
                <p:timeline
                    id="tlStudyTimeLineEvents"
                    value="#{mbCtmsStudy.timeLineEventsModel}"
                    var="timeLineEvent"
                    selectable="true"
                    zoomable="true"
                    moveable="true"
                    stackEvents="true"
                    eventStyle="box"
                    axisOnTop="false"
                    showCurrentTime="true"
                    showNavigation="false"
                    widgetVar="timelineWidget"
                    height="300px"
                    >
                    <h:panelGrid columns="1">
                        <h:outputText value="#{timeLineEvent.name}"/>
                        <h:outputText value="#{msg.timeLineEvent_type}: #{timeLineEvent.type.name}" />
                        <h:outputText vissible="#{timeLineEvent.organisation != null}" value="#{msg.timeLineEvent_organisation}: #{timeLineEvent.organisation.name}" />
                    </h:panelGrid>
                </p:timeline>

                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Left -->
                    <p:toolbarGroup align="left">
                        <p:commandButton
                            value="#{msg.menu_new}"
                            title="#{msg.timeLineEvent_new}"
                            icon="ui-icon-document"
                            oncomplete="PF('newTimeLineEventDialog').show();"
                            style="float: left;"
                            immediate="true"
                            update=":newTimeLineEventForm:newTimelineEventDisplay"
                            process="@this"
                            actionListener="#{mbTimeLineEvent.prepareNewEntity}"
                            />
                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                            value="#{msg.menu_print}"
                            title="#{msg.timeLineEvent_print}"
                            icon="ui-icon-print"
                            >
                            <p:printer target="dtTimelineEntities" />
                        </p:commandButton>
                        <p:commandButton
                            value="#{msg.menu_help}"
                            title="#{msg.menu_help}"
                            icon="ui-icon-help"
                            disabled="True"
                            />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Data table -->
                <p:dataTable
                    id="dtTimelineEntities"
                    var="timeLineEvent"
                    value="#{mbCtmsStudy.selectedEntity.timeLineEvents}"
                    widgetVar="timeLineEntitiesTable"
                    resizableColumns="true"
                    draggableColumns="false"
                    paginator="true"
                    rows="15"
                    rowsPerPageTemplate="15,25,50"
                    emptyMessage="#{msg.search_empty}"
                    rowKey="#{timeLineEvent.id}"
                    selection="#{mbTimeLineEvent.selectedEntity}"
                    selectionMode="single"
                    rowIndexVar="rowIndex"
                    filteredValue="#{mbTimeLineEvent.filteredEntities}"
                    sortMode="multiple"
                    sortBy="#{mbTimeLineEvent.preSortOrder}"
                    disabledTextSelection="false"
                    >

                    <!-- Table header -->
                    <f:facet name="header">
                        <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" style="float:left" />
                        <p:commandButton id="btnTimeLineEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler
                            datasource="dtTimelineEntities"
                            trigger=":form:tabView:dtTimelineEntities:btnTimeLineEntitiesToggler"
                            style="width:450px"
                            >
                            <p:ajax event="toggle" listener="#{mbTimeLineEvent.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- Name -->
                    <p:column
                        id="colEventName"
                        sortBy="#{timeLineEvent.name}"
                        filterBy="#{timeLineEvent.name}"
                        filterMatchMode="contains"
                        visible="#{mbTimeLineEvent.columnVisibilityList[0]}"
                        style="width:20%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.timeLineEvent_name}" />
                        </f:facet>
                        <h:outputText value="#{timeLineEvent.name}" style="float:left;" />
                    </p:column>

                    <!-- Description -->
                    <p:column
                        sortBy="#{timeLineEvent.description}"
                        filterBy="#{timeLineEvent.description}"
                        filterMatchMode="contains"
                        visible="#{mbTimeLineEvent.columnVisibilityList[1]}"
                        style="width:30%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.timeLineEvent_description}" />
                        </f:facet>
                        <h:outputText value="#{timeLineEvent.description}" style="float:left;" />
                    </p:column>

                    <!-- Type -->
                    <p:column
                        sortBy="#{timeLineEvent.type.name}"
                        filterBy="#{timeLineEvent.type.name}"
                        filterMatchMode="in"
                        visible="#{mbTimeLineEvent.columnVisibilityList[2]}"
                        style="width:20%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.timeLineEvent_type}" />
                        </f:facet>
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                label="#{msg.eventType_plural}"
                                onchange="PF('timeLineEntitiesTable').filter()"
                                panelStyle="width:140px"
                                scrollHeight="80"
                                >
                                <f:selectItems
                                        value="#{mbEventType.entityList}"
                                        var="eventType"
                                        itemLabel="#{eventType.name}"
                                        itemValue="#{eventType.name}"
                                        itemDescription="#{eventType.description}"
                                        />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{timeLineEvent.type.name}" title="#{timeLineEvent.type.description}" style="float:left;" />
                    </p:column>

                    <!-- Importance -->

                    <!-- StartDate -->
                    <p:column
                            id="colEventStart"
                            sortBy="#{timeLineEvent.startDate}"
                            filterBy="#{timeLineEvent.startDateString}"
                            filterMatchMode="contains"
                            visible="#{mbTimeLineEvent.columnVisibilityList[3]}"
                            style="width:10%"
                            >
                        <f:facet name="header">
                            <h:outputText value="#{msg.timeLineEvent_startDate}" />
                        </f:facet>
                        <h:outputText value="#{timeLineEvent.startDateString}" style="float:left;" />
                    </p:column>

                    <!-- EndDate -->
                    <p:column
                        id="colEventEnd"
                        sortBy="#{timeLineEvent.endDate}"
                        filterBy="#{timeLineEvent.endDateString}"
                        filterMatchMode="contains"
                        visible="#{mbTimeLineEvent.columnVisibilityList[4]}"
                        style="width:10%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.timeLineEvent_endDate}" />
                        </f:facet>
                        <h:outputText value="#{timeLineEvent.endDateString}" style="float:left;" />
                    </p:column>

                    <!-- Organisation -->
                    <p:column
                        sortBy="#{timeLineEvent.organisation.name}"
                        filterBy="#{timeLineEvent.organisation.name}"
                        filterMatchMode="contains"
                        style="width:20%"
                        visible="#{mbTimeLineEvent.columnVisibilityList[5]}"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.timeLineEvent_organisation}" />
                        </f:facet>
                        <h:outputText value="#{timeLineEvent.organisation.name}" style="float:left;" />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                        headerText="#{msg.menu_commands}"
                        exportable="false"
                        toggleable="false"
                        style="width:17%"
                        >
                        <!-- Edit -->
                        <p:commandButton
                            title="#{msg.menu_edit}"
                            icon="ui-icon-contact"
                            update=":editTimeLineEventForm:editTimelineEventDisplay"
                            immediate="true"
                            process="@this"
                            oncomplete="PF('editTimeLineEventDialog').show();"
                            >
                            <f:setPropertyActionListener
                                value="#{timeLineEvent}"
                                target="#{mbTimeLineEvent.selectedEntity}"
                                />
                        </p:commandButton>

                        <!-- Delete -->
                        <p:commandButton
                            title="#{msg.menu_delete}"
                            icon="ui-icon-trash"
                            update=":deleteTimeLineEventForm:deleteTimelineEventDisplay"
                            immediate="true"
                            process="@this"
                            oncomplete="PF('deleteTimeLineEventDialog').show();"
                            >
                            <f:setPropertyActionListener
                                value="#{timeLineEvent}"
                                target="#{mbTimeLineEvent.selectedEntity}"
                                />
                        </p:commandButton>
                    </p:column>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbCtmsStudy.selectedEntity.timeLineEvents.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbCtmsStudy.selectedEntity.timeLineEvents.size() == 1}" />
                        <h:outputFormat
                            value="#{msg.search_results_status_n}"
                            rendered="#{mbCtmsStudy.selectedEntity.timeLineEvents.size() > 1}"
                            >
                            <f:param value="#{mbCtmsStudy.selectedEntity.timeLineEvents.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtTimelineEntities" fileName="#{msg.study_timeLineEvents}" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtTimelineEntities" fileName="#{msg.study_timeLineEvents}" />
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- StudyPersonnel -->
            <p:tab title="#{msg.study_personnel}">

                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Left -->
                    <p:toolbarGroup align="left">
                        <p:commandButton
                            value="#{msg.menu_new}"
                            title="Assign new person into a study"
                            icon="ui-icon-document"
                            oncomplete="PF('newStudyPersonDialog').show();"
                            style="float: left;"
                            immediate="true"
                            update=":newStudyPersonForm:newStudyPersonDisplay"
                            process="@this"
                            actionListener="#{mbStudyPerson.prepareNewEntity}"
                            />
                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                            value="#{msg.menu_print}"
                            title="#{msg.studyPerson_print}"
                            icon="ui-icon-print"
                            >
                            <p:printer target="dtPersonnelEntities" />
                        </p:commandButton>
                        <p:commandButton
                            value="#{msg.menu_help}"
                            title="#{msg.menu_help}"
                            icon="ui-icon-help"
                            disabled="True"
                            />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Data table -->
                <p:dataTable
                    id="dtPersonnelEntities"
                    var="studyPerson"
                    value="#{mbCtmsStudy.selectedEntity.studyPersonnel}"
                    widgetVar="personnelEntitiesTable"
                    resizableColumns="true"
                    draggableColumns="false"
                    paginator="true"
                    rows="15"
                    rowsPerPageTemplate="15,25,50"
                    emptyMessage="#{msg.search_empty}"
                    rowKey="#{studyPerson.id}"
                    selection="#{mbStudyPerson.selectedEntity}"
                    selectionMode="single"
                    rowIndexVar="rowIndex"
                    filteredValue="#{mbStudyPerson.filteredEntities}"
                    sortMode="multiple"
                    sortBy="#{mbStudyPerson.preSortOrder}"
                    disabledTextSelection="false"
                    >

                    <!-- Table header -->
                    <f:facet name="header">
                        <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" style="float:left" />
                        <p:commandButton id="btnStudyPersonEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler datasource="dtPersonnelEntities" trigger=":form:tabView:dtPersonnelEntities:btnStudyPersonEntitiesToggler">
                            <p:ajax event="toggle" listener="#{mbStudyPerson.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- Person surname -->
                    <p:column
                        id="colPersonSurname"
                        headerText="#{msg.person_surname}"
                        sortBy="#{studyPerson.person.surname}"
                        filterBy="#{studyPerson.person.surname}"
                        filterMatchMode="contains"
                        visible="#{mbStudyPerson.columnVisibilityList[0]}"
                        style="width:20%"
                        >
                        <h:outputText value="#{studyPerson.person.surname}" style="float:left;" />
                    </p:column>

                    <!-- Person firstname -->
                    <p:column
                        id="colPersonFirstname"
                        headerText="#{msg.person_firstname}"
                        sortBy="#{studyPerson.person.firstname}"
                        filterBy="#{studyPerson.person.firstname}"
                        filterMatchMode="contains"
                        visible="#{mbStudyPerson.columnVisibilityList[1]}"
                        style="width:15%"
                        >
                        <h:outputText value="#{studyPerson.person.firstname}" style="float:left;" />
                    </p:column>

                    <!-- Position (Role) -->
                    <p:column
                        id="colPersonRole"
                        headerText="#{msg.studyPerson_role}"
                        sortBy="#{studyPerson.role.name}"
                        filterBy="#{studyPerson.role.name}"
                        filterMatchMode="in"
                        visible="#{mbStudyPerson.columnVisibilityList[2]}"
                        style="width:25%"
                        >
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                label="#{msg.studyPersonRole_plural}"
                                onchange="PF('personnelEntitiesTable').filter()"
                                panelStyle="width:230px"
                                scrollHeight="200"
                                >
                                <f:selectItems
                                    value="#{mbStudyPersonRole.entityList}"
                                    var="studyPersonRole"
                                    itemLabel="#{studyPersonRole.name}"
                                    itemValue="#{studyPersonRole.name}"
                                    itemDescription="#{studyPersonRole.description}"
                                    />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{studyPerson.role.name}" title="#{studyPerson.role.description}" style="float:left;" />
                    </p:column>

                    <!-- Can obtain informed consent -->
                    <p:column
                        headerText="#{msg.studyPerson_canObtaionInformedConsent}"
                        filterBy="#{studyPerson.canObtainInformedConsent}"
                        filterMatchMode="equals"
                        visible="#{mbStudyPerson.columnVisibilityList[3]}"
                        style="width:15%"
                        >
                        <f:facet name="filter">
                            <p:selectOneButton onchange="PF('personnelEntitiesTable').filter()">
                                <f:converter converterId="javax.faces.Boolean" />
                                <f:selectItem itemLabel="#{msg.yes}" itemValue="true" />
                                <f:selectItem itemLabel="#{msg.no}" itemValue="false" />
                            </p:selectOneButton>
                        </f:facet>
                        <p:selectBooleanButton
                            value="#{studyPerson.canObtainInformedConsent}"
                            onLabel="#{msg.yes}"
                            offLabel="#{msg.no}"
                            onIcon="ui-icon-check"
                            offIcon="ui-icon-close"
                            disabled="true"
                            />
                    </p:column>

                    <!-- StartDate -->
                    <p:column
                        headerText="#{msg.studyPerson_startDate}"
                        sortBy="#{studyPerson.startDate}"
                        filterBy="#{studyPerson.startDateString}"
                        filterMatchMode="contains"
                        visible="#{mbStudyPerson.columnVisibilityList[4]}"
                        style="width:15%"
                        >
                        <h:outputText value="#{studyPerson.startDateString}" style="float:left;" />
                    </p:column>

                    <!-- EndDate -->
                    <p:column
                        headerText="#{msg.studyPerson_endDate}"
                        sortBy="#{studyPerson.endDate}"
                        filterBy="#{studyPerson.endDateString}"
                        filterMatchMode="contains"
                        visible="#{mbStudyPerson.columnVisibilityList[5]}"
                        style="width:15%"
                        >
                        <h:outputText value="#{studyPerson.endDateString}" style="float:left;" />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                        headerText="#{msg.menu_commands}"
                        exportable="false"
                        toggleable="false"
                        style="width:17%"
                        >

                        <!-- Edit -->
                        <p:commandButton
                            title="#{msg.menu_edit}"
                            icon="ui-icon-contact"
                            update=":editStudyPersonForm:editStudyPersonDisplay"
                            immediate="true"
                            process="@this"
                            oncomplete="PF('editStudyPersonDialog').show();"
                            >
                            <f:setPropertyActionListener
                                value="#{studyPerson}"
                                target="#{mbStudyPerson.selectedEntity}"
                                />
                        </p:commandButton>

                        <!-- Delete -->
                        <p:commandButton
                            title="#{msg.menu_delete}"
                            icon="ui-icon-trash"
                            update=":deleteStudyPersonForm:deleteStudyPersonDisplay"
                            immediate="true"
                            process="@this"
                            oncomplete="PF('deleteStudyPersonDialog').show();"
                            >
                            <f:setPropertyActionListener
                                value="#{studyPerson}"
                                target="#{mbStudyPerson.selectedEntity}"
                                />
                        </p:commandButton>
                    </p:column>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbCtmsStudy.selectedEntity.studyPersonnel.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbCtmsStudy.selectedEntity.studyPersonnel.size() == 1}" />
                        <h:outputFormat
                            value="#{msg.search_results_status_n}"
                            rendered="#{mbCtmsStudy.selectedEntity.studyPersonnel.size() > 1}"
                            >
                            <f:param value="#{mbCtmsStudy.selectedEntity.studyPersonnel.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                 <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtPersonnelEntities" fileName="#{msg.study_personnel}" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtPersonnelEntities" fileName="#{msg.study_personnel}" />
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- StudyOrganisations -->
            <p:tab title="#{msg.study_organisations}">

                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Left -->
                    <p:toolbarGroup align="left">
                        <p:commandButton
                            value="#{msg.menu_new}"
                            title="Assign new organisation into a study"
                            icon="ui-icon-document"
                            oncomplete="PF('newStudyOrganisationDialog').show();"
                            style="float: left;"
                            immediate="true"
                            update=":newStudyOrganisationForm:newStudyOrganisationDisplay"
                            process="@this"
                            actionListener="#{mbStudyOrganisation.prepareNewEntity}"
                            />
                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                            value="#{msg.menu_print}"
                            title="#{msg.studyOrganisation_print}"
                            icon="ui-icon-print"
                            >
                            <p:printer target="dtOrganisationsEntities" />
                        </p:commandButton>
                        <p:commandButton
                            value="#{msg.menu_help}"
                            title="#{msg.menu_help}"
                            icon="ui-icon-help"
                            disabled="True"
                            />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Data table -->
                <p:dataTable
                    id="dtOrganisationsEntities"
                    var="studyOrganisation"
                    value="#{mbCtmsStudy.selectedEntity.studyOrganisations}"
                    widgetVar="organisationEntitiesTable"
                    resizableColumns="true"
                    draggableColumns="false"
                    paginator="true"
                    rows="15"
                    rowsPerPageTemplate="15,25,50"
                    emptyMessage="#{msg.search_empty}"
                    rowKey="#{studyOrganisation.id}"
                    selection="#{mbStudyOrganisation.selectedEntity}"
                    selectionMode="single"
                    rowIndexVar="rowIndex"
                    filteredValue="#{mbStudyOrganisation.filteredEntities}"
                    sortMode="multiple"
                    sortBy="#{mbStudyOrganisation.preSortOrder}"
                    disabledTextSelection="false"
                    >

                    <!-- Table header -->
                    <f:facet name="header">
                        <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" style="float:left" />
                        <p:commandButton id="btnStudyOrganisationEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler
                            datasource="dtOrganisationsEntities"
                            trigger=":form:tabView:dtOrganisationsEntities:btnStudyOrganisationEntitiesToggler"
                            style="width:450px"
                            >
                            <p:ajax event="toggle" listener="#{mbStudyOrganisation.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- Organisation name -->
                    <p:column
                        id="colOrganisationName"
                        sortBy="#{studyOrganisation.organisation.name}"
                        filterBy="#{studyOrganisation.organisation.name}"
                        filterMatchMode="contains"
                        visible="#{mbStudyOrganisation.columnVisibilityList[0]}"
                        style="width:60%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.organisation_name}" />
                        </f:facet>
                        <h:outputText value="#{studyOrganisation.organisation.name}" style="float:left;" />
                    </p:column>

                    <!-- Role -->
                    <p:column
                        id="colOrganisationRole"
                        sortBy="#{studyOrganisation.role.name}"
                        filterBy="#{studyOrganisation.role.name}"
                        filterMatchMode="in"
                        visible="#{mbStudyOrganisation.columnVisibilityList[1]}"
                        style="width:25%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.studyOrganisation_role}" />
                        </f:facet>
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                label="#{msg.studyOrganisationRole_plural}"
                                onchange="PF('organisationEntitiesTable').filter()"
                                panelStyle="width:200px"
                                >
                                <f:selectItems
                                    value="#{mbStudyOrganisationRole.entityList}"
                                    var="studyOrganisationRole"
                                    itemLabel="#{studyOrganisationRole.name}"
                                    itemValue="#{studyOrganisationRole.name}"
                                    itemDescription="#{studyOrganisationRole.description}"
                                    />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{studyOrganisation.role.name}" title="#{studyOrganisation.role.description}" style="float:left;" />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                        headerText="#{msg.menu_commands}"
                        exportable="false"
                        toggleable="false"
                        style="width:17%"
                        >
                        <p:commandButton
                            title="#{msg.menu_delete}"
                            icon="ui-icon-trash"
                            update=":deleteStudyOrganisationForm:deleteStudyOrganisationDisplay"
                            immediate="true"
                            process="@this"
                            oncomplete="PF('deleteStudyOrganisationDialog').show();"
                            >
                            <f:setPropertyActionListener
                                value="#{studyOrganisation}"
                                target="#{mbStudyOrganisation.selectedEntity}"
                                />
                        </p:commandButton>
                    </p:column>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbCtmsStudy.selectedEntity.studyOrganisations.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbCtmsStudy.selectedEntity.studyOrganisations.size() == 1}" />
                        <h:outputFormat
                            value="#{msg.search_results_status_n}"
                            rendered="#{mbCtmsStudy.selectedEntity.studyOrganisations.size() > 1}"
                            >
                            <f:param value="#{mbCtmsStudy.selectedEntity.studyOrganisations.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>

                        <p:dataExporter type="xls" target="dtOrganisationsEntities" fileName="#{msg.study_organisations}" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtOrganisationsEntities" fileName="#{msg.study_organisations}" />
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- TreatmentArms -->
            <p:tab title="#{msg.study_arms}">

                <!-- Study Configuration -->
                <p:accordionPanel id="pnlStudyTreatmentArmConfig" multiple="true" activeIndex="-1">
                    <p:tab title="#{msg.study} #{msg.configuration}">
                        <p:panelGrid
                            id="pgStudyTreatnentArmConfig"
                            columns="2"
                            cellpadding="4"
                            style="margin:0 auto;"
                            >

                            <!-- Toolbar Commands -->
                            <h:outputLabel value="#{msg.study_isEnrollmentArmAssignmentRequired}:" />
                            <p:selectBooleanButton
                                id="chbEnrollmentArmAssignmentRequired"
                                value="#{mbCtmsStudy.selectedEntity.isEnrollmentArmAssignmentRequired}"
                                onLabel="#{msg.yes}"
                                offLabel="#{msg.no}"
                                onIcon="ui-icon-check"
                                offIcon="ui-icon-close"
                                disabled="#{mbCtmsStudy.selectedEntity == null}"
                                >
                                <p:ajax />
                            </p:selectBooleanButton>

                            <!-- Footer -->
                            <f:facet name="footer">
                                <!-- Save study configuration -->
                                <p:commandButton
                                    id="btnStudyTreatmentArmConfigUpdate"
                                    title="#{msg.menu_save}"
                                    value="#{msg.menu_save}"
                                    action="#{mbCtmsStudy.doUpdateEntity}"
                                    icon="ui-icon-disk"
                                    update=":form:tabView:dtEntities, :growl"
                                    disabled="#{mbCtmsStudy.selectedEntity == null}"
                                    process="@this"
                                    />
                            </f:facet>
                        </p:panelGrid>
                    </p:tab>
                </p:accordionPanel>

                <!-- Toolbar -->
                <p:toolbar>
                    <!-- Left -->
                    <p:toolbarGroup align="left">
                        <p:commandButton
                            value="#{msg.menu_new}"
                            title="#{msg.treatmentArm_new}"
                            icon="ui-icon-document"
                            oncomplete="PF('newArmDialog').show();"
                            style="float: left;"
                            immediate="true"
                            update=":newArmForm:newDisplayArm"
                            process="@this"
                            actionListener="#{mbTreatmentArm.prepareNewEntity}"
                            disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                            />
                    </p:toolbarGroup>
                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                            value="#{msg.menu_print}"
                            title="#{msg.treatmentArm_print}"
                            icon="ui-icon-print"
                            >
                            <p:printer target="dtArms" />
                        </p:commandButton>
                        <p:commandButton
                            value="#{msg.menu_help}"
                            title="#{msg.menu_help}"
                            icon="ui-icon-help"
                            disabled="True"
                            />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Study treatment arms table -->
                <p:dataTable
                    id="dtArms"
                    var="arm"
                    value="#{mbCtmsStudy.selectedEntity.treatmentArms}"
                    widgetVar="armsTable"
                    resizableColumns="true"
                    paginator="true"
                    draggableColumns="false"
                    rows="15"
                    rowsPerPageTemplate="15,25,50"
                    emptyMessage="#{msg.search_empty}"
                    selection="#{mbTreatmentArm.selectedEntity}"
                    selectionMode="single"
                    rowKey="#{arm.name}"
                    rowIndexVar="rowIndex"
                    filteredValue="#{mbTreatmentArm.filteredEntities}"
                    sortMode="multiple"
                    sortBy="#{mbTreatmentArm.preSortOrder}"
                    disabledTextSelection="false"
                    >

                    <!-- Data table header -->
                    <f:facet name="header">
                        <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" style="float:left" />
                        <p:commandButton id="btnTreatmentArmEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler
                            datasource="dtArms"
                            trigger=":form:tabView:dtArms:btnTreatmentArmEntitiesToggler"
                            style="width:450px"
                            >
                            <p:ajax event="toggle" listener="#{mbTreatmentArm.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- Name-->
                    <p:column
                        id="colArmName"
                        headerText="#{msg.treatmentArm}"
                        sortBy="#{arm.name}"
                        filterBy="#{arm.name}"
                        filterMatchMode="contains"
                        visible="#{mbTreatmentArm.columnVisibilityList[0]}"
                        style="width:40%"
                        >
                        <h:outputText value="#{arm.name}" style="float: left;" />
                    </p:column>

                    <!-- Description -->
                    <p:column
                        headerText="#{msg.treatmentArm_description}"
                        sortBy="#{arm.description}"
                        filterBy="#{arm.description}"
                        filterMatchMode="contains"
                        visible="#{mbTreatmentArm.columnVisibilityList[1]}"
                        style="width:20%"
                        >
                        <h:outputText value="#{arm.description}" style="float: left;" />
                    </p:column>

                    <!-- SubjectsCount -->
                    <p:column
                        headerText="#{msg.treatmentArm_plannedSubjectsCount}"
                        sortBy="#{arm.plannedSubjectsCount}"
                        visible="#{mbTreatmentArm.columnVisibilityList[2]}"
                        style="width:10%"
                        >
                        <h:outputText value="#{arm.plannedSubjectsCount}" style="float: left;" />
                    </p:column>

                    <!-- IsEnabled-->
                    <p:column
                        headerText="#{msg.treatmentArm_isEnabled}"
                        filterBy="#{arm.isEnabled}"
                        filterMatchMode="equals"
                        visible="#{mbTreatmentArm.columnVisibilityList[3]}"
                        style="width:10%"
                        >
                        <f:facet name="filter">
                            <p:selectOneButton onchange="PF('armsTable').filter()">
                                <f:converter converterId="javax.faces.Boolean" />
                                <f:selectItem itemLabel="#{msg.yes}" itemValue="true" />
                                <f:selectItem itemLabel="#{msg.no}" itemValue="false" />
                            </p:selectOneButton>
                        </f:facet>
                        <p:selectBooleanButton
                            value="#{arm.isEnabled}"
                            onLabel="#{msg.yes}"
                            offLabel="#{msg.no}"
                            onIcon="ui-icon-check"
                            offIcon="ui-icon-close"
                            disabled="true"
                            />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                        headerText="#{msg.menu_commands}"
                        exportable="false"
                        toggleable="false"
                        style="width:17%"
                        >

                        <!-- Edit -->
                        <p:commandButton
                            title="#{msg.menu_edit}"
                            icon="ui-icon-contact"
                            update=":editArmForm:editDisplayArm"
                            immediate="true"
                            process="@this"
                            oncomplete="PF('editArmDialog').show();"
                            disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                            >
                            <f:setPropertyActionListener
                                value="#{arm}"
                                target="#{mbTreatmentArm.selectedEntity}"
                                />
                        </p:commandButton>

                        <!-- Delete -->
                        <p:commandButton
                            title="#{msg.menu_delete}"
                            icon="ui-icon-trash"
                            update=":deleteArmForm:deleteDisplayArm"
                            oncomplete="PF('deleteArmDialog').show();"
                            immediate="true"
                            process="@this"
                            disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                            >
                            <f:setPropertyActionListener
                                value="#{arm}"
                                target="#{mbTreatmentArm.selectedEntity}"
                                />
                        </p:commandButton>
                    </p:column>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbCtmsStudy.selectedEntity.treatmentArms.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbCtmsStudy.selectedEntity.treatmentArms.size() == 1}" />
                        <h:outputFormat
                            value="#{msg.search_results_status_n}"
                            rendered="#{mbCtmsStudy.selectedEntity.treatmentArms.size() > 1}"
                            >
                            <f:param value="#{mbCtmsStudy.selectedEntity.treatmentArms.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtArms" fileName="#{msg.study_arms}" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtArms" fileName="#{msg.study_arms}" />
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- Randomisation Sites -->
            <p:tab title="#{msg.study_randomisationSites}">

                <!-- Toolbar -->
                <p:toolbar>
                    <!-- Left -->
                    <p:toolbarGroup align="left">
                        <p:commandButton
                                value="#{msg.menu_new}"
                                title="Assign new participating site"
                                icon="ui-icon-document"
                                oncomplete="PF('newSiteDialog').show();"
                                style="float: left;"
                                immediate="true"
                                update=":newSiteForm:newDisplaySite"
                                process="@this"
                                actionListener="#{mbPartnerSite.prepareNewEntity}"
                                disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                                />
                    </p:toolbarGroup>
                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                                value="#{msg.menu_print}"
                                title="#{msg.partnerSite_print}"
                                icon="ui-icon-print"
                                >
                            <p:printer target="dtTrialSites" />
                        </p:commandButton>
                        <p:commandButton
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                disabled="True"
                                />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Participating sites for randomisation data table -->
                <p:dataTable
                        id="dtTrialSites"
                        var="site"
                        value="#{mbCtmsStudy.selectedEntity.participatingSites}"
                        widgetVar="sitesTable"
                        resizableColumns="true"
                        paginator="true"
                        draggableColumns="false"
                        rows="15"
                        rowsPerPageTemplate="15,25,50"
                        emptyMessage="#{msg.search_empty}"
                        selection="#{mbPartnerSite.selectedEntity}"
                        selectionMode="single"
                        rowKey="#{site.id}"
                        rowIndexVar="rowIndex"
                        filteredValue="#{mbPartnerSite.filteredEntities}"
                        sortMode="multiple"
                        sortBy="#{mbPartnerSite.preSortOrder}"
                        disabledTextSelection="false"
                        >

                    <!-- Data table header -->
                    <f:facet name="header">
                        <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" style="float:left" />
                        <p:commandButton id="btnTrialSiteEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler
                                datasource="dtTrialSites"
                                trigger=":form:tabView:dtTrialSites:btnTrialSiteEntitiesToggler"
                                style="width:450px"
                                >
                            <p:ajax event="toggle" listener="#{mbPartnerSite.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- Identifier -->
                    <p:column
                            id="colSiteIdentifier"
                            headerText="#{msg.partnerSite_identifier}"
                            sortBy="#{site.identifier}"
                            filterBy="#{site.identifier}"
                            filterMatchMode="contains"
                            style="width:15%"
                            >
                        <h:outputText value="#{site.identifier}" style="float: left;" />
                    </p:column>

                    <!-- Site name -->
                    <p:column
                            headerText="#{msg.partnerSite_siteName}"
                            sortBy="#{site.name}"
                            filterBy="#{site.name}"
                            filterMatchMode="contains"
                            style="width:68%"
                            >
                        <h:outputText value="#{site.name}" style="float: left;" />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                            headerText="#{msg.menu_commands}"
                            exportable="false"
                            toogable="false"
                            style="width:17%"
                            >

                        <!-- Delete -->
                        <p:commandButton
                                title="#{msg.menu_delete}"
                                icon="ui-icon-trash"
                                update=":deleteSiteForm:deleteDisplaySite"
                                oncomplete="PF('deleteSiteDialog').show();"
                                immediate="true"
                                process="@this"
                                disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                                >
                            <f:setPropertyActionListener
                                    value="#{site}"
                                    target="#{mbPartnerSite.selectedEntity}"
                                    />
                        </p:commandButton>
                    </p:column>

                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbCtmsStudy.selectedEntity.participatingSites.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbCtmsStudy.selectedEntity.participatingSites.size() == 1}" />
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbCtmsStudy.selectedEntity.participatingSites.size() > 1}"
                                >
                            <f:param value="#{mbCtmsStudy.selectedEntity.participatingSites.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtTrialSites" fileName="#{msg.study_randomisationSites}" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtTrialSites" fileName="#{msg.study_randomisationSites}" />
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- Stratification criteria -->
            <p:tab title="#{msg.study_stratificationCriteria}">
                <!-- Toolbar -->
                <p:toolbar>
                    <!-- Left -->
                    <p:toolbarGroup align="left">
                        <p:commandButton
                                value="#{msg.menu_new}"
                                title="#{msg.abstractCriterion_new}"
                                icon="ui-icon-document"
                                oncomplete="PF('newCriterionDialog').show();"
                                style="float: left;"
                                immediate="true"
                                update=":newCriteriaForm:newDisplayCriteria"
                                process="@this"
                                disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                                />
                    </p:toolbarGroup>
                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                                value="#{msg.menu_print}"
                                title="#{msg.abstractCriterion_print}"
                                icon="ui-icon-print"
                                >
                            <p:printer target="dtCriteria" />
                        </p:commandButton>
                        <p:commandButton
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                disabled="True"
                                />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Subject Criteria Datatable-->
                <p:dataTable
                        id="dtCriteria"
                        var="criterion"
                        value="#{mbCtmsStudy.selectedEntity.subjectCriteria}"
                        widgetVar="criteriaTable"
                        resizableColumns="true"
                        paginator="true"
                        draggableColumns="false"
                        rows="15"
                        rowsPerPageTemplate="15,25,50"
                        emptyMessage="#{msg.search_empty}"
                        selection="#{mbStratificationCriterion.selectedEntity}"
                        selectionMode="single"
                        rowKey="#{criterion.id}"
                        rowIndexVar="rowIndex"
                        filteredValue="#{mbStratificationCriterion.filteredEntities}"
                        sortMode="multiple"
                        sortBy="#{mbStratificationCriterion.preSortOrder}"
                        disabledTextSelection="false"
                        >

                    <!-- Data table header -->
                    <f:facet name="header">
                        <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" style="float:left" />
                        <p:commandButton id="btnStratificationCriteriaEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler
                                datasource="dtCriteria"
                                trigger=":form:tabView:dtCriteria:btnStratificationCriteriaEntitiesToggler"
                                style="width:450px"
                                >
                            <p:ajax event="toggle" listener="#{mbStratificationCriterion.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- Name -->
                    <p:column
                            id="colCritName"
                            headerText="#{msg.abstractCriterion_name}"
                            sortBy="#{criterion.name}"
                            filterBy="#{criterion.name}"
                            filterMatchMode="contains"
                            style="width:27%"
                            >
                        <h:outputText value="#{criterion.name}" style="float: left;" />
                    </p:column>

                    <!-- Description -->
                    <p:column
                            headerText="#{msg.abstractCriterion_description}"
                            sortBy="#{criterion.description}"
                            style="width:40%"
                            >
                        <h:outputText value="#{criterion.description}" style="float: left;" />
                    </p:column>

                    <!-- Type -->
                    <p:column
                            headerText="#{msg.abstractCriterion_contstraintType}"
                            sortBy="#{criterion.contstraintType.simpleName}"
                            filterBy="#{criterion.contstraintType.simpleName}"
                            filterMatchMode="in"
                            style="width:10%"
                            >
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                    label="Types"
                                    onchange="PF('criteriaTable').filter()"
                                    panelStyle="width:180px"
                                    scrollHeight="50"
                                    >
                                <f:selectItems
                                        value="#{mbStratificationCriterion.criteriaList}"
                                        var="critTypeName"
                                        itemLabel="#{critTypeName}"
                                        itemValue="#{critTypeName}"
                                        />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{criterion.contstraintType.simpleName}" />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                            headerText="#{msg.menu_commands}"
                            exportable="false"
                            toggleable="false"
                            style="width:17%"
                            >

                        <!-- Edit -->
                        <p:commandButton
                                title="#{msg.menu_edit}"
                                icon="ui-icon-contact"
                                update=":editCriterionForm:editDisplayCriterion"
                                immediate="true"
                                process="@this"
                                oncomplete="PF('editCriterionDialog').show();"
                                disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                                >
                            <f:setPropertyActionListener
                                    value="#{criterion}"
                                    target="#{mbStratificationCriterion.selectedEntity}"
                                    />
                        </p:commandButton>

                        <!-- Delete -->
                        <p:commandButton
                                title="#{msg.menu_delete}"
                                icon="ui-icon-trash"
                                update=":deleteCriterionForm:deleteDisplayCriterion"
                                oncomplete="PF('deleteCriterionDialog').show();"
                                immediate="true"
                                process="@this"
                                disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                                >
                            <f:setPropertyActionListener
                                    value="#{criterion}"
                                    target="#{mbStratificationCriterion.selectedEntity}"
                                    />
                        </p:commandButton>
                    </p:column>

                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbCtmsStudy.selectedEntity.subjectCriteria.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbCtmsStudy.selectedEntity.subjectCriteria.size() == 1}" />
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbCtmsStudy.selectedEntity.subjectCriteria.size() > 1}"
                                >
                            <f:param value="#{mbCtmsStudy.selectedEntity.subjectCriteria.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtCriteria" fileName="#{msg.study_stratificationCriteria}" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtCriteria" fileName="#{msg.study_stratificationCriteria}" />
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- Randomisation -->
            <p:tab title="#{msg.study_randomisationConf}">

                <!-- Toolbar -->
                <p:toolbar>
                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                disabled="True"
                                />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- Randomistaion Panel -->
                <p:panelGrid
                        id="displayRandomisation"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;float: left;width: 100%"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Include site to stratification -->
                    <h:outputLabel value="Stratify site:" />
                    <p:selectBooleanButton
                        value="#{mbCtmsStudy.selectedEntity.isStratifyTrialSite}"
                        onLabel="#{msg.yes}"
                        offLabel="#{msg.no}"
                        onIcon="ui-icon-check"
                        offIcon="ui-icon-close"
                        disabled="true"
                        />

                    <!-- Fixed randomisation strategy for now - we support only one type -->
                    <h:outputLabel value="Randomisation strategy: " for="txtRandomisationStrategy" />
                    <h:outputText id="txtRandomisationStrategy" value="Permutated block randomisation" />

                    <!-- Type of variable block -->
                    <h:outputLabel value="Variable block type:" for="txtVariableBlockType" />
                    <h:outputText
                            id="txtVariableBlockType"
                            value="#{mbCtmsStudy.randomisationConf.type}"
                            title="MULTIPLY - the size of variable block is multiplication of the proportion of the treatment arms; e.g. x times multiply raw block [arm1, arm2] to create real block with specified block size; ABSOLUTE - the size of variable block is absolute configured size"
                            />

                    <!-- Minimum block size -->
                    <h:outputLabel value="Minimum block size: *" for="txtMinimumBlockSize" />
                    <p:spinner
                            id="txtMinimumBlockSize"
                            value="#{mbCtmsStudy.randomisationConf.minimumBlockSize}"
                            min="0"
                            required="true"
                            requiredMessage="Minimum block size is mandatory!"
                            readonly="#{!userContext.hasRole('ROLE_ADMIN')}"
                            rendered="#{mbCtmsStudy.selectedEntity != null}"
                            />

                    <!-- Maximum block size-->
                    <h:outputLabel value="Maximum block size: *" for="txtMaximumBlockSize" />
                    <p:spinner
                            id="txtMaximumBlockSize"
                            value="#{mbCtmsStudy.randomisationConf.maximumBlockSize}"
                            min="0"
                            required="true"
                            requiredMessage="Maximum block size is mandatory!"
                            readonly="#{!userContext.hasRole('ROLE_ADMIN')}"
                            rendered="#{mbCtmsStudy.selectedEntity != null}"
                            />

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                title="Save [ctrl+shift+s]"
                                update=":form:tabView:displayRandomisation, :growl"
                                icon="ui-icon-disk"
                                actionListener="#{mbCtmsStudy.doUpdateRandomisation}"
                                process="@this displayRandomisation"
                                disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                                />
                    </f:facet>
                </p:panelGrid>
            </p:tab>

            <!-- Document/Files -->
            <p:tab title="#{msg.study_documents}">

                <!-- Docs toolbar -->
                <p:toolbar>
                    <!-- Left -->
                    <p:toolbarGroup align="left">
                        <p:commandButton
                            value="#{msg.menu_new}"
                            title="#{msg.studyDoc_new}"
                            icon="ui-icon-document"
                            oncomplete="PF('newStudyDocDialog').show();"
                            style="float: left;"
                            immediate="true"
                            update=":newStudyDocForm:newDisplayDoc"
                            actionListener="#{mbStudyDoc.prepareNewEntity}"
                            process="@this"
                            >
                        </p:commandButton>
                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                            value="#{msg.menu_print}"
                            title="#{msg.studyDoc_print}"
                            icon="ui-icon-print"
                            >
                            <p:printer target="dtStudyDocs" />
                        </p:commandButton>
                        <p:commandButton
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                disabled="True"
                                />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- RadPlanBio study docs table -->
                <p:dataTable
                    id="dtStudyDocs"
                    var="studyDoc"
                    value="#{mbCtmsStudy.selectedEntity.studyDocs}"
                    widgetVar="studyDocsTable"
                    resizableColumns="true"
                    paginator="true"
                    draggableColumns="false"
                    rows="15"
                    rowsPerPageTemplate="15,25,50"
                    emptyMessage="#{msg.search_empty}"
                    selection="#{mbStudyDoc.selectedEntity}"
                    selectionMode="single"
                    rowKey="#{studyDoc.id}"
                    rowIndexVar="rowIndex"
                    filteredValue="#{mbStudyDoc.filteredEntities}"
                    sortMode="multiple"
                    sortBy="#{mbStudyDoc.preSortOrder}"
                    disabledTextSelection="false"
                    >

                    <!-- Header -->
                    <f:facet name="header">
                        <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" style="float:left" />
                        <p:commandButton id="btnStudyDocEntitiesToggler" value="#{msg.menu_columns}" style="float:right" icon="ui-icon-calculator" />
                        <p:columnToggler
                            datasource="dtStudyDocs"
                            trigger=":form:tabView:dtStudyDocs:btnStudyDocEntitiesToggler"
                            style="width:300px"
                            >
                            <p:ajax event="toggle" listener="#{mbStudyDoc.onEntityToggle}" />
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- Displayname -->
                    <p:column
                        id="displayname"
                        headerText="#{msg.studyDoc_displayname}"
                        sortBy="#{studyDoc.displayname}"
                        filterBy="#{studyDoc.displayname}"
                        filterMatchMode="contains"
                        visible="#{mbStudyDoc.columnVisibilityList[0]}"
                        style="width:30%"
                        >
                        <h:outputText value="#{studyDoc.displayname}" style="float:left;" />
                    </p:column>

                    <!-- Filename -->
                    <p:column
                        headerText="#{msg.studyDoc_filename}"
                        sortBy="#{studyDoc.filename}"
                        filterBy="#{studyDoc.filename}"
                        filterMatchMode="contains"
                        visible="#{mbStudyDoc.columnVisibilityList[1]}"
                        style="width:20%"
                        >
                        <h:outputText value="#{studyDoc.filename}" style="float:left;" />
                    </p:column>

                    <!-- Doc type -->
                    <p:column
                        id="colDocType"
                        sortBy="#{studyDoc.docType.name}"
                        filterBy="#{studyDoc.docType.name}"
                        filterMatchMode="contains"
                        visible="#{mbStudyDoc.columnVisibilityList[2]}"
                        style="width:30%"
                        >
                        <f:facet name="header">
                            <h:outputText value="#{msg.studyDoc_type}" />
                        </f:facet>
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                label="#{msg.docType_plural}"
                                onchange="PF('studyDocsTable').filter()"
                                panelStyle="width:200px"
                                scrollHeight="110"
                                >
                                <f:selectItems
                                    value="#{mbDocType.entityList}"
                                    var="docType"
                                    itemLabel="#{docType.name}"
                                    itemValue="#{docType.name}"
                                    itemDescription="#{docType.description}"
                                    />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{studyDoc.docType.name}" title="#{studyDoc.docType.description}" style="float:left;" />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                        headerText="#{msg.menu_commands}"
                        exportable="false"
                        toggleable="false"
                        style="width:17%"
                        >

                        <!-- Download -->
                        <p:commandButton
                            title="#{msg.menu_download}"
                            icon="ui-icon-arrowthick-1-s"
                            ajax="false"
                            update=":growl"
                            process="@this"
                            >
                            <f:setPropertyActionListener
                                value="#{studyDoc}"
                                target="#{mbStudyDoc.selectedEntity}"
                                />
                            <p:fileDownload value="#{mbStudyDoc.file}" />
                        </p:commandButton>

                        <!-- Delete -->
                        <p:commandButton
                            title="#{msg.menu_delete}"
                            icon="ui-icon-trash"
                            update=":deleteStudyDocForm:deleteDisplayDoc"
                            oncomplete="PF('deleteStudyDocDialog').show();"
                            immediate="true"
                            process="@this"
                            >
                            <f:setPropertyActionListener
                                value="#{studyDoc}"
                                target="#{mbStudyDoc.selectedEntity}"
                                />
                        </p:commandButton>
                    </p:column>

                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbCtmsStudy.selectedEntity.studyDocs.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbCtmsStudy.selectedEntity.studyDocs.size() == 1}" />
                        <h:outputFormat
                            value="#{msg.search_results_status_n}"
                            rendered="#{mbCtmsStudy.selectedEntity.studyDocs.size() > 1}"
                            >
                            <f:param value="#{mbCtmsStudy.selectedEntity.studyDocs.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtStudyDocs" fileName="#{msg.study_documents}" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtStudyDocs" fileName="#{msg.study_documents}" />
                    </h:commandLink>
                </p:panel>
            </p:tab>
        </p:tabView>
    </ui:define>

    <!-- Definition of dialogs place holder -->
    <ui:define name="dialogs">

        <!-- New Study -->
        <p:dialog
            id="dlgNewEntity"
            header="#{msg.study_new}"
            widgetVar="newEntityDialog"
            resizable="false"
            ajax="true"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >

            <!-- Form -->
            <h:form id="newEntityForm">
                <p:messages id="messagesNew" showDetail="true" autoUpdate="true" />

                <!-- Wizard -->
                <p:wizard widgetVar="newStudyWiz" flowListener="#{mbCtmsStudy.onFlowProcess}">
                    <p:tab title="#{msg.study}">
                        <p:panelGrid
                            id="newDisplay"
                            columns="2"
                            cellpadding="4"
                            style="margin:0 auto;"
                            >

                            <!-- EDC unique study identifier -->
                            <h:outputLabel value="#{msg.study_edcIdentifier}:" for="txtStudyIdentifierNew" title="Only used when study is conducted via RPB EDC (OpenClinica) component" />
                            <h:outputText id="txtStudyIdentifierNew" value="#{mbCtmsStudy.newEntity.ocStudyIdentifier}" />

                            <!-- Principal PartnerSite -->
                            <h:outputLabel value="#{msg.study_principalSite}:" for="txtStudyParterSiteNew" title="Only used when study is conducted via RPB EDC (OpenClinica) component" />
                            <h:outputText id="txtStudyParterSiteNew" value="#{mbCtmsStudy.newEntity.partnerSite.identifier}" title="#{mbCtmsStudy.newEntity.partnerSite.name}" />

                            <!-- Protocol ID -->
                            <h:outputText value="#{msg.study_protocolId}:" for="txtStudyProtocolIdNew" />
                            <p:inputText
                                id="txtStudyProtocolIdNew"
                                value="#{mbCtmsStudy.newEntity.protocolId}"
                                maxlength="255"
                                style="width:350px"
                                />

                            <!-- Name -->
                            <h:outputLabel value="#{msg.study_name}:" for="txtStudyNameNew" />
                            <p:inputText
                                id="txtStudyNameNew"
                                value="#{mbCtmsStudy.newEntity.name}"
                                maxlength="255"
                                style="width:350px"
                                />

                            <!-- Title -->
                            <h:outputLabel value="#{msg.study_title}: #{msg.label_required_suffix}" for="txtStudyTitleNew" />
                            <p:inputTextarea
                                    id="txtStudyTitleNew"
                                    value="#{mbCtmsStudy.newEntity.title}"
                                    rows="3"
                                    counter="counterStudyTitleNew"
                                    maxlength="4000"
                                    counterTemplate="{0} characters remaining."
                                    autoResize="false"
                                    required="true"
                                    requiredMessage="#{msg.study_title} #{msg.validation_required}!"
                                    style="width:350px"
                                    />

                            <!-- Title counter -->
                            <h:outputLabel />
                            <h:outputText id="counterStudyTitleNew" />

                            <!-- Description -->
                            <h:outputLabel value="#{msg.study_description}:" for="txtStudyDescriptionNew" />
                            <p:inputTextarea
                                    id="txtStudyDescriptionNew"
                                    value="#{mbCtmsStudy.newEntity.description}"
                                    rows="10"
                                    counter="counterStudyDescriptionNew"
                                    autoResize="false"
                                    maxlength="4000"
                                    counterTemplate="{0} characters remaining."
                                    style="width:350px"
                                    />

                            <!-- Title counter -->
                            <h:outputLabel />
                            <h:outputText id="counterStudyDescriptionNew" />

                            <!-- Phase -->
                            <h:outputLabel value="#{msg.study_phase}: #{msg.label_required_suffix}" for="ddlStudyPhaseNew" />
                            <p:selectOneMenu
                                    id="ddlStudyPhaseNew"
                                    value="#{mbCtmsStudy.newEntity.phase}"
                                    converter="omnifaces.SelectItemsConverter"
                                    style="width:350px"
                                    required="true"
                                    requiredMessage="#{msg.study_phase} #{msg.validation_required}!"
                                    >
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems
                                        value="#{mbStudyPhase.entityList}"
                                        var="studyPhase"
                                        itemValue="#{studyPhase}"
                                        itemLabel="#{studyPhase.name}"
                                        itemDescription="#{studyPhase.description}"
                                        />
                            </p:selectOneMenu>

                            <!-- SponsoringType -->
                            <h:outputLabel value="#{msg.study_sponsoringType}: #{msg.label_required_suffix}" for="ddlSponsoringTypeNew" />
                            <p:selectOneMenu
                                    id="ddlSponsoringTypeNew"
                                    value="#{mbCtmsStudy.newEntity.sponsoringType}"
                                    converter="omnifaces.SelectItemsConverter"
                                    style="width:350px"
                                    required="true"
                                    requiredMessage="#{msg.study_sponsoringType} #{msg.validation_required}!"
                                    >
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems
                                        value="#{mbSponsoringType.entityList}"
                                        var="sponsoringType"
                                        itemValue="#{sponsoringType}"
                                        itemLabel="#{sponsoringType.name}"
                                        itemDescription="#{sponsoringType.description}"
                                        />
                            </p:selectOneMenu>

                            <!-- ProtocolType -->
                            <h:outputLabel value="#{msg.study_protocolType}: #{msg.label_required_suffix}" for="ddlProtocolTypeNew" />
                            <p:selectOneMenu
                                    id="ddlProtocolTypeNew"
                                    value="#{mbCtmsStudy.newEntity.enumProtocolType}"
                                    rendered="#{mbCtmsStudy.newEntity != null}"
                                    style="width:350px"
                                    required="true"
                                    requiredMessage="#{msg.study_protocolType} #{msg.validation_required}!"
                                    >
                                <p:ajax event="change" />
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems
                                        value="#{EnumProtocolType}"
                                        var="protocolTypeEnum"
                                        itemValue="#{protocolTypeEnum}"
                                        itemLabel="#{protocolTypeEnum.label}"
                                        />
                            </p:selectOneMenu>

                            <!-- Timing -->
                            <h:outputLabel value="#{msg.study_timing}: #{msg.label_required_suffix}" for="ddlTimingNew" />
                            <p:selectOneMenu
                                    id="ddlTimingNew"
                                    value="#{mbCtmsStudy.newEntity.timing}"
                                    converter="omnifaces.SelectItemsConverter"
                                    style="width:350px"
                                    required="true"
                                    requiredMessage="#{msg.study_timing} #{msg.validation_required}!"
                                    >
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems
                                    value="#{mbTimePerspective.entityList}"
                                    var="timing"
                                    itemValue="#{timing}"
                                    itemLabel="#{timing.name}"
                                    itemDescription="#{timing.description}"
                                    />
                            </p:selectOneMenu>

                            <!-- Status -->
                            <h:outputLabel value="#{msg.study_status}: #{msg.label_required_suffix}" for="ddlStudyStatusNew" />
                            <p:selectOneMenu
                                    id="ddlStudyStatusNew"
                                    value="#{mbCtmsStudy.newEntity.status}"
                                    converter="omnifaces.SelectItemsConverter"
                                    style="width:350px"
                                    required="true"
                                    requiredMessage="#{msg.study_status} #{msg.validation_required}!"
                                    filter="true"
                                    filterMatchMode="contains"
                                    var="studyStatusNewIter"
                                    >
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems
                                        value="#{mbStudyStatus.entityList}"
                                        var="studyStatus"
                                        itemValue="#{studyStatus}"
                                        itemLabel="#{studyStatus.name}"
                                        itemDescription="#{studyStatus.description}"
                                        />
                                <p:column>
                                    <h:outputText value="#{studyStatusNewIter.name}" />
                                </p:column>
                            </p:selectOneMenu>

                            <!-- ExpectedTotalEnrollment -->
                            <h:outputLabel value="#{msg.study_expectedTotalEnrollment}:" for="txtExpectedTotalEnrollmentNew" />
                            <p:spinner id="txtExpectedTotalEnrollmentNew" value="#{mbCtmsStudy.newEntity.expectedTotalEnrollment}" min="0" />

                            <!-- Comment -->
                            <h:outputLabel value="#{msg.study_comment}:" for="txtStudyCommentNew" />
                            <p:inputTextarea
                                    id="txtStudyCommentNew"
                                    value="#{mbCtmsStudy.newEntity.comment}"
                                    rows="3"
                                    autoResize="false"
                                    style="width:350px"
                                    />

                        </p:panelGrid>
                    </p:tab>
                    <p:tab title="#{msg.study_studyTags}">
                        <p:panelGrid
                                columns="2"
                                cellpadding="4"
                                style="margin:0 auto; max-height:750px"
                                >
                            <!-- Toolbar Commands -->
                            <h:outputLabel value="#{msg.menu_commands}:" />
                            <p:toolbar>
                                <!-- Left -->
                                <p:toolbarGroup align="left">
                                    <!-- New -->
                                    <p:commandButton
                                            id="btnNewTagNew"
                                            title="#{msg.menu_new}"
                                            icon="ui-icon-document"
                                            immediate="true"
                                            process="@this"
                                            update=":newEntityForm:btnNewTagNew, :newEntityForm:btnSaveTagNew, :newEntityForm:btnCancelTagNew, :newEntityForm:ddlNewStudyTagTypeNew"
                                            actionListener="#{mbCtmsStudy.prepareNewStudyTag}"
                                            disabled="#{mbCtmsStudy.newTag != null}"
                                            />

                                    <!-- Commit-->
                                    <p:commandButton
                                            id="btnSaveTagNew"
                                            title="#{msg.icon_add}"
                                            icon="ui-icon-disk"
                                            process="@this newEntityForm"
                                            update=":newEntityForm:dtStudyTagsNew, :newEntityForm:ddlNewStudyTagTypeNew, :newEntityForm:btnNewTagNew, :newEntityForm:btnSaveTagNew, :newEntityForm:btnCancelTagNew, :growl"
                                            actionListener="#{mbCtmsStudy.saveNewStudyTag}"
                                            disabled="#{mbCtmsStudy.newTag == null}"
                                            />

                                    <!-- Cancel -->
                                    <p:commandButton
                                            id="btnCancelTagNew"
                                            title="#{msg.menu_reset}"
                                            icon="ui-icon-close"
                                            immediate="true"
                                            process="@this"
                                            update=":newEntityForm:dtStudyTagsNew, :newEntityForm:ddlNewStudyTagTypeNew, :newEntityForm:btnCancelTagNew, :newEntityForm:btnNewTagNew, :newEntityForm:btnSaveTagNew, :growl"
                                            actionListener="#{mbCtmsStudy.cancelNewStudyTag}"
                                            disabled="#{mbCtmsStudy.newTag == null}"
                                            />
                                </p:toolbarGroup>
                            </p:toolbar>

                            <!-- Select type for new tag -->
                            <h:outputLabel value="Tag type:" for="ddlNewStudyTagTypeNew" />
                            <p:selectOneMenu
                                    id="ddlNewStudyTagTypeNew"
                                    value="#{mbCtmsStudy.newTag.type}"
                                    converter="#{studyTagTypeConverter}"
                                    style="width:350px"
                                    disabled="#{mbCtmsStudy.newTag == null}"
                                    filter="true"
                                    filterMatchMode="contains"
                                    var="studyTagTypeNewIter"
                                    >
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" noSelectionOption="true" />
                                <f:selectItems
                                        value="#{mbStudyTagType.entityList}"
                                        var="studyTagType"
                                        itemLabel="#{studyTagType.name}"
                                        itemValue="#{studyTagType}"
                                        itemDescription="#{studyTagType.description}"
                                        />
                                <p:column>
                                    <h:outputText value="#{studyTagTypeNewIter.name}" />
                                </p:column>
                            </p:selectOneMenu>

                            <!-- StudyTags -->
                            <h:outputLabel value="Tags:" for="dtStudyTagsNew" />
                            <p:dataTable
                                    id="dtStudyTagsNew"
                                    var="tagNew"
                                    value="#{mbCtmsStudy.newEntity.tags}"
                                    paginator="true"
                                    rows="10"
                                    editable="true"
                                    editMode="cell"
                                    widgetVar="cellTagsNew"
                                    style="width:400px"
                                    >
                                <p:ajax event="cellEdit" listener="#{mbCtmsStudy.onCellEdit}" update=":growl" />

                                <p:column headerText="Type" sortBy="#{tagNew.type.name}">
                                    <p:cellEditor>
                                        <f:facet name="output">
                                            <h:outputText value="#{tagNew.type.name}" title="#{tagNew.type.description}" style="float:left;" />
                                        </f:facet>
                                        <f:facet name="input">
                                            <h:outputText value="#{tagNew.type.name}" title="#{tagNew.type.description}" style="float:left;"  />
                                        </f:facet>
                                    </p:cellEditor>
                                </p:column>

                                <p:column headerText="Value">
                                    <p:cellEditor>
                                        <f:facet name="output">
                                            <h:outputText
                                                    value="#{tagNew.value}"
                                                    rendered="#{tagNew.type.isBoolean == false}"
                                                    />
                                            <h:selectOneMenu value="#{tagNew.value}" rendered="#{tagNew.type.isBoolean}" style="width:100px" disabled="true">
                                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                                <f:selectItems
                                                        value="#{mbCtmsStudy.tagBooleanList}"
                                                        var="bool"
                                                        itemLabel="#{bool}"
                                                        itemValue="#{bool}"
                                                        />
                                            </h:selectOneMenu>
                                        </f:facet>
                                        <f:facet name="input">
                                            <p:inputText
                                                    value="#{tagNew.value}"
                                                    required="#{tagNew.type.isRequired}"
                                                    rendered="#{tagNew.type.isBoolean == false}"
                                                    />
                                            <h:selectOneMenu
                                                    value="#{tagNew.value}"
                                                    rendered="#{tagNew.type.isBoolean}"
                                                    style="width:100px"
                                                    required="#{tagNew.type.isRequired}"
                                                    requiredMessage="Study tag is manatory!"
                                                    >
                                                <f:selectItem
                                                        itemLabel="#{msg.search_select_one}"
                                                        itemValue="#{null}"
                                                        noSelectionOption="true"
                                                        />
                                                <f:selectItems
                                                        value="#{mbCtmsStudy.tagBooleanList}"
                                                        var="bool"
                                                        itemLabel="#{bool}"
                                                        itemValue="#{bool}"
                                                        />
                                            </h:selectOneMenu>
                                        </f:facet>
                                    </p:cellEditor>
                                </p:column>
                            </p:dataTable>

                            <!-- Footer -->
                            <f:facet name="footer">
                                <p:commandButton
                                        value="#{msg.menu_save}"
                                        update=":form:tabView:dtEntities, :form:tabView:dtTumourEntities, :form:tabView:dtTimelineEntities, :form:tabView:tlStudyTimeLineEvents, :form:tabView:dtPersonnelEntities, :form:tabView:dtOrganisationsEntities, :form:tabView:dtArms, :form:tabView:dtCriteria, :form:tabView:dtTrialSites, :form:tabView:displayRandomisation, :form:tabView:dtStudyDocs, :newEntityForm, :growl"
                                        icon="ui-icon-disk"
                                        oncomplete="PF('newStudyWiz').loadStep(PF('newStudyWiz').cfg.steps[0], true); handleSubmitRequest(xhr, status, args, 'dlgNewEntity','newEntityForm');"
                                        actionListener="#{mbCtmsStudy.doCreateEntity}"
                                        process="@this newEntityForm"
                                        />
                            </f:facet>
                        </p:panelGrid>
                    </p:tab>
                </p:wizard>
            </h:form>
        </p:dialog>

        <!-- Edit Study -->
        <p:dialog
            id="dlgEntityDetails"
            header="#{msg.study_edit}"
            widgetVar="editEntityDialog"
            resizable="false"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >
            <!-- Form -->
            <h:form id="entityDetailsForm">

                <p:messages id="messagesEdit" showDetail="true" autoUpdate="true" />

                <!-- Wizard -->
                <p:wizard widgetVar="editStudyWiz" flowListener="#{mbCtmsStudy.onFlowProcess}">
                    <p:tab title="#{msg.study}">
                        <p:panelGrid
                            columns="2"
                            cellpadding="4"
                            style="margin:0 auto; max-height:750px"
                            >

                            <!-- EDC unique study identifier -->
                            <h:outputLabel value="#{msg.study_edcIdentifier}:" for="txtStudyIdentifierEdit" title="Only used when study is conducted via RPB EDC (OpenClinica) component" />
                            <h:outputText id="txtStudyIdentifierEdit" value="#{mbCtmsStudy.selectedEntity.ocStudyIdentifier}" />

                            <!-- Principal PartnerSite -->
                            <h:outputLabel value="#{msg.study_principalSite}:" for="txtStudyParterSiteEdit" title="Only used when study is conducted via RPB EDC (OpenClinica) component" />
                            <h:outputText id="txtStudyParterSiteEdit" value="#{mbCtmsStudy.selectedEntity.partnerSite.identifier}" title="#{mbCtmsStudy.selectedEntity.partnerSite.name}" />

                            <!-- Protocol ID -->
                            <h:outputText value="#{msg.study_protocolId}:" for="txtStudyProtocolIdEdit" />
                            <p:inputText
                                id="txtStudyProtocolIdEdit"
                                value="#{mbCtmsStudy.selectedEntity.protocolId}"
                                maxlength="255"
                                style="width:350px"
                                />

                            <!-- Name -->
                            <h:outputLabel value="#{msg.study_name}:" for="txtStudyNameEdit" />
                            <p:inputText
                                    id="txtStudyNameEdit"
                                    value="#{mbCtmsStudy.selectedEntity.name}"
                                    maxlength="255"
                                    style="width:350px"
                                    />

                            <!-- Title -->
                            <h:outputLabel value="#{msg.study_title}: #{msg.label_required_suffix}" for="txtStudyTitleEdit" />
                            <p:inputTextarea
                                    id="txtStudyTitleEdit"
                                    value="#{mbCtmsStudy.selectedEntity.title}"
                                    rows="3"
                                    counter="counterStudyTitleEdit"
                                    maxlength="4000"
                                    counterTemplate="{0} characters remaining."
                                    autoResize="false"
                                    required="true"
                                    requiredMessage="#{msg.study_title} #{msg.validation_required}!"
                                    style="width:350px"
                                    />

                            <!-- Title counter -->
                            <h:outputLabel />
                            <h:outputText id="counterStudyTitleEdit" />

                            <!-- Description -->
                            <h:outputLabel value="#{msg.study_description}:" for="txtStudyDescriptionEdit" />
                            <p:inputTextarea
                                    id="txtStudyDescriptionEdit"
                                    value="#{mbCtmsStudy.selectedEntity.description}"
                                    rows="10"
                                    counter="counterStudyDescriptionEdit"
                                    maxlength="4000"
                                    counterTemplate="{0} characters remaining."
                                    autoResize="false"
                                    style="width:350px"
                                    />

                            <!-- Description counter -->
                            <h:outputLabel />
                            <h:outputText id="counterStudyDescriptionEdit" />

                            <!-- Phase -->
                            <h:outputLabel value="#{msg.study_phase}: #{msg.label_required_suffix}" for="ddlStudyPhase" />
                            <p:selectOneMenu
                                    id="ddlStudyPhase"
                                    value="#{mbCtmsStudy.selectedEntity.phase}"
                                    converter="omnifaces.SelectItemsConverter"
                                    style="width:350px"
                                    required="true"
                                    requiredMessage="#{msg.study_phase} #{msg.validation_required}!"
                                    >
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems
                                        value="#{mbStudyPhase.entityList}"
                                        var="studyPhase"
                                        itemValue="#{studyPhase}"
                                        itemLabel="#{studyPhase.name}"
                                        itemDescription="#{studyPhase.description}"
                                        />
                            </p:selectOneMenu>

                            <!-- SponsoringType -->
                            <h:outputLabel value="#{msg.study_sponsoringType}: #{msg.label_required_suffix}" for="ddlSponsoringType" />
                            <p:selectOneMenu
                                    id="ddlSponsoringType"
                                    value="#{mbCtmsStudy.selectedEntity.sponsoringType}"
                                    converter="omnifaces.SelectItemsConverter"
                                    style="width:350px"
                                    required="true"
                                    requiredMessage="#{msg.study_sponsoringType} #{msg.validation_required}!"
                                    >
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems
                                        value="#{mbSponsoringType.entityList}"
                                        var="sponsoringType"
                                        itemValue="#{sponsoringType}"
                                        itemLabel="#{sponsoringType.name}"
                                        itemDescription="#{sponsoringType.description}"
                                        />
                            </p:selectOneMenu>

                            <!-- ProtocolType -->
                            <h:outputLabel value="#{msg.study_protocolType}: #{msg.label_required_suffix}" for="ddlProtocolTypeEdit" />
                            <p:selectOneMenu
                                    id="ddlProtocolTypeEdit"
                                    value="#{mbCtmsStudy.selectedEntity.enumProtocolType}"
                                    rendered="#{mbCtmsStudy.selectedEntity != null}"
                                    style="width:350px"
                                    required="true"
                                    requiredMessage="#{msg.study_protocolType} #{msg.validation_required}"
                                    >
                                <p:ajax event="change" />
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems
                                    value="#{EnumProtocolType}"
                                    var="protocolTypeEnum"
                                    itemValue="#{protocolTypeEnum}"
                                    itemLabel="#{protocolTypeEnum.label}"
                                    />
                            </p:selectOneMenu>

                            <!-- Timing -->
                            <h:outputLabel value="#{msg.study_timing}: #{msg.label_required_suffix}" for="ddlTimingEdit" />
                            <p:selectOneMenu
                                id="ddlTimingEdit"
                                value="#{mbCtmsStudy.selectedEntity.timing}"
                                converter="omnifaces.SelectItemsConverter"
                                style="width:350px"
                                required="true"
                                requiredMessage="#{msg.study_timing} #{msg.validation_required}!"
                                >
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems
                                    value="#{mbTimePerspective.entityList}"
                                    var="timing"
                                    itemValue="#{timing}"
                                    itemLabel="#{timing.name}"
                                    itemDescription="#{timing.description}"
                                    />
                            </p:selectOneMenu>

                            <!-- Status -->
                            <h:outputLabel value="#{msg.study_status}: #{msg.label_required_suffix}" for="ddlStudyStatus" />
                            <p:selectOneMenu
                                    id="ddlStudyStatus"
                                    value="#{mbCtmsStudy.selectedEntity.status}"
                                    converter="omnifaces.SelectItemsConverter"
                                    style="width:350px"
                                    required="true"
                                    requiredMessage="#{msg.study_status} #{msg.validation_required}!"
                                    filter="true"
                                    filterMatchMode="contains"
                                    var="studyStatusEditIter"
                                    >
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems
                                        value="#{mbStudyStatus.entityList}"
                                        var="studyStatus"
                                        itemValue="#{studyStatus}"
                                        itemLabel="#{studyStatus.name}"
                                        itemDescription="#{studyStatus.description}"
                                        />
                                <p:column>
                                    <h:outputText value="#{studyStatusEditIter.name}" />
                                </p:column>
                            </p:selectOneMenu>

                            <!-- ExpectedTotalEnrollment -->
                            <h:outputLabel value="#{msg.study_expectedTotalEnrollment}:" for="txtExpectedTotalEnrollmentEdit" />
                            <p:spinner id="txtExpectedTotalEnrollmentEdit" value="#{mbCtmsStudy.selectedEntity.expectedTotalEnrollment}" min="0" />

                            <!-- Comment -->
                            <h:outputLabel value="#{msg.study_comment}:" for="txtStudyCommentEdit" />
                            <p:inputTextarea
                                    id="txtStudyCommentEdit"
                                    value="#{mbCtmsStudy.selectedEntity.comment}"
                                    rows="3"
                                    autoResize="false"
                                    style="width:350px"
                                    />

                        </p:panelGrid>
                    </p:tab>
                    <p:tab title="#{msg.study_studyTags}">
                        <p:panelGrid
                            columns="2"
                            cellpadding="4"
                            style="margin:0 auto; max-height:750px"
                            >
                            <!-- Toolbar Commands -->
                            <h:outputLabel value="#{msg.menu_commands}:" />
                            <p:toolbar>
                                <!-- Left -->
                                <p:toolbarGroup align="left">
                                    <!-- New -->
                                    <p:commandButton
                                            id="btnNewTagEdit"
                                            title="#{msg.menu_new}"
                                            icon="ui-icon-document"
                                            immediate="true"
                                            process="@this"
                                            update=":entityDetailsForm:btnNewTagEdit, :entityDetailsForm:btnSaveTagEdit, :entityDetailsForm:btnCancelTagEdit, :entityDetailsForm:ddlNewStudyTagTypeEdit"
                                            actionListener="#{mbCtmsStudy.prepareNewStudyTag}"
                                            disabled="#{mbCtmsStudy.newTag != null}"
                                            />

                                    <!-- Commit-->
                                    <p:commandButton
                                            id="btnSaveTagEdit"
                                            title="#{msg.icon_add}"
                                            icon="ui-icon-disk"
                                            process="@this entityDetailsForm"
                                            update=":entityDetailsForm:dtStudyTagsEdit, :entityDetailsForm:ddlNewStudyTagTypeEdit, :entityDetailsForm:btnNewTagEdit, :entityDetailsForm:btnSaveTagEdit, :entityDetailsForm:btnCancelTagEdit, :growl"
                                            actionListener="#{mbCtmsStudy.saveNewStudyTag}"
                                            disabled="#{mbCtmsStudy.newTag == null}"
                                            />

                                    <!-- Cancel -->
                                    <p:commandButton
                                            id="btnCancelTagEdit"
                                            title="#{msg.menu_reset}"
                                            icon="ui-icon-close"
                                            immediate="true"
                                            process="@this"
                                            update=":entityDetailsForm:dtStudyTagsEdit, :entityDetailsForm:ddlNewStudyTagTypeEdit, :entityDetailsForm:btnCancelTagEdit, :entityDetailsForm:btnNewTagEdit, :entityDetailsForm:btnSaveTagEdit, :growl"
                                            actionListener="#{mbCtmsStudy.cancelNewStudyTag}"
                                            disabled="#{mbCtmsStudy.newTag == null}"
                                            />

                                    <!-- Add missing required tags -->
                                    <p:commandButton
                                            id="btnReinitTagEdit"
                                            title="#{msg.menu_reload}"
                                            icon="ui-icon-refresh"
                                            immediate="true"
                                            process="@this"
                                            update=":entityDetailsForm:dtStudyTagsEdit, :growl"
                                            actionListener="#{mbCtmsStudy.initialiseMissingRequiredTags(mbStudyTagType.requiredStudyTagTypes)}"
                                            disabled="#{mbCtmsStudy.newTag != null}"
                                            />
                                </p:toolbarGroup>
                            </p:toolbar>

                            <!-- Select type for new tag -->
                            <h:outputLabel value="Tag type:" for="ddlNewStudyTagTypeEdit" />
                            <p:selectOneMenu
                                    id="ddlNewStudyTagTypeEdit"
                                    value="#{mbCtmsStudy.newTag.type}"
                                    converter="#{studyTagTypeConverter}"
                                    style="width:350px"
                                    disabled="#{mbCtmsStudy.newTag == null}"
                                    filter="true"
                                    filterMatchMode="contains"
                                    var="studyTagTypeEditIter"
                                    >
                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" noSelectionOption="true" />
                                <f:selectItems
                                        value="#{mbStudyTagType.entityList}"
                                        var="studyTagType"
                                        itemLabel="#{studyTagType.name}"
                                        itemValue="#{studyTagType}"
                                        itemDescription="#{studyTagType.description}"
                                        />
                                <p:column>
                                    <h:outputText value="#{studyTagTypeEditIter.name}" />
                                </p:column>
                            </p:selectOneMenu>

                            <!-- StudyTags -->
                            <h:outputLabel value="Tags:" for="dtStudyTagsEdit" />
                            <p:dataTable
                                    id="dtStudyTagsEdit"
                                    var="tag"
                                    value="#{mbCtmsStudy.selectedEntity.tags}"
                                    paginator="true"
                                    rows="10"
                                    editable="true"
                                    editMode="cell"
                                    widgetVar="cellTags"
                                    style="width:400px"
                                    >
                                <p:ajax event="cellEdit" listener="#{mbCtmsStudy.onCellEdit}" update=":growl" />

                                <p:column headerText="Type" sortBy="#{tag.type.name}">
                                    <p:cellEditor>
                                        <f:facet name="output">
                                            <h:outputText value="#{tag.type.name}" title="#{tag.type.description}" style="float:left;" />
                                        </f:facet>
                                        <f:facet name="input">
                                            <h:outputText value="#{tag.type.name}" title="#{tag.type.description}" style="float:left;" />
                                        </f:facet>
                                    </p:cellEditor>
                                </p:column>

                                <p:column headerText="Value">
                                    <p:cellEditor>
                                        <f:facet name="output">
                                            <h:outputText
                                                    value="#{tag.value}"
                                                    rendered="#{tag.type.isBoolean == false}"
                                                    />
                                            <h:selectOneMenu value="#{tag.value}" rendered="#{tag.type.isBoolean}" style="width:100px" disabled="true">
                                                <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                                                <f:selectItems
                                                        value="#{mbCtmsStudy.tagBooleanList}"
                                                        var="bool"
                                                        itemLabel="#{bool}"
                                                        itemValue="#{bool}"
                                                        />
                                            </h:selectOneMenu>
                                        </f:facet>
                                        <f:facet name="input">
                                            <p:inputText
                                                    value="#{tag.value}"
                                                    required="#{tag.type.isRequired}"
                                                    rendered="#{tag.type.isBoolean == false}"
                                                    />
                                            <h:selectOneMenu
                                                    value="#{tag.value}"
                                                    rendered="#{tag.type.isBoolean}"
                                                    style="width:100px"
                                                    required="#{tag.type.isRequired}"
                                                    requiredMessage="Study tag is mandatory!"
                                                    >
                                                <f:selectItem
                                                        itemLabel="#{msg.search_select_one}"
                                                        itemValue="#{null}"
                                                        noSelectionOption="true"
                                                        />
                                                <f:selectItems
                                                        value="#{mbCtmsStudy.tagBooleanList}"
                                                        var="bool"
                                                        itemLabel="#{bool}"
                                                        itemValue="#{bool}"
                                                        />
                                            </h:selectOneMenu>
                                        </f:facet>
                                    </p:cellEditor>
                                </p:column>
                            </p:dataTable>

                            <!-- Footer -->
                            <f:facet name="footer">
                                <p:commandButton
                                        id="btnEntityUpdate"
                                        value="#{msg.menu_save}"
                                        update=":form:tabView:dtEntities, :form:tabView:dtTumourEntities, :form:tabView:dtTimelineEntities, :form:tabView:tlStudyTimeLineEvents, :form:tabView:dtPersonnelEntities, :form:tabView:dtOrganisationsEntities, :form:tabView:dtArms, :form:tabView:dtCriteria, :form:tabView:dtTrialSites, :form:tabView:displayRandomisation, :form:tabView:dtStudyDocs, :entityDetailsForm, :growl"
                                        icon="ui-icon-disk"
                                        oncomplete="PF('editStudyWiz').loadStep(PF('editStudyWiz').cfg.steps[0], true); handleSubmitRequest(xhr, status, args, 'dlgEntityDetails','entityDetailsForm');"
                                        actionListener="#{mbCtmsStudy.doUpdateEntity}"
                                        process="@this entityDetailsForm"
                                        />
                            </f:facet>
                        </p:panelGrid>
                    </p:tab>
                </p:wizard>
            </h:form>
        </p:dialog>

        <!-- Delete Study-->
        <p:dialog
            id="dlgDeleteEntity"
            header="#{msg.study_delete}"
            widgetVar="deleteEntityDialog"
            resizable="false"
            ajax="true"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >

            <h:form id="deleteEntityForm">
                <p:panelGrid
                    id="deleteEntityDisplay"
                    columns="2"
                    cellpadding="4"
                    style="margin:0 auto;"
                    >

                    <!-- Protocol ID -->
                    <h:outputText value="#{msg.study_protocolId}:" for="txtStudyProtocolIdDelete" />
                    <p:inputText id="txtStudyProtocolIdDelete" value="#{mbCtmsStudy.selectedEntity.protocolId}" readonly="true" style="width:350px" />

                    <!-- Name -->
                    <h:outputLabel value="#{msg.study_name}:" for="txtStudyNameDelete" />
                    <p:inputText id="txtStudyNameDelete" value="#{mbCtmsStudy.selectedEntity.name}" readonly="true" style="width:350px" />

                    <!-- Title -->
                    <h:outputLabel value="#{msg.study}:" for="txtStudyTitleDelete" />
                    <p:inputTextarea id="txtStudyTitleDelete" value="#{mbCtmsStudy.selectedEntity.title}" rows="3" autoResize="false" readonly="true" style="width:350px" />

                    <!-- Description -->
                    <h:outputLabel value="#{msg.study_description}" for="txtStudyDescriptionDelete" />
                    <p:inputTextarea id="txtStudyDescriptionDelete" value="#{mbCtmsStudy.selectedEntity.description}" rows="10" autoResize="false" readonly="true" style="width:350px" />

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                            value="#{msg.menu_delete}"
                            update=":form:tabView:dtEntities, :growl"
                            icon="ui-icon-trash"
                            oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDeleteEntity','deleteEntityForm');"
                            actionListener="#{mbCtmsStudy.doDeleteEntity}"
                            process="@this deleteEntityForm"
                            />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- New Tumour Entity -->
        <p:dialog
                id="dlgNewTumourEntity"
                header="Assign New Tumour Entity"
                widgetVar="newTumourEntityDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <!-- Form -->
            <h:form id="newTumourEntityForm">
                <p:panelGrid
                        id="newTumourEntityDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}: " />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- TumourEntities -->
                    <h:outputLabel value="#{msg.tumourEntity_plural}: *" for="ddlTumourEntityNew" />
                    <p:selectManyMenu
                            id="ddlTumourEntityNew"
                            value="#{mbCtmsStudy.assignedTumourEntities}"
                            converter="#{tumourEntityConverter}"
                            style="width:350px"
                            required="true"
                            requiredMessage="Study tumour entity is mandatory!"
                            filter="true"
                            filterMatchMode="contains"
                            showCheckbox="true"
                            var="teIterNew"
                            scrollHeight="220"
                            >
                        <f:selectItems
                                value="#{mbTumourEntity.entityList}"
                                var="tumEntityNew"
                                itemLabel="#{tumEntityNew.name}"
                                itemValue="#{tumEntityNew}"
                                itemDescription="#{tumEntityNew.description}"
                                />
                        <p:column>
                            <h:outputText value="#{teIterNew.name}" title="#{teIterNew.description}" />
                        </p:column>
                    </p:selectManyMenu>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                update=":form:tabView:dtEntities, :form:tabView:dtTumourEntities, :newTumourEntityForm, :growl"
                                icon="ui-icon-disk"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgNewTumourEntity','newTumourEntityForm');"
                                actionListener="#{mbCtmsStudy.doAddTumourEntities(mbCtmsStudy.assignedTumourEntities)}"
                                process="@this newTumourEntityForm"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Delete Tumour Entity -->
        <p:dialog
                id="dlgDeleteTumourEntity"
                header="Remove Tumour Entity"
                widgetVar="deleteTumourEntityDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <!-- Form -->
            <h:form id="deleteTumourEntityForm">
                <p:panelGrid
                        id="deleteTumourEntityDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}: " />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- TumourEntity -->
                    <h:outputLabel value="#{msg.tumourEntity}:" for="txtTumourEntityDelete" />
                    <h:outputText
                            id="txtTumourEntityDelete"
                            value="#{mbTumourEntity.selectedEntity.name}"
                            title="#{mbTumourEntity.selectedEntity.description}"
                            />

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_delete}"
                                update=":form:tabView:dtEntities, :form:tabView:dtTumourEntities, :deleteTumourEntityForm, :growl"
                                icon="ui-icon-trash"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDeleteTumourEntity','deleteTumourEntityForm');"
                                actionListener="#{mbCtmsStudy.doRemoveTumourEntity(mbTumourEntity.selectedEntity)}"
                                process="@this deleteTumourEntityForm"
                                />
                    </f:facet>

                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- New TimeLineEvent -->
        <p:dialog
                id="dlgNewTimeLineEvent"
                header="New Timeline Event"
                widgetVar="newTimeLineEventDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <!-- Form -->
            <h:form id="newTimeLineEventForm">
                <p:panelGrid
                        id="newTimelineEventDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Organisation -->
                    <h:outputLabel value="Organisation:" for="ddlOrganisationNew" />
                    <p:selectOneMenu
                            id="ddlOrganisationNew"
                            value="#{mbTimeLineEvent.newEntity.organisation}"
                            converter="#{organisationConverter}"
                            style="width:350px"
                            filter="true"
                            filterMatchMode="contains"
                            var="eventOrgNewIter"
                            >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" noSelectionOption="true" />
                        <f:selectItems
                                value="#{mbOrganisation.entityList}"
                                var="eventOrganisation"
                                itemLabel="#{eventOrganisation.name}"
                                itemValue="#{eventOrganisation}"
                                />
                        <p:column>
                            <h:outputText value="#{eventOrgNewIter.name}" />
                        </p:column>
                        <p:column>
                            <h:outputText visible="#{eventOrgNewIter.parent != null}" value="#{eventOrgNewIter.parent.name}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Name -->
                    <h:outputLabel value="Name: *" for="txtTimeLineEventNameNew" />
                    <p:inputText
                            id="txtTimeLineEventNameNew"
                            value="#{mbTimeLineEvent.newEntity.name}"
                            maxlength="255"
                            style="width:350px"
                            required="true"
                            requiredMessage="Event name is mandatory!"
                            />

                    <!-- Description -->
                    <h:outputLabel value="Description: " for="txtTimeLineEventDescriptionNew" />
                    <p:inputTextarea
                            id="txtTimeLineEventDescriptionNew"
                            value="#{mbTimeLineEvent.newEntity.description}"
                            maxlength="4000"
                            style="width:350px"
                            />

                    <!-- Type -->
                    <h:outputLabel value="Type: *" for="ddlTimeLineEventTypeNew" />
                    <p:selectOneMenu
                            id="ddlTimeLineEventTypeNew"
                            value="#{mbTimeLineEvent.newEntity.type}"
                            converter="#{eventTypeConverter}"
                            style="width:350px"
                            required="true"
                            requiredMessage="Event type is mandatory!"
                            filter="true"
                            filterMatchMode="contains"
                            showCheckbox="true"
                            var="timeLineEventTypeIterNew"
                            >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" noSelectionOption="true" />
                        <f:selectItems
                                value="#{mbEventType.entityList}"
                                var="eType"
                                itemLabel="#{eType.name}"
                                itemValue="#{eType}"
                                itemDescription="#{eType.description}"
                                />
                        <p:column>
                            <h:outputText value="#{timeLineEventTypeIterNew.name}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Importance -->
                    <!-- TODO: -->

                    <!-- StartDate -->
                    <h:outputLabel value="Start date: *" for="calStartDateNew" />
                    <p:calendar
                            id="calStartDateNew"
                            value="#{mbTimeLineEvent.newEntity.startDate}"
                            pattern="dd.MM.yyyy"
                            showButtonPanel="true"
                            navigator="true"
                            required="true"
                            showOn="button"
                            requiredMessage="Start date is mandatory!"
                            />

                    <!-- EndDate -->
                    <h:outputLabel value="End date:" for="calEndDateNew" />
                    <p:calendar
                            id="calEndDateNew"
                            value="#{mbTimeLineEvent.newEntity.endDate}"
                            pattern="dd.MM.yyyy"
                            showButtonPanel="true"
                            navigator="true"
                            required="false"
                            showOn="button"
                            />

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                update=":form:tabView:dtEntities, :form:tabView:dtTimelineEntities, :form:tabView:tlStudyTimeLineEvents, :newTimeLineEventForm, :growl"
                                icon="ui-icon-disk"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgNewTimeLineEvent','newTimeLineEventForm');"
                                actionListener="#{mbCtmsStudy.doAddNewEvent(mbTimeLineEvent.newEntity)}"
                                process="@this newTimeLineEventForm"
                                />
                        <p:commandButton
                                value="#{msg.menu_reset}"
                                type="reset"
                                icon="ui-icon-close"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Edit TimeLineEvent -->
        <p:dialog
                id="dlgEditTimeLineEvent"
                header="Edit Timeline Event"
                widgetVar="editTimeLineEventDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <!-- Form -->
            <h:form id="editTimeLineEventForm">
                <p:panelGrid
                        id="editTimelineEventDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Organisation -->
                    <h:outputLabel value="Organisation:" for="ddlOrganisationEdit" />
                    <p:selectOneMenu
                            id="ddlOrganisationEdit"
                            value="#{mbTimeLineEvent.selectedEntity.organisation}"
                            converter="#{organisationConverter}"
                            style="width:350px"
                            filter="true"
                            filterMatchMode="contains"
                            var="eventOrgEditIter"
                            >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" noSelectionOption="true" />
                        <f:selectItems
                                value="#{mbOrganisation.entityList}"
                                var="eventOrganisationEdit"
                                itemLabel="#{eventOrganisationEdit.name}"
                                itemValue="#{eventOrganisationEdit}"
                                />
                        <p:column>
                            <h:outputText value="#{eventOrgEditIter.name}" />
                        </p:column>
                        <p:column>
                            <h:outputText visible="#{eventOrgEditIter.parent != null}" value="#{eventOrgEditIter.parent.name}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Name -->
                    <h:outputLabel value="Name: *" for="txtTimeLineEventNameEdit" />
                    <p:inputText
                            id="txtTimeLineEventNameEdit"
                            value="#{mbTimeLineEvent.selectedEntity.name}"
                            maxlength="255"
                            style="width:350px"
                            required="true"
                            requiredMessage="Event name is mandatory!"
                            />

                    <!-- Description -->
                    <h:outputLabel value="Description: " for="txtTimeLineEventDescriptionEdit" />
                    <p:inputTextarea
                            id="txtTimeLineEventDescriptionEdit"
                            value="#{mbTimeLineEvent.selectedEntity.description}"
                            maxlength="4000"
                            style="width:350px"
                            />

                    <!-- Type -->
                    <h:outputLabel value="Type: *" for="ddlTimeLineEventTypeEdit" />
                    <p:selectOneMenu
                            id="ddlTimeLineEventTypeEdit"
                            value="#{mbTimeLineEvent.selectedEntity.type}"
                            converter="#{eventTypeConverter}"
                            style="width:350px"
                            required="true"
                            requiredMessage="Event type is mandatory!"
                            filter="true"
                            filterMatchMode="contains"
                            showCheckbox="true"
                            var="timeLineEventTypeIterEdit"
                            >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" noSelectionOption="true" />
                        <f:selectItems
                                value="#{mbEventType.entityList}"
                                var="eType"
                                itemLabel="#{eType.name}"
                                itemValue="#{eType}"
                                itemDescription="#{eType.description}"
                                />
                        <p:column>
                            <h:outputText value="#{timeLineEventTypeIterEdit.name}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Importance -->
                    <!-- TODO: -->

                    <!-- StartDate -->
                    <h:outputLabel value="Start date: *" for="calStartDateEdit" />
                    <p:calendar
                            id="calStartDateEdit"
                            value="#{mbTimeLineEvent.selectedEntity.startDate}"
                            pattern="dd.MM.yyyy"
                            showButtonPanel="true"
                            navigator="true"
                            required="true"
                            showOn="button"
                            requiredMessage="Start date is mandatory!"
                            />

                    <!-- EndDate -->
                    <h:outputLabel value="End date:" for="calEndDateEdit" />
                    <p:calendar
                            id="calEndDateEdit"
                            value="#{mbTimeLineEvent.selectedEntity.endDate}"
                            pattern="dd.MM.yyyy"
                            showButtonPanel="true"
                            navigator="true"
                            required="false"
                            showOn="button"
                            />

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                update=":form:tabView:dtEntities, :form:tabView:dtTimelineEntities, :form:tabView:tlStudyTimeLineEvents, :editTimeLineEventForm, :growl"
                                icon="ui-icon-disk"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgEditTimeLineEvent','editTimeLineEventForm');"
                                actionListener="#{mbCtmsStudy.doUpdateEntity}"
                                process="@this editTimeLineEventForm"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Delete TimeLineEvent -->
        <p:dialog
                id="dlgDeleteTimeLineEvent"
                header="Delete Timeline Event"
                widgetVar="deleteTimeLineEventDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <!-- Form -->
            <h:form id="deleteTimeLineEventForm">
                <p:panelGrid
                        id="deleteTimelineEventDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Organisation -->
                    <h:outputLabel value="Organisation:" for="txtTimeLineEventOrganisationDelete" />
                    <h:outputText
                        id="txtTimeLineEventOrganisationDelete"
                        value="#{mbTimeLineEvent.selectedEntity.organisation.name}"
                        />

                    <!-- Name -->
                    <h:outputLabel value="Name:" for="txtTimeLineEventNameDelete" />
                    <h:outputText
                            id="txtTimeLineEventNameDelete"
                            value="#{mbTimeLineEvent.selectedEntity.name}"
                            />

                    <!-- Description -->
                    <h:outputLabel value="Description:" for="txtTimeLineEventDescriptionDelete" />
                    <h:outputText
                            id="txtTimeLineEventDescriptionDelete"
                            value="#{mbTimeLineEvent.selectedEntity.description}"
                            style="width:350px"
                            />

                    <!-- Type -->
                    <h:outputLabel value="Type:" for="txtTimeLineEventTypeDelete" />
                    <h:outputText
                        id="txtTimeLineEventTypeDelete"
                        value="#{mbTimeLineEvent.selectedEntity.type.name}"
                        />

                    <!-- Importance -->
                    <!-- TODO: -->

                    <!-- StartDate -->
                    <h:outputLabel value="Start date:" for="txtStartDateDelete" />
                    <h:outputText id="txtStartDateDelete" value="#{mbTimeLineEvent.selectedEntity.startDate}">
                        <f:convertDateTime
                                pattern="dd-MM-yyyy"
                                type="date"
                                timeZone="CET"
                                />
                    </h:outputText>

                    <!-- EndDate -->
                    <h:outputLabel value="End date:" for="txtEndDateDelete" />
                    <h:outputText id="txtEndDateDelete" value="#{mbTimeLineEvent.selectedEntity.endDate}">
                        <f:convertDateTime
                                pattern="dd-MM-yyyy"
                                type="date"
                                timeZone="CET"
                                />
                    </h:outputText>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_delete}"
                                update=":form:tabView:dtEntities, :form:tabView:dtTimelineEntities, :form:tabView:tlStudyTimeLineEvents, :deleteTimeLineEventForm, :growl"
                                icon="ui-icon-trash"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDeleteTimeLineEvent','deleteTimeLineEventForm');"
                                actionListener="#{mbCtmsStudy.doRemoveSelectedEvent(mbTimeLineEvent.selectedEntity)}"
                                process="@this deleteTimeLineEventForm"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- New StudyPerson -->
        <p:dialog
            id="dlgNewStudyPerson"
            header="#{msg.studyPerson_new}"
            widgetVar="newStudyPersonDialog"
            resizable="false"
            ajax="true"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >

            <!-- Form -->
            <h:form id="newStudyPersonForm">
                <p:panelGrid
                    id="newStudyPersonDisplay"
                    columns="2"
                    cellpadding="4"
                    style="margin:0 auto;"
                    >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Person -->
                    <h:outputLabel value="#{msg.studyPerson_person}: #{msg.label_required_suffix}" for="ddlStudyPersonNew" />
                    <p:selectOneMenu
                            id="ddlStudyPersonNew"
                            value="#{mbStudyPerson.newEntity.person}"
                            converter="omnifaces.SelectItemsConverter"
                            style="width:350px"
                            required="true"
                            requiredMessage="#{msg.validation_required}: #{msg.studyPerson_person}"
                            filter="true"
                            filterMatchMode="contains"
                            var="studyPersonIter"
                            >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                        <f:selectItems
                                value="#{mbPerson.entityList}"
                                var="personNew"
                                itemLabel="#{personNew.surname} #{personNew.firstname}"
                                itemValue="#{personNew}"
                                />
                        <p:column style="width:10%">
                            <h:outputText
                                    styleClass="ui-icon ui-icon-circle-check"
                                    rendered="#{mbCtmsStudy.selectedEntity.studyPersonExists(studyPersonIter)}"
                                    />
                        </p:column>
                        <p:column>
                            <h:outputText value="#{studyPersonIter.surname} #{studyPersonIter.firstname}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Role -->
                    <h:outputLabel value="#{msg.studyPerson_role}: #{msg.label_required_suffix}" for="ddlStudyPersonRoleNew" />
                    <p:selectOneMenu
                            id="ddlStudyPersonRoleNew"
                            value="#{mbStudyPerson.newEntity.role}"
                            converter="omnifaces.SelectItemsConverter"
                            style="width:350px"
                            required="true"
                            requiredMessage="#{msg.validation_required}: #{msg.studyPerson_role}"
                            filter="true"
                            filterMatchMode="contains"
                            showCheckbox="true"
                            var="studyPersonRoleIterNew"
                            >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" noSelectionOption="true" />
                        <f:selectItems
                                value="#{mbStudyPersonRole.entityList}"
                                var="spRole"
                                itemLabel="#{spRole.name}"
                                itemValue="#{spRole}"
                                itemDescription="#{spRole.description}"
                                />
                        <p:column>
                            <h:outputText value="#{studyPersonRoleIterNew.name}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Can obtain informed consent -->
                    <h:outputLabel value="#{msg.studyPerson_canObtaionInformedConsent}:" for="chbPersonCanInformNew" />
                    <h:selectBooleanCheckbox id="chbPersonCanInformNew" value="#{mbStudyPerson.newEntity.canObtainInformedConsent}" />

                    <!-- StartDate -->
                    <h:outputLabel value="#{msg.studyPerson_startDate}: #{msg.label_required_suffix}" for="calPersonStartDateNew" />
                    <p:calendar
                            id="calPersonStartDateNew"
                            value="#{mbStudyPerson.newEntity.startDate}"
                            pattern="dd.MM.yyyy"
                            showButtonPanel="true"
                            navigator="true"
                            required="true"
                            showOn="button"
                            requiredMessage="#{msg.validation_required}: #{msg.studyPerson_startDate}"
                            />

                    <!-- EndDate -->
                    <h:outputLabel value="#{msg.studyPerson_endDate}:" for="calPersonEndDateNew" />
                    <p:calendar
                            id="calPersonEndDateNew"
                            value="#{mbStudyPerson.newEntity.endDate}"
                            pattern="dd.MM.yyyy"
                            showButtonPanel="true"
                            navigator="true"
                            required="false"
                            showOn="button"
                            />

                    <!-- Comment -->
                    <h:outputLabel value="#{msg.studyPerson_comment}:" for="txtStudyPersonCommentNew" />
                    <p:inputTextarea
                            id="txtStudyPersonCommentNew"
                            value="#{mbStudyPerson.newEntity.comment}"
                            style="width:350px"
                            maxlength="4000"
                            />

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                update=":form:tabView:dtEntities, :form:tabView:dtPersonnelEntities, :newStudyPersonForm, :growl"
                                icon="ui-icon-disk"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgNewStudyPerson','newStudyPersonForm');"
                                actionListener="#{mbCtmsStudy.doAddNewPersonnel(mbStudyPerson.newEntity)}"
                                process="@this newStudyPersonForm"
                                />
                        <p:commandButton
                                value="#{msg.menu_reset}"
                                type="reset"
                                icon="ui-icon-close"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Edit StudyPerson -->
        <p:dialog
            id="dlgEditStudyPerson"
            header="#{msg.studyPerson_edit}"
            widgetVar="editStudyPersonDialog"
            resizable="false"
            ajax="true"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >

            <!-- Form -->
            <h:form id="editStudyPersonForm">
                <p:panelGrid
                    id="editStudyPersonDisplay"
                    columns="2"
                    cellpadding="4"
                    style="margin:0 auto;"
                    >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Person -->
                    <h:outputLabel value="#{msg.studyPerson_person}:" />
                    <h:outputText value="#{mbStudyPerson.selectedEntity.person.surname} #{mbStudyPerson.selectedEntity.person.firstname}" />

                    <!-- Role -->
                    <h:outputLabel value="#{msg.studyPerson_role}: #{msg.label_required_suffix}" for="ddlStudyPersonRoleEdit" />
                    <p:selectOneMenu
                        id="ddlStudyPersonRoleEdit"
                        value="#{mbStudyPerson.selectedEntity.role}"
                        converter="omnifaces.SelectItemsConverter"
                        style="width:350px"
                        required="true"
                        requiredMessage="#{msg.validation_required}: #{msg.studyPerson_person}"
                        filter="true"
                        filterMatchMode="contains"
                        showCheckbox="true"
                        var="studyPersonRoleIterEdit"
                        >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="#{null}" noSelectionOption="true" />
                        <f:selectItems
                            value="#{mbStudyPersonRole.entityList}"
                            var="spRole"
                            itemLabel="#{spRole.name}"
                            itemValue="#{spRole}"
                            itemDescription="#{spRole.description}"
                            />
                        <p:column>
                            <h:outputText value="#{studyPersonRoleIterEdit.name}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Can obtain informed consent -->
                    <h:outputLabel value="#{msg.studyPerson_canObtaionInformedConsent}:" for="chbPersonCanInformEdit" />
                    <h:selectBooleanCheckbox id="chbPersonCanInformEdit" value="#{mbStudyPerson.selectedEntity.canObtainInformedConsent}" />

                    <!-- StartDate -->
                    <h:outputLabel value="#{msg.studyPerson_startDate}: #{msg.label_required_suffix}" for="calPersonStartDateEdit" />
                    <p:calendar
                            id="calPersonStartDateEdit"
                            value="#{mbStudyPerson.selectedEntity.startDate}"
                            pattern="dd.MM.yyyy"
                            showButtonPanel="true"
                            navigator="true"
                            required="true"
                            showOn="button"
                            requiredMessage="#{msg.validation_required}: #{msg.studyPerson_startDate}"
                            />

                    <!-- EndDate -->
                    <h:outputLabel value="#{msg.studyPerson_endDate}:" for="calPersonEndDateEdit" />
                    <p:calendar
                            id="calPersonEndDateEdit"
                            value="#{mbStudyPerson.selectedEntity.endDate}"
                            pattern="dd.MM.yyyy"
                            showButtonPanel="true"
                            navigator="true"
                            required="false"
                            showOn="button"
                            />

                    <!-- Comment -->
                    <h:outputLabel value="#{msg.studyPerson_comment}:" for="txtStudyPersonCommentEdit" />
                    <p:inputTextarea
                            id="txtStudyPersonCommentEdit"
                            value="#{mbStudyPerson.selectedEntity.comment}"
                            style="width:350px"
                            maxlength="4000"
                            />

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                update=":form:tabView:dtEntities, :form:tabView:dtPersonnelEntities, :editStudyPersonForm, :growl"
                                icon="ui-icon-disk"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgEditStudyPerson','editStudyPersonForm');"
                                actionListener="#{mbStudyPerson.doUpdateEntity}"
                                process="@this editStudyPersonForm"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Delete StudyPerson -->
        <p:dialog
                id="dlgDeleteStudyPerson"
                header="#{msg.studyPerson_delete}"
                widgetVar="deleteStudyPersonDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <!-- Form -->
            <h:form id="deleteStudyPersonForm">
                <p:panelGrid
                        id="deleteStudyPersonDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Person -->
                    <h:outputLabel value="#{msg.studyPerson_person}:" />
                    <h:outputText value="#{mbStudyPerson.selectedEntity.person.surname} #{mbStudyPerson.selectedEntity.person.firstname}" />

                    <!-- Role -->
                    <h:outputLabel value="#{msg.studyPerson_role}:" />
                    <h:outputText value="#{mbStudyPerson.selectedEntity.role.name}" />

                    <!-- Can obtain informed consent -->
                    <h:outputLabel value="#{msg.studyPerson_canObtaionInformedConsent}:" for="chbPersonCanInformDelete" />
                    <h:selectBooleanCheckbox id="chbPersonCanInformDelete" value="#{mbStudyPerson.selectedEntity.canObtainInformedConsent}" disabled="true" />

                    <!-- StartDate -->
                    <h:outputLabel value="#{msg.studyPerson_startDate}:" for="calPersonStartDateDelete" />
                    <p:calendar
                            id="calPersonStartDateDelete"
                            value="#{mbStudyPerson.selectedEntity.startDate}"
                            pattern="dd.MM.yyyy"
                            showButtonPanel="true"
                            navigator="true"
                            required="true"
                            showOn="button"
                            requiredMessage="Start date is mandatory!"
                            readonly="true"
                            />

                    <!-- EndDate -->
                    <h:outputLabel value="#{msg.studyPerson_endDate}:" for="calPersonEndDateDelete" />
                    <p:calendar
                            id="calPersonEndDateDelete"
                            value="#{mbStudyPerson.selectedEntity.endDate}"
                            pattern="dd.MM.yyyy"
                            showButtonPanel="true"
                            navigator="true"
                            required="false"
                            showOn="button"
                            readonly="true"
                            />

                    <!-- Comment -->
                    <h:outputLabel value="#{msg.studyPerson_comment}:" for="txtStudyPersonCommentDelete" />
                    <p:inputTextarea
                            id="txtStudyPersonCommentDelete"
                            value="#{mbStudyPerson.selectedEntity.comment}"
                            style="width:350px"
                            maxlength="4000"
                            readonly="true"
                            />

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_delete}"
                                update=":form:tabView:dtEntities, :form:tabView:dtPersonnelEntities, :deleteStudyPersonForm, :growl"
                                icon="ui-icon-trash"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDeleteStudyPerson','deleteStudyPersonForm');"
                                actionListener="#{mbCtmsStudy.doRemoveSelectedPersonnel(mbStudyPerson.selectedEntity)}"
                                process="@this deleteStudyPersonForm"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- New StudyOrganisation -->
        <p:dialog
                id="dlgNewStudyOrganisation"
                header="#{msg.studyOrganisation_new}"
                widgetVar="newStudyOrganisationDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <!-- Form -->
            <h:form id="newStudyOrganisationForm">
                <p:panelGrid
                        id="newStudyOrganisationDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Organisation -->
                    <h:outputLabel value="#{msg.studyOrganisation_oragnisation}: *" for="ddlStudyOrganisationNew" />
                    <p:selectOneMenu
                            id="ddlStudyOrganisationNew"
                            value="#{mbStudyOrganisation.newEntity.organisation}"
                            converter="#{organisationConverter}"
                            style="width:350px"
                            required="true"
                            requiredMessage="Organisation is mandatory!"
                            filter="true"
                            filterMatchMode="contains"
                            var="studyOrganisationIterNew"
                            >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" noSelectionOption="true" />
                        <f:selectItems
                                value="#{mbOrganisation.entityList}"
                                var="orgNew"
                                itemLabel="#{orgNew.name}"
                                itemValue="#{orgNew}"
                                />
                        <p:column style="width:10%">
                            <h:outputText
                                    styleClass="ui-icon ui-icon-circle-check"
                                    rendered="#{mbCtmsStudy.selectedEntity.studyOrganisationExists(studyOrganisationIterNew)}"
                                    />
                        </p:column>
                        <p:column>
                            <h:outputText value="#{studyOrganisationIterNew.name}" />
                        </p:column>
                        <p:column>
                            <h:outputText rendered="#{studyOrganisationIterNew.parent != null}" value="#{studyOrganisationIterNew.parent.name}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Role -->
                    <h:outputLabel value="#{msg.studyOrganisation_role}: *" for="ddlStudyOrganisationRoleNew" />
                    <p:selectOneMenu
                            id="ddlStudyOrganisationRoleNew"
                            value="#{mbStudyOrganisation.newEntity.role}"
                            converter="#{studyOrganisationRoleConverter}"
                            style="width:350px"
                            required="true"
                            requiredMessage="Organisation role is mandatory!"
                            filter="true"
                            filterMatchMode="contains"
                            var="studyOrganisationRoleIterNew"
                            >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" noSelectionOption="true" />
                        <f:selectItems
                                value="#{mbStudyOrganisationRole.entityList}"
                                var="soRole"
                                itemLabel="#{soRole.name}"
                                itemValue="#{soRole}"
                                itemDescription="#{soRole.description}"
                                />
                        <p:column>
                            <h:outputText value="#{studyOrganisationRoleIterNew.name}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                update=":form:tabView:dtEntities, :form:tabView:dtOrganisationsEntities, :newStudyOrganisationForm, :growl"
                                icon="ui-icon-disk"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgNewStudyOrganisation','newStudyOrganisationForm');"
                                actionListener="#{mbCtmsStudy.doAddNewOrganisation(mbStudyOrganisation.newEntity)}"
                                process="@this newStudyOrganisationForm"
                                />
                        <p:commandButton
                                value="#{msg.menu_reset}"
                                type="reset"
                                icon="ui-icon-close"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Delete StudyOrganisation -->
        <p:dialog
                id="dlgDeleteStudyOrganisation"
                header="#{msg.studyOrganisation_delete}"
                widgetVar="deleteStudyOrganisationDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <!-- Form -->
            <h:form id="deleteStudyOrganisationForm">
                <p:panelGrid
                        id="deleteStudyOrganisationDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Organisation -->
                    <h:outputLabel value="#{msg.studyOrganisation_oragnisation}:" />
                    <h:outputText value="#{mbStudyOrganisation.selectedEntity.organisation.name}" />

                    <!-- Role -->
                    <h:outputLabel value="#{msg.studyOrganisation_role}:" />
                    <h:outputText
                            value="#{mbStudyOrganisation.selectedEntity.role.name}"
                            title="#{mbStudyOrganisation.selectedEntity.role.description}"
                            />

                    <!-- Footer -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_delete}"
                                update=":form:tabView:dtEntities, :form:tabView:dtOrganisationsEntities, :deleteStudyOrganisationForm, :growl"
                                icon="ui-icon-disk"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDeleteStudyOrganisation','deleteStudyOrganisationForm');"
                                actionListener="#{mbCtmsStudy.doRemoveSelectedOrganisation(mbStudyOrganisation.selectedEntity)}"
                                process="@this deleteStudyOrganisationForm"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- New TreatmentArm -->
        <p:dialog
            id="dlgNewArm"
            header="#{msg.treatmentArm_new}"
            widgetVar="newArmDialog"
            resizable="false"
            ajax="true"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >

            <h:form id="newArmForm">
                <p:panelGrid
                    id="newDisplayArm"
                    columns="2"
                    cellpadding="4"
                    style="margin:0 auto;"
                    >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Name -->
                    <h:outputLabel value="#{msg.treatmentArm_name}: #{msg.label_required_suffix}" for="txtArmNameNew" />
                    <p:inputText
                        id="txtArmNameNew"
                        value="#{mbTreatmentArm.newEntity.name}"
                        required="true"
                        requiredMessage="Treatment arm name is mandatory!"
                        maxlength="255"
                        style="width:350px"
                        />

                    <!-- Description -->
                    <h:outputLabel value="#{msg.treatmentArm_description}:" for="txtArmDescriptionNew" />
                    <p:inputTextarea
                        id="txtArmDescriptionNew"
                        value="#{mbTreatmentArm.newEntity.description}"
                        rows="3"
                        counter="counterArmDescriptionNew"
                        autoResize="false"
                        maxlength="255"
                        counterTemplate="{0} characters remaining."
                        style="width:350px"
                        />

                    <!-- Description counter -->
                    <h:outputLabel />
                    <h:outputText id="counterArmDescriptionNew" />

                    <!-- PlannedSubjectsCount-->
                    <h:outputLabel value="#{msg.treatmentArm_plannedSubjectsCount}:" for="txtPlannedArmSubjectsNew" />
                    <p:spinner id="txtPlannedArmSubjectsNew" value="#{mbTreatmentArm.newEntity.plannedSubjectsCount}" />

                    <!-- IsEnabled -->
                    <h:outputLabel value="#{msg.treatmentArm_isEnabled}: #{msg.label_required_suffix}" for="chbArmIsEnabledNew" />
                    <p:selectBooleanButton
                        id="chbArmIsEnabledNew"
                        value="#{mbTreatmentArm.newEntity.isEnabled}"
                        onLabel="#{msg.yes}"
                        offLabel="#{msg.no}"
                        onIcon="ui-icon-check"
                        offIcon="ui-icon-close"
                        />

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                            value="#{msg.menu_save}"
                            update=":form:tabView:dtArms, :growl"
                            icon="ui-icon-disk"
                            actionListener="#{mbCtmsStudy.doAddNewTreatmentArm(mbTreatmentArm.newEntity)}"
                            oncomplete=" handleSubmitRequest(xhr, status, args, 'dlgNewArm','newArmForm');"
                            process="@this newArmForm"
                            />
                        <p:commandButton
                            value="#{msg.menu_reset}"
                            type="reset"
                            icon="ui-icon-close"
                            />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Edit TreatmentArm -->
        <p:dialog
            id="dlgEditArm"
            header="#{msg.treatmentArm_edit}"
            widgetVar="editArmDialog"
            resizable="false"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >
            <h:form id="editArmForm">
                <p:panelGrid
                    id="editDisplayArm"
                    columns="2"
                    cellpadding="4"
                    style="margin:0 auto;"
                    >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Name-->
                    <h:outputLabel value="#{msg.treatmentArm_name}:" for="txtTreatmentArmNameEdit" />
                    <h:outputText id="txtTreatmentArmNameEdit" value="#{mbTreatmentArm.selectedEntity.name}" />

                    <!-- Description -->
                    <h:outputLabel value="#{msg.treatmentArm_description}:" for="txtTreatmentArmDescriptionEdit" />
                    <p:inputTextarea
                            id="txtTreatmentArmDescriptionEdit"
                            value="#{mbTreatmentArm.selectedEntity.description}"
                            rows="3"
                            counter="counterArmDescriptionEdit"
                            autoResize="false"
                            maxlength="255"
                            counterTemplate="{0} characters remaining."
                            style="width:350px"
                        />

                    <!-- Description counter -->
                    <h:outputLabel />
                    <h:outputText id="counterArmDescriptionEdit" />

                    <!-- PlannedSubjectsCount-->
                    <h:outputLabel value="#{msg.treatmentArm_plannedSubjectsCount}:" for="txtTreatmentArmPlannedSubjectsCountEdit" />
                    <h:outputText id="txtTreatmentArmPlannedSubjectsCountEdit" value="#{mbTreatmentArm.selectedEntity.plannedSubjectsCount}" />

                    <!-- IsEnabled -->
                    <h:outputLabel value="#{msg.treatmentArm_isEnabled}: #{msg.label_required_suffix}" for="chbArmIsEnabledEdit" />
                    <p:selectBooleanButton
                        id="chbArmIsEnabledEdit"
                        value="#{mbTreatmentArm.selectedEntity.isEnabled}"
                        onLabel="#{msg.yes}"
                        offLabel="#{msg.no}"
                        onIcon="ui-icon-check"
                        offIcon="ui-icon-close"
                        />

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                            value="#{msg.menu_save}"
                            update=":form:tabView:dtEntities, :form:tabView:dtArms, :editArmForm, :growl"
                            icon="ui-icon-disk"
                            oncomplete="handleSubmitRequest(xhr, status, args, 'dlgEditArm','editArmForm');"
                            actionListener="#{mbTreatmentArm.doUpdateEntity}"
                            process="@this editArmForm"
                            />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Delete TreatmentArm -->
        <p:dialog
            id="dlgDeleteArm"
            header="#{msg.treatmentArm_delete}"
            widgetVar="deleteArmDialog"
            resizable="false"
            ajax="true"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >

            <h:form id="deleteArmForm">
                <p:panelGrid
                    id="deleteDisplayArm"
                    columns="2"
                    cellpadding="4"
                    style="margin:0 auto;"
                    >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Name -->
                    <h:outputLabel value="#{msg.treatmentArm_name}:" for="txtTreatmentArmNameDelete" />
                    <h:outputText id="txtTreatmentArmNameDelete" value="#{mbTreatmentArm.selectedEntity.name}" />

                    <!-- Description-->
                    <h:outputLabel value="#{msg.treatmentArm_description}:" for="txtTreatmentArmDescriptionDelete" />
                    <h:outputText id="txtTreatmentArmDescriptionDelete" value="#{mbTreatmentArm.selectedEntity.description}" />

                    <!-- PlannedSubjectsCount -->
                    <h:outputLabel value="#{msg.treatmentArm_plannedSubjectsCount}:" for="txtTreatmentArmPlannedSubjectsCountDelete" />
                    <h:outputText id="txtTreatmentArmPlannedSubjectsCountDelete" value="#{mbTreatmentArm.selectedEntity.plannedSubjectsCount}" />

                    <!-- IsEnabled -->
                    <h:outputLabel value="#{msg.account_isEnabled}:"  for="chbTreatmentArmEnabledDelete" />
                    <p:selectBooleanButton
                        id="chbTreatmentArmEnabledDelete"
                        value="#{mbTreatmentArm.selectedEntity.isEnabled}"
                        onLabel="#{msg.yes}"
                        offLabel="#{msg.no}"
                        onIcon="ui-icon-check"
                        offIcon="ui-icon-close"
                        disabled="true"
                        />

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                            value="#{msg.menu_delete}"
                            update=":form:tabView:dtArms, :growl"
                            icon="ui-icon-trash"
                            oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDeleteArm','deleteArmForm');"
                            actionListener="#{mbCtmsStudy.doRemoveSelectedTreatmentArm(mbTreatmentArm.selectedEntity)}"
                            process="@this deleteArmForm"
                            />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- New Participating site -->
        <p:dialog
                id="dlgNewSite"
                header="Assign new participating site"
                widgetVar="newSiteDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <h:form id="newSiteForm">
                <p:panelGrid
                        id="newDisplaySite"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Principal partner site -->
                    <h:outputLabel value="#{msg.partnerSite}: *" for="cmbParticipatingSites" />
                    <p:selectOneMenu
                            id="cmbParticipatingSites"
                            value="#{mbPartnerSite.newEntity}"
                            converter="#{partnerSiteConverter}"
                            style="width:250px"
                            required="true"
                            requiredMessage="You have to select the participating site for the study."
                            >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" />
                        <f:selectItems
                                value="#{mbPartnerSite.entityList}"
                                var="site"
                                itemLabel="#{site.name}"
                                itemValue="#{site}"
                                />
                    </p:selectOneMenu>

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                update=":form:tabView:dtTrialSites, :newSiteForm, :growl"
                                icon="ui-icon-disk"
                                actionListener="#{mbCtmsStudy.doAddNewTrialSite(mbPartnerSite.newEntity)}"
                                oncomplete=" handleSubmitRequest(xhr, status, args, 'dlgNewSite','newSiteForm');"
                                process="@this newSiteForm"
                                />
                        <p:commandButton
                                value="#{msg.menu_reset}"
                                type="reset"
                                icon="ui-icon-close"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Delete Participating site -->
        <p:dialog
                id="dlgDeleteSite"
                header="Delete participating site"
                widgetVar="deleteSiteDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <h:form id="deleteSiteForm">
                <p:panelGrid
                        id="deleteDisplaySite"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <h:outputLabel value="#{msg.partnerSite_siteName}:" />
                    <h:outputText value="#{mbPartnerSite.selectedEntity.name}" />

                    <h:outputLabel value="#{msg.partnerSite_description}:" />
                    <h:outputText value="#{mbPartnerSite.selectedEntity.description}" />

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_delete}"
                                icon="ui-icon-trash"
                                update=":form:tabView:dtTrialSites, :deleteSiteForm, :growl"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDeleteSite','deleteSiteForm');"
                                actionListener="#{mbCtmsStudy.doRemoveTrialSite(mbPartnerSite.selectedEntity)}"
                                process="@this deleteSiteForm"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- New Criteria -->
        <p:dialog
                id="dlgNewCriteria"
                header="#{msg.abstractCriterion_new}"
                widgetVar="newCriterionDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <h:form id="newCriteriaForm">
                <p:panelGrid
                        id="newDisplayCriteria"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Criterion type -->
                    <h:outputLabel value="#{msg.abstractCriterion_contstraintType}: *" for="cmbCriterionTypesNew" />
                    <p:selectOneMenu
                            id="cmbCriterionTypesNew"
                            value="#{mbStratificationCriterion.selectedCrit}"
                            style="width:250px"
                            required="true"
                            requiredMessage="You have to select criteria type."
                            >
                        <p:ajax update=":newCriteriaForm:newDisplayCriteria" />

                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" />
                        <f:selectItems
                                value="#{mbStratificationCriterion.criteriaList}"
                                var="criterion"
                                itemLabel="#{criterion}"
                                itemValue="#{criterion}"
                                />
                    </p:selectOneMenu>

                    <!-- Name -->
                    <h:outputLabel value="#{msg.abstractCriterion_name}: *" for="txtCriteriaNameNew" />
                    <p:inputText
                            id="txtCriteriaNameNew"
                            value="#{mbStratificationCriterion.newEntity.name}"
                            required="true"
                            requiredMessage="Name of criterion is mandatory!"
                            />

                    <!-- Description -->
                    <h:outputLabel value="#{msg.abstractCriterion_description}: " for="txtCriteriaDescriptionNew" />
                    <p:inputTextarea
                            id="txtCriteriaDescriptionNew"
                            value="#{mbStratificationCriterion.newEntity.description}"
                            />

                    <!-- Option 1 -->
                    <h:outputLabel value="Option 1: *" for="txtCriteriaDichoOption1New" />
                    <p:inputText
                            id="txtCriteriaDichoOption1New"
                            value="#{mbStratificationCriterion.dichotomousCriterion.option1}"
                            required="true"
                            requiredMessage="Option 1 is mandatory!"
                            />

                    <!-- Option 2 -->
                    <h:outputLabel value="Option 2: *" for="txtCriteriaDichoOption2New" />
                    <p:inputText
                            id="txtCriteriaDichoOption2New"
                            value="#{mbStratificationCriterion.dichotomousCriterion.option2}"
                            required="true"
                            requiredMessage="Option 2 is mandatory!"
                            />

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                update=":form:tabView:dtCriteria, :growl"
                                icon="ui-icon-disk"
                                actionListener="#{mbCtmsStudy.doAddNewCriterion(mbStratificationCriterion.newEntity)}"
                                oncomplete=" handleSubmitRequest(xhr, status, args, 'dlgNewCriteria','newCriteriaForm');"
                                process="@this newCriteriaForm"
                                />
                        <p:commandButton
                                value="#{msg.menu_reset}"
                                type="reset"
                                icon="ui-icon-close"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Edit Criteria -->
        <p:dialog
                id="dlgEditCriterion"
                header="View criterion"
                widgetVar="editCriterionDialog"
                resizable="false"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >
            <h:form id="editCriterionForm">
                <p:panelGrid
                        id="editDisplayCriterion"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Name -->
                    <h:outputLabel value="#{msg.abstractCriterion_name}:" />
                    <h:outputText value="#{mbStratificationCriterion.selectedEntity.name}" />

                    <!-- Description-->
                    <h:outputLabel value="#{msg.abstractCriterion_description}:" />
                    <h:outputText value="#{mbStratificationCriterion.selectedEntity.description}" />
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Delete Criteria-->
        <p:dialog
                id="dlgDeleteCriterion"
                header="#{msg.abstractCriterion_delete}"
                widgetVar="deleteCriterionDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <h:form id="deleteCriterionForm">
                <p:panelGrid
                        id="deleteDisplayCriterion"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Name -->
                    <h:outputLabel value="#{msg.abstractCriterion_name}:" />
                    <h:outputText value="#{mbStratificationCriterion.selectedEntity.name}" />

                    <!-- Description-->
                    <h:outputLabel value="#{msg.abstractCriterion_description}:" />
                    <h:outputText value="#{mbStratificationCriterion.selectedEntity.description}" />

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_delete}"
                                update=":form:tabView:dtCriteria, :growl"
                                icon="ui-icon-trash"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDeleteCriterion','deleteCriterionForm');"
                                actionListener="#{mbCtmsStudy.doRemoveCriteria(mbStratificationCriterion.selectedEntity)}"
                                process="@this deleteCriterionForm"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- New StudyDoc -->
        <p:dialog
            id="dlgNewStudyDoc"
            header="#{msg.studyDoc_new}"
            widgetVar="newStudyDocDialog"
            resizable="false"
            ajax="true"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >
            <h:form
                id="newStudyDocForm"
                enctype="multipart/form-data"
                >
                <p:panelGrid
                        id="newDisplayDoc"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Filename -->
                    <h:outputLabel value="#{msg.studyDoc_filename}: *" for="txtFileName" />
                    <p:inputText
                            id="txtFileName"
                            value="#{mbStudyDoc.newEntity.filename}"
                            style="width:500px"
                            disabled="true"
                            required="true"
                            requiredMessage="You have upload document before saving!"
                            />

                    <!-- Upload -->
                    <h:outputLabel
                            value="(pdf, doc, docx, xls) *"
                            for="uplDocFile"
                            rendered="#{mbStudyDoc.newEntity.filename == null}"
                            />
                    <p:fileUpload
                            id="uplDocFile"
                            fileUploadListener="#{mbStudyDoc.handleDocUpload}"
                            rendered="#{mbStudyDoc.newEntity.filename == null}"
                            mode="advanced"
                            update=":growl, :newStudyDocForm:newDisplayDoc"
                            label="Choose a file or drag and drop it here:"
                            sizeLimit="10048576"
                            auto="false"
                            allowTypes="/(\.|\/)(pdf|doc|docx|xls)$/"
                            invalidSizeMessage="The maximum file size allowed is 10 Megabyte!"
                            invalidFileMessage="You are allowed to upload only (pdf, doc, xls and docx documents)!"
                            dragDropSupport="true"
                            fileLimit="1"
                            >
                        <f:attribute name="study" value="#{mbCtmsStudy.selectedEntity}" />
                    </p:fileUpload>

                    <!-- Doc Type -->
                    <h:outputLabel value="#{msg.studyDoc_type}: *" for="ddlDocTypes" />
                    <p:selectOneMenu
                            id="ddlDocTypes"
                            value="#{mbStudyDoc.newEntity.docType}"
                            panelStyle="width: 150px"
                            style="width:500px"
                            converter="#{docTypeConverter}"
                            required="true"
                            requiredMessage="You have to provide type of a document, it is mandatory!"
                            >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" />
                        <f:selectItems
                                value="#{mbDocType.entityList}"
                                var="docTypeNew"
                                itemLabel="#{docTypeNew.name}"
                                itemValue="#{docTypeNew}"
                                />
                    </p:selectOneMenu>

                    <!-- DisplayName -->
                    <h:outputLabel value="#{msg.studyDoc_displayname}: *" for="txtDisplayNameNew" />
                    <p:inputText
                            id="txtDisplayNameNew"
                            value="#{mbStudyDoc.newEntity.displayname}"
                            required="true"
                            requiredMessage="Display name is mandatory!"
                            style="width:500px"
                            />

                    <!-- Description -->
                    <h:outputLabel value="#{msg.studyDoc_description}:" for="txtDescriptionNew" />
                    <p:inputTextarea
                            id="txtDescriptionNew"
                            value="#{mbStudyDoc.newEntity.description}"
                            style="width:500px"
                            />

                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                update=":form:tabView:dtEntities, :form:tabView:dtStudyDocs, :growl"
                                icon="ui-icon-disk"
                                actionListener="#{mbCtmsStudy.doAddNewStudyDoc(mbStudyDoc.newEntity)}"
                                oncomplete=" handleSubmitRequest(xhr, status, args, 'dlgNewStudyDoc','newStudyDocForm');"
                                process="@this newStudyDocForm"
                                />
                        <p:commandButton
                                value="#{msg.menu_reset}"
                                type="reset"
                                icon="ui-icon-close"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Delete StudyDoc -->
        <p:dialog
                id="dlgDeleteStudyDoc"
                header="#{msg.studyDoc_delete}"
                widgetVar="deleteStudyDocDialog"
                resizable="false"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >
            <h:form id="deleteStudyDocForm">
                <p:panelGrid
                        id="deleteDisplayDoc"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- Study Name -->
                    <h:outputLabel value="#{msg.study_name}:" />
                    <h:outputText value="#{mbCtmsStudy.selectedEntity.name}" title="#{mbCtmsStudy.selectedEntity.title}" />

                    <!-- Filename -->
                    <h:outputLabel value="#{msg.studyDoc_filename}:" />
                    <h:outputText value="#{mbStudyDoc.selectedEntity.filename}" />

                    <!-- Doc Type -->
                    <h:outputLabel value="#{msg.studyDoc_type}:" />
                    <h:outputText value="#{mbStudyDoc.selectedEntity.docType.name}" />

                    <!-- Display name -->
                    <h:outputLabel value="#{msg.studyDoc_displayname}:" />
                    <h:outputText value="#{mbStudyDoc.selectedEntity.displayname}" />

                    <!-- Description -->
                    <h:outputLabel value="#{msg.studyDoc_description}:" />
                    <h:outputText value="#{mbStudyDoc.selectedEntity.description}" />

                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_delete}"
                                update=":form:tabView:dtEntities, :form:tabView:dtStudyDocs, :growl"
                                icon="ui-icon-trash"
                                oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDeleteStudyDoc','deleteStudyDocForm');"
                                actionListener="#{mbCtmsStudy.doRemoveSelectedStudyDoc(mbStudyDoc.selectedEntity)}"
                                process="@this deleteStudyDocForm"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Submit from dialog -->
        <script type="text/javascript">
            function handleSubmitRequest(xhr, status, args, dialogName, formName) {
                dialog = jQuery('#'+dialogName);
                if(args.validationFailed) {
                    dialog.effect("shake", { times:3 }, 100);
                } else {
                    clearForm(formName);
                    PF('newEntityDialog').hide();
                    PF('editEntityDialog').hide();
                    PF('deleteEntityDialog').hide();

                    PF('newTumourEntityDialog').hide();
                    PF('deleteTumourEntityDialog').hide();

                    PF('newTimeLineEventDialog').hide();
                    PF('editTimeLineEventDialog').hide();
                    PF('deleteTimeLineEventDialog').hide();

                    PF('newStudyPersonDialog').hide();
                    PF('editStudyPersonDialog').hide();
                    PF('deleteStudyPersonDialog').hide();

                    PF('newStudyOrganisationDialog').hide();
                    PF('deleteStudyOrganisationDialog').hide();

                    PF('newArmDialog').hide();
                    PF('editArmDialog').hide();
                    PF('deleteArmDialog').hide();

                    PF('newSiteDialog').hide();
                    PF('deleteSiteDialog').hide();

                    PF('newCriterionDialog').hide();
                    PF('editCriterionDialog').hide();
                    PF('deleteCriterionDialog').hide();

                    PF('newStudyDocDialog').hide();
                    PF('deleteStudyDocDialog').hide();
                }
            }
            function clearForm(formName) {
                jQuery('#'+formName).each(function(){
                    this.reset();
                });
            }
        </script>
    </ui:define>
</ui:composition>