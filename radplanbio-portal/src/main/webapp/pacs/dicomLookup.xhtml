<?xml version="1.0" encoding="UTF-8" ?>

<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:p="http://primefaces.org/ui"
        xmlns:o="http://omnifaces.org/ui"
        template="/WEB-INF/layouts/main.xhtml"
>

    <!-- Metadata -->
    <ui:define name="metadata">
        <f:metadata>
            <f:event type="preRenderView" listener="#{mbDicomLookup.onLoad}"/>
        </f:metadata>
    </ui:define>

    <!-- Definition of breadcrumbs place holder -->
    <ui:define name="breadcrumbs">
        <p:breadCrumb>
            <p:menuitem value="#{msg.home}" title="#{msg.home}" url="/home.faces"/>
            <p:menuitem value="PACS" title="PACS - medical imaging" url="#"/>
            <p:menuitem value="DICOM Lookup" title="DICOM Lookup" url="/pacs/dicomLookup.faces"/>
        </p:breadCrumb>
    </ui:define>

    <!-- Definition of the page content place holder -->
    <ui:define name="content">

        <!-- Constants -->
        <p:importConstants type="de.dktk.dd.rpb.core.util.Constants" var="Constants"/>

        <p:tabView id="tabView">
            <!-- Show empty page when no DICOM data collection in active study -->
            <p:tab title="DICOM #{msg.subject} Lookup" rendered="#{!mbDicomLookup.collectsDicomData()}"/>
            <!-- Otherwise show the lookup GUI -->
            <p:tab title="DICOM #{msg.subject} Lookup"
                   rendered="#{mbDicomLookup.collectsDicomData()}"
            >
                <p:panelGrid
                        columns="1"
                        style="width: 100%"
                >
                    <!-- Query Panel -->
                    <p:accordionPanel id="pnlSearch" multiple="true" activeIndex="0">
                        <p:tab title="#{msg.search_select_one}">
                            <p:panelGrid
                                    id="pnlSearchCriteria"
                                    columnClasses="column"
                                    columns="2"
                            >
                                <p:outputLabel value="#{msg.studySubject}: " for="ddlStudySubjects"/>
                                <p:autoComplete
                                        id="ddlStudySubjects"
                                        value="#{mbDicomLookup.inputStudySubject}"
                                        completeMethod="#{mbDicomLookup.filterMatchingStudySubjects}"
                                        var="studySubject"
                                        itemLabel="#{studySubject.studySubjectId}"
                                        itemValue="#{studySubject}"
                                        inputStyle="width:300px"
                                        dropdown="true"
                                        maxResults="#{mbDicomLookup.maxSubjectsPerSearch}"
                                        moreText="There are more results."
                                >
                                    <p:ajax
                                            event="itemSelect"
                                            listener="#{mbDicomLookup.searchDicomDataByStudySubjectId}"
                                            update="form:tabView:dtPacsResults,growl,form:tabView:reloadButtonDtPacsResults"/>
                                    <o:converter converterId="omnifaces.ListConverter"
                                                 list="#{mbDicomLookup.studySubjectsList}"/>
                                    <p:column headerText="#{msg.studySubject_studySubjectId}">
                                        <h:outputText value="#{studySubject.studySubjectId}"/>
                                    </p:column>
                                    <p:column headerText="#{msg.studySubject_personId}">
                                        <h:outputText
                                                value="[#{studySubject.pid}]"
                                                style="font-family:consolas, courier new,monospace;float: left;"
                                        />
                                    </p:column>
                                    <p:column headerText="#{msg.studySubject_gender}">
                                        <h:outputText value="#{studySubject.sex}"/>
                                    </p:column>
                                </p:autoComplete>
                            </p:panelGrid>

                        </p:tab>
                        <p:tab title="#{msg.search_select_many}">
                            <p:panelGrid
                                    id="pnlBulkSearch"
                                    columnClasses="column"
                                    columns="2"
                            >
                                <p:outputLabel value="#{msg.studySubject}: " for="ddlStudySubjectList"/>
                                <p:inputTextarea id="ddlStudySubjectList"
                                                 value="#{mbDicomLookup.inputStudySubjectBulkString}"
                                                 rows="6"
                                                 cols="50"
                                                 autoResize="false"
                                >
                                </p:inputTextarea>
                                <f:facet name="footer">
                                    <p:commandButton
                                            id="searchSubjectsFromBulkTextButton"
                                            title="#{msg.icon_search}"
                                            value="#{msg.icon_search}"
                                            action="#{mbDicomLookup.searchDicomDataFromBulkTextWithPids}"
                                            icon="ui-icon-search"
                                            ajax="true"
                                            update="form:tabView:dtPacsResults,growl,form:tabView:reloadButtonDtPacsResults"
                                    />
                                </f:facet>
                            </p:panelGrid>

                        </p:tab>
                        <p:tab
                                title="#{msg.study} #{msg.person_patient_plural} #{msg.menu_search}"
                                rendered="#{mbDicomLookup.isInStudyZero()}"
                        >
                            <p:panelGrid
                                    id="pnlBulkSearchStudyZero"
                                    columnClasses="column"
                                    columns="2"

                            >
                                <h:outputLabel value="#{msg.study}:"/>

                                <p:selectOneMenu
                                        id="selectOneMenuStudyZeroBulkSearch"
                                        value="#{mbDicomLookup.selectedEdcStudy}"
                                        converter="omnifaces.SelectItemsConverter"
                                        filter="true"
                                        filterMatchMode="contains"
                                        var="edcStudy"
                                        style="width:400px"

                                >
                                    <!-- Items -->
                                    <f:selectItem itemLabel="#{msg.search_select_one}"
                                                  itemValue=""
                                                  noSelectionOption="true"
                                    />
                                    <f:selectItems
                                            value="#{mbDicomLookup.getAllEdcStudySitesExceptStudyZero()}"
                                            itemLabel="#{study.getOcStudyName()}"
                                            itemValue="#{study}"
                                            var="study"
                                    />
                                    <p:column headerText="#{msg.study_name}">
                                        <h:outputText value="#{edcStudy.getOcStudyName()}" title="#{edcStudy.oid}"/>
                                    </p:column>
                                    <p:column headerText="#{msg.study_partnerSites}">
                                        <h:outputText value="#{edcStudy.getOcSiteName()}" title="#{edcStudy.oid}"/>
                                    </p:column>
                                    <p:column headerText="#{msg.study_edcIdentifier }">
                                        <h:outputText value="#{edcStudy.uniqueIdentifier}" title="#{edcStudy.oid}"/>
                                    </p:column>

                                    <!-- AJAX update of studies datatable -->
                                    <p:ajax
                                            event="itemSelect"
                                            listener="#{mbDicomLookup.searchStudySpecificSubjects()}"
                                            update="form:tabView:dtPacsResults,growl,form:tabView:reloadButtonDtPacsResults"
                                    />

                                </p:selectOneMenu>
                            </p:panelGrid>
                        </p:tab>
                    </p:accordionPanel>

                </p:panelGrid>

                <p:blockUI block="tabView" trigger="form:tabView:pnlSearch:ddlStudySubjects">
                    #{msg.loading}<br/>
                    <p:graphicImage name="icons/ajaxloading.gif"/>
                </p:blockUI>

                <p:blockUI block="tabView" trigger="form:tabView:pnlSearch:selectOneMenuStudyZeroBulkSearch">
                    #{msg.loading}<br/>
                    <p:graphicImage name="icons/ajaxloading.gif"/>
                </p:blockUI>
                <p:blockUI block="tabView" trigger="form:tabView:pnlSearch:searchSubjectsFromBulkTextButton">
                    #{msg.loading}<br/>
                    <p:graphicImage name="icons/ajaxloading.gif"/>
                </p:blockUI>
                <p:blockUI block="tabView" trigger="form:tabView:reloadButtonDtPacsResults">
                    #{msg.loading}<br/>
                    <p:graphicImage name="icons/ajaxloading.gif"/>
                </p:blockUI>
                <p:toolbar>
                    <p:toolbarGroup align="left">
                        <p:commandButton
                                id="reloadButtonDtPacsResults"
                                value="#{msg.menu_reload}"
                                title="#{msg.subject_reload}"
                                icon="ui-icon-refresh"
                                style="float: left;"
                                ajax="true"
                                action="#{mbDicomLookup.searchDicomDataByStudySubjectList}"
                                update="dtPacsResults"
                                disabled="#{mbDicomLookup.getResultSubjectList() == null}"
                        />
                    </p:toolbarGroup>
                    <p:toolbarGroup align="right">
                        <p:commandButton
                                id="dtPacsResultTogglerButton"
                                value="#{msg.menu_columns}"
                                icon="ui-icon-calculator"
                        />
                        <p:commandButton
                                id="dtPacsResultPrint"
                                value="#{msg.menu_print}"
                                title="#{msg.subject_print}"
                                icon="ui-icon-print"
                        >
                            <p:printer target="dtPacsResults"/>
                        </p:commandButton>
                        <p:commandButton
                                id="dtPacsResultHelp"
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                onclick="target='_blank'"
                                ajax="false"
                                immediate="true"
                                action="#{mbMain.navigateToHelp('x1-240003')}"
                        />
                        <p:columnToggler
                                id="dtPacsResultColumnToggler"
                                datasource="dtPacsResults"
                                trigger="dtPacsResultTogglerButton">
                            <p:ajax
                                    event="toggle"
                                    listener="#{mbDicomLookup.onEntityToggle}"
                                    update="dtPacsResults"
                            />
                        </p:columnToggler>

                    </p:toolbarGroup>
                </p:toolbar>
                <p:dataTable
                        id="dtPacsResults"
                        var="subject"
                        value="#{mbDicomLookup.stagedSubjects}"
                        widgetVar="packsResultTable"
                        resizableColumns="true"
                        draggableColumns="false"
                        liveResize="true"
                        paginator="true"
                        paginatorAlwaysVisible="false"
                        rows="15"
                        rowsPerPageTemplate="15,25,50"
                        emptyMessage="#{msg.search_empty}"
                        rowKey="#{subject.uniqueIdentifier}"
                        rowIndexVar="rowIndex"
                        sortMode="multiple"
                        sortBy="#{mbDicomLookup.preSortOrder}"
                        ajax="true"
                >
                    <p:column style="width:10px"
                              exportable="false"
                              filterable="false"
                              toggleable="false"
                    >
                        <p:rowToggler/>
                    </p:column>
                    <p:column headerText="#"
                              exportable="false"
                              toggleable="false"
                              style="width:10px">
                        <h:outputText
                                value="#{rowIndex + 1}"
                                style="float: left;"
                        />
                    </p:column>
                    <p:column
                            id="colSubjectUid"
                            headerText="#{msg.subject_uniqueIdentifier}"
                            sortBy="#{subject.uniqueIdentifier}"
                            filterBy="#{subject.uniqueIdentifier}"
                            visible="#{mbDicomLookup.columnVisibilityList[1]}"
                    >
                        <h:outputText
                                style="font-family:consolas, courier new,monospace;float: left;"
                                value="#{subject.uniqueIdentifier}"/>
                    </p:column>
                    <p:column
                            headerText="#{msg.subject_studySubjectId}"
                            sortBy="#{subject.studySubjectId}"
                            filterBy="#{subject.studySubjectId}"
                            visible='#{mbDicomLookup.columnVisibilityList[2]}'
                    >
                        <h:outputText
                                style="float: left;"
                                value="#{subject.studySubjectId}"
                        />
                    </p:column>
                    <p:column
                            headerText="#{msg.subject_secondaryId}"
                            sortBy="#{subject.secondaryId}"
                            filterBy="#{subject.secondaryId}"
                            visible="#{mbDicomLookup.columnVisibilityList[3]}"
                    >
                        <h:outputText
                                value="#{subject.secondaryId}"
                                style="float: left;"
                        />
                    </p:column>
                    <p:column
                            headerText="#{msg.subject_gender}"
                            sortBy="#{subject.gender}"
                            filterBy="#{subject.gender}"
                            filterMatchMode="in"
                            visible="#{mbDicomLookup.columnVisibilityList[4]}"
                    >
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                    label="Options"
                                    onchange="PF('packsResultTable').filter()"
                                    panelStyle="width:50px"
                                    scrollHeight="50"
                            >
                                <f:selectItem itemLabel="m" itemValue="m"/>
                                <f:selectItem itemLabel="f" itemValue="f"/>
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText
                                value="#{subject.gender}"
                        />
                    </p:column>
                    <p:column
                            headerText="#{msg.subject_enrollmentDate}"
                            sortBy="#{subject.comparableEnrollmentDate}"
                            filterBy="#{subject.getEnrollmentDateString()}"
                            filterMatchMode="contains"
                            visible='#{mbDicomLookup.columnVisibilityList[5]}'
                    >
                        <h:outputText
                                value="#{subject.getEnrollmentDateString()}"
                        >
                        </h:outputText>
                    </p:column>

                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}"
                                      rendered="#{mbDicomLookup.stagedSubjects.size() == 0}"/>
                        <h:outputText value="#{msg.search_results_status_1}"
                                      rendered="#{mbDicomLookup.stagedSubjects.size() == 1}"/>
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbDicomLookup.stagedSubjects.size() > 1}"
                        >
                            <f:param value="#{mbDicomLookup.stagedSubjects.size()}"/>
                        </h:outputFormat>
                    </f:facet>
                    <p:rowExpansion>
                        <p:toolbar>
                            <p:toolbarGroup
                                    style="float:right"
                            >
                                <p:commandButton
                                        id="dtPacsResultSubTableToggler"
                                        type="button"
                                        value="#{msg.menu_columns}"
                                        style="float:right"
                                        icon="ui-icon-calculator"/>
                                <p:columnToggler
                                        datasource="dtPacsResultsSubtable"
                                        trigger="dtPacsResultSubTableToggler"/>
                            </p:toolbarGroup>
                        </p:toolbar>
                        <p:dataTable
                                id="dtPacsResultsSubtable"
                                sortMode="multiple"
                                var="study"
                                value="#{subject.stagedStudies}"
                                widgetVar="packsResultSubTable"
                                resizableColumns="true"
                                liveResize="true"
                                paginator="true"
                                paginatorAlwaysVisible="false"
                                draggableColumns="false"
                                rows="15"
                                rowsPerPageTemplate="15,25,50"
                                emptyMessage="#{msg.search_empty}"
                                rowIndexVar="rowIndexSubTable"
                                ajax="true"
                        >
                            <f:facet name="header">
                            </f:facet>
                            <p:column headerText="#"
                                      exportable="false"
                                      toggleable="false"
                                      style="width:10px">
                                <h:outputText
                                        value="#{rowIndexSubTable + 1}"
                                        style="float: left;"
                                />
                            </p:column>
                            <p:column
                                    headerText="#{msg.clinical} #{msg.dicomStudy_studyInstanceUID}"
                                    sortBy="#{study.getClinicalStudyInstanceUid()}"
                                    filterBy="#{study.getClinicalStudyInstanceUid()}"
                                    visible="false"
                            >
                                <h:outputText
                                        style="float: left;"
                                        value="#{study.getClinicalStudyInstanceUid()}"
                                />
                            </p:column>
                            <p:column
                                    headerText="#{msg.stage_one} #{msg.dicomStudy_studyInstanceUID}"
                                    sortBy="#{study.getStageOneStudyInstanceUid()}"
                                    filterBy="#{study.getStageOneStudyInstanceUid()}"
                                    visible="false"
                            >
                                <h:outputText
                                        style="float: left;"
                                        value="#{study.getStageOneStudyInstanceUid()}"
                                />
                            </p:column>
                            <p:column
                                    headerText="#{msg.stage_two} #{msg.dicomStudy_studyInstanceUID}"
                                    sortBy="#{study.getStageTwoStudyInstanceUid()}"
                                    filterBy="#{study.getStageTwoStudyInstanceUid()}"
                                    visible="false"
                            >
                                <h:outputText
                                        style="float: left;"
                                        value="#{study.getStageTwoStudyInstanceUid()}"
                                />
                            </p:column>
                            <p:column
                                    headerText="#{msg.dicomStudy_modalities}"
                                    sortBy="#{study.modalitiesInStudy}"
                                    filterBy="#{study.modalitiesInStudy}"
                                    filterMatchMode="contains"
                            >
                                <h:outputText
                                        style="float: left"
                                        value="#{study.modalitiesInStudy}"
                                />
                            </p:column>
                            <p:column
                                    headerText="#{msg.dicomStudy_studyDescription}"
                                    sortBy="#{study.studyDescription}"
                                    filterBy="#{study.studyDescription}"
                            >
                                <h:outputText
                                        style="float: left"
                                        value="#{study.studyDescription}"
                                />
                            </p:column>
                            <p:column
                                    id="colDicomStudyDate"
                                    headerText="#{msg.dicomStudy_studyDate}"
                                    sortBy="#{study.getDateStudy()}"
                                    filterBy="#{study.getDateStudyString()}"
                                    filterMatchMode="contains"
                                    style="width:35px"
                            >
                                <h:outputText
                                        value="#{study.getDateStudyString()}"
                                >
                                </h:outputText>
                            </p:column>
                            <p:column
                                    id="stageOneRepresentationColumn"
                                    headerText="#{msg.stage_one}"
                                    sortBy="#{study.hasStageOneRepresentation()}"
                                    filterBy="#{study.hasStageOneRepresentation()}"
                                    visible="#{mbDicomLookup.getCurrentStudyEdcCode().equals(Constants.study0EdcCode)}"
                                    style="width:30px"
                            >
                                <f:facet name="filter">
                                    <p:selectOneMenu
                                            onchange="PF('packsResultSubTable').filter()"
                                            label="filter"
                                    >
                                        <f:converter converterId="javax.faces.Boolean"/>
                                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue=""/>
                                        <f:selectItem itemLabel="#{msg.yes}" itemValue="true"/>
                                        <f:selectItem itemLabel="#{msg.no}" itemValue="false"/>
                                    </p:selectOneMenu>
                                </f:facet>
                                <p:selectBooleanButton
                                        value="#{study.hasStageOneRepresentation()}"
                                        onLabel="#{msg.yes}"
                                        offLabel="#{msg.no}"
                                        onIcon="ui-icon-check"
                                        offIcon="ui-icon-close"
                                        disabled="true"
                                        style="width:60px"
                                />
                            </p:column>
                            <p:column
                                    headerText="#{msg.stage_two}"
                                    sortBy="#{study.hasStageTwoRepresentation()}"
                                    filterBy="#{study.hasStageTwoRepresentation()}"
                                    visible="#{!mbDicomLookup.getCurrentStudyEdcCode().equals(Constants.study0EdcCode)}"
                                    style="width:30px"
                            >
                                <f:facet name="filter">
                                    <p:selectOneMenu
                                            onchange="PF('packsResultSubTable').filter()"
                                            label="filter"
                                    >
                                        <f:converter converterId="javax.faces.Boolean"/>
                                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue=""/>
                                        <f:selectItem itemLabel="#{msg.yes}" itemValue="true"/>
                                        <f:selectItem itemLabel="#{msg.no}" itemValue="false"/>
                                    </p:selectOneMenu>
                                </f:facet>

                                <p:selectBooleanButton
                                        value="#{study.hasStageTwoRepresentation()}"
                                        onLabel="#{msg.yes}"
                                        offLabel="#{msg.no}"
                                        onIcon="ui-icon-check"
                                        offIcon="ui-icon-close"
                                        disabled="true"
                                        style="width:60px"
                                />
                            </p:column>
                            <p:column
                                    headerText="#{msg.menu_commands}"
                                    style="width:30px"
                                    exportable="false"
                                    filterable="false"
                                    toggleable="false"
                            >
                                <p:commandButton
                                        id="downloadStudyDataButton"
                                        icon="ui-icon-arrowthick-1-s"
                                        title="#{msg.menu_download}"
                                        action="#{mbDicomLookup.downloadDicomStudy()}"
                                        update=":growl"
                                        process="@this"
                                        immediate="true"
                                        ajax="false"
                                        disabled="#{!userContext.hasRole('ROLE_PACS_DOWNLOAD') or !study.isStaged()}"
                                >
                                    <f:setPropertyActionListener
                                            value="#{study}"
                                            target="#{mbDicomLookup.selectedDicomStudy}"
                                    />
                                    <f:setPropertyActionListener
                                            value="#{subject}"
                                            target="#{mbDicomLookup.selectedSubject}"/>
                                </p:commandButton>
                                <p:commandButton
                                        id="searchSeriesDataButton"
                                        icon="ui-icon-contact"
                                        title="#{msg.menu_edit}"
                                        action="#{mbDicomLookup.searchDicomSeriesOnPacs()}"
                                        oncomplete="PF('editEntityDialog').show();"
                                        update="dlgDicomStudyEdit"
                                        ajax="true"
                                >
                                    <f:setPropertyActionListener
                                            value="#{study}"
                                            target="#{mbDicomLookup.selectedDicomStudy}"
                                    />
                                    <f:setPropertyActionListener
                                            value="#{subject}"
                                            target="#{mbDicomLookup.selectedSubject}"/>
                                </p:commandButton>
                                <p:blockUI block="form:tabView" trigger="searchSeriesDataButton">
                                    #{msg.loading}<br/>
                                    <p:graphicImage name="icons/ajaxloading.gif"/>
                                </p:blockUI>
                            </p:column>
                            <f:facet name="footer">
                                <h:outputText value="#{msg.search_results_status_0}"
                                              rendered="#{subject.stagedStudies.size() == 0}"/>
                                <h:outputText value="#{msg.search_results_status_1}"
                                              rendered="#{subject.stagedStudies.size() == 1}"/>
                                <h:outputFormat
                                        value="#{msg.search_results_status_n}"
                                        rendered="#{subject.stagedStudies.size() > 1}"
                                >
                                    <f:param value="#{subject.stagedStudies.size()}"/>
                                </h:outputFormat>
                            </f:facet>
                        </p:dataTable>
                    </p:rowExpansion>
                </p:dataTable>
            </p:tab>
        </p:tabView>
    </ui:define>

    <!-- Definition of dialogs place holder -->
    <ui:define name="dialogs">
        <p:dialog
                id="dlgDicomStudyEdit"
                header="#{msg.dicomStudy_edit}"
                widgetVar="editEntityDialog"
                resizable="true"
                height="90%"
                width="70%"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                onHide="PF('editEntityDialogTabView').select(0)"
        >
            <p:ajax event="close" listener="#{mbDicomLookup.clearSelectedDicomSeries()}"/>
            <h:form id="dicomStagedSeriesDialogForm">

                <p:blockUI block="dicomStagedSeriesDialogForm"
                           widgetVar="dicomStagedSeriesDialogFormBlockUi"
                >
                    #{msg.loading}<br/>
                    <p:graphicImage name="icons/ajaxloading.gif"/>
                </p:blockUI>
                <p:panel style="width: auto; height: auto">
                    <p:panelGrid id="dicomStagedSeriesGrid">
                        <p:row>
                            <p:column>
                                <h:outputText value="#{msg.subject} #{msg.subject_uniqueIdentifier}:"/>
                            </p:column>
                            <p:column>
                                <h:outputText value="#{mbDicomLookup.selectedSubject.uniqueIdentifier}"/>
                            </p:column>

                        </p:row>
                        <p:row>
                            <p:column>
                                <h:outputText value="#{msg.dicomStudy} #{msg.dicomStudy_studyDescription}:"/>
                            </p:column>
                            <p:column>
                                <h:outputText value="#{mbDicomLookup.selectedDicomStudy.studyDescription}"/>
                            </p:column>
                        </p:row>
                        <p:row>
                            <p:column>
                                <h:outputText value="#{msg.dicomStudy} #{msg.dicomStudy_modalities}:"/>
                            </p:column>
                            <p:column>
                                <h:outputText value="#{mbDicomLookup.selectedDicomStudy.getStudyType()}"/>
                            </p:column>
                        </p:row>
                        <p:row>
                            <p:column>
                                <h:outputText value="#{msg.dicomStudy} #{msg.dicomStudy_studyDate}:"/>
                            </p:column>
                            <p:column>
                                <h:outputText value="#{mbDicomLookup.selectedDicomStudy.getDateStudy()}">
                                    <f:convertDateTime pattern="#{Constants.RPB_DATEFORMAT}"/>
                                </h:outputText>
                            </p:column>
                        </p:row>
                        <p:row rendered="#{mbDicomLookup.getCurrentStudyEdcCode().equals(Constants.study0EdcCode)}">
                            <p:column>
                                <h:outputText value="#{msg.clinical} #{msg.dicomStudy_studyInstanceUID}:"/>
                            </p:column>
                            <p:column>
                                <h:outputText value="#{mbDicomLookup.selectedDicomStudy.clinicalStudyInstanceUid}"/>
                            </p:column>
                        </p:row>
                        <p:row>
                            <p:column>
                                <h:outputText value="#{msg.stage_one} #{msg.dicomStudy_studyInstanceUID}:"/>
                            </p:column>
                            <p:column>
                                <h:outputText value="#{mbDicomLookup.selectedDicomStudy.stageOneStudyInstanceUid}"/>
                            </p:column>
                        </p:row>
                        <p:row rendered="#{!mbDicomLookup.getCurrentStudyEdcCode().equals(Constants.study0EdcCode)}">
                            <p:column>
                                <h:outputText value="#{msg.stage_two} #{msg.dicomStudy_studyInstanceUID}:"/>
                            </p:column>
                            <p:column>
                                <h:outputText value="#{mbDicomLookup.selectedDicomStudy.stageTwoStudyInstanceUid}"/>
                            </p:column>
                        </p:row>
                        <!-- Staging complete study is a bit too powerful - it is better to force users to do selection per series -->
                        <!-- otherwise it was observed that they grab unnecessary data  -->
                        <!--                        <p:row>-->
                        <!--                            <p:column>-->
                        <!--                                <h:outputText value="#{msg.menu_commands}:"/>-->
                        <!--                            </p:column>-->
                        <!--                            <p:column>-->
                        <!--                                <p:commandButton-->
                        <!--                                        id="stageCompleteDicomSeries"-->
                        <!--                                        icon="ui-icon-play"-->
                        <!--                                        value="#{msg.menu_stage} #{msg.dicomStudy}"-->
                        <!--                                        title="#{msg.menu_stage}"-->
                        <!--                                        action="#{mbDicomLookup.stageCompleteDicomStudy()}"-->
                        <!--                                        oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDicomStudyEdit','dicomStagedSeriesDialogForm');"-->
                        <!--                                        ajax="true"-->
                        <!--                                        style="float: left;"-->
                        <!--                                        disabled="#{!userContext.hasRole('ROLE_PACS_UPLOAD') || !mbDicomLookup.selectedStudyCanBeStaged() }"-->
                        <!--                                />-->
                        <!--                                <p:blockUI block="dicomStagedSeriesDialogForm" trigger="stageCompleteDicomSeries">-->
                        <!--                                    #{msg.loading}<br/><p:graphicImage name="icons/ajaxloading.gif"/>-->
                        <!--                                </p:blockUI>-->
                        <!--                            </p:column>-->
                        <!--                        </p:row>-->
                    </p:panelGrid>
                </p:panel>
                <p:tabView
                        id="dicomStagedSeriesDialogFormTabView"
                        dynamic="true"
                        cache="false"
                        widgetVar="editEntityDialogTabView"
                >
                    <p:ajax event="tabChange"
                            listener="#{mbDicomLookup.onDicomStagedSeriesDialogFormTabViewTabChange}"
                            onstart="PF('dicomStagedSeriesDialogFormBlockUi').show();"
                            oncomplete="PF('dicomStagedSeriesDialogFormBlockUi').hide();"
                    />

                    <p:tab title="Table View"
                           id="dicomStagedSeriesDialogFormTableTab"
                    >
                        <p:toolbar>
                            <f:facet name="right">
                                <p:commandButton
                                        id="DicomStudyDetailTableToggler"
                                        type="button"
                                        value="#{msg.menu_columns}"
                                        style="float:right"
                                        icon="ui-icon-calculator"/>
                                <p:columnToggler
                                        datasource="DicomStudyDetailTable"
                                        trigger="DicomStudyDetailTableToggler"/>
                            </f:facet>
                        </p:toolbar>
                        <p:dataTable
                                id="DicomStudyDetailTable"
                                var="dicomSeries"
                                value="#{mbDicomLookup.stagedDicomSeries}"
                                resizableColumns="true"
                                sortMode="multiple"
                                paginator="true"
                                paginatorAlwaysVisible="false"
                                draggableColumns="false"
                                rows="10"
                                rowsPerPageTemplate="10,20,50"
                                emptyMessage="#{msg.search_empty}"
                                rowIndexVar="rowIndexDicomSeriesDetailTable"
                                selection="#{mbDicomLookup.selectedDicomSeries}"
                                rowKey="#{dicomSeries.seriesInstanceUID}"
                                widgetVar="DicomStudyDetailTableWidget"
                                sortBy="#{mbDicomLookup.preSortOrder}"
                        >
                            <p:ajax event="rowSelectCheckbox" update="dicomStagedSeriesDialogForm"/>
                            <p:ajax event="rowUnselectCheckbox" update="dicomStagedSeriesDialogForm"/>
                            <p:ajax event="rowSelect" update="dicomStagedSeriesDialogForm"/>
                            <p:ajax event="toggleSelect" update="dicomStagedSeriesDialogForm"/>

                            <p:column
                                    selectionMode="multiple"
                                    exportable="false"
                                    toggleable="false"
                                    style="width:16px"
                            >
                            </p:column>
                            <p:column headerText="#"
                                      exportable="false"
                                      toggleable="false"
                                      style="width:16px">
                                <h:outputText
                                        value="#{rowIndexDicomSeriesDetailTable + 1}"
                                        style="float: left;"
                                />
                            </p:column>
                            <p:column
                                    id="seriesClinicalUidColumn"
                                    headerText="#{msg.clinical} #{msg.dicomSeries_seriesInstanceUID}"
                                    sortBy="#{dicomSeries.clinicalSeriesUid}"
                                    filterBy="#{dicomSeries.clinicalSeriesUid}"
                                    visible="false"
                            >
                                <h:outputText value="#{dicomSeries.clinicalSeriesUid}"
                                              style="float: left"
                                />
                            </p:column>
                            <p:column
                                    id="seriesStageOneUidColumn"
                                    headerText="#{msg.stage_one} #{msg.dicomSeries_seriesInstanceUID}"
                                    sortBy="#{dicomSeries.stageOneSeriesUid}"
                                    filterBy="#{dicomSeries.stageOneSeriesUid}"
                                    visible="false"
                            >
                                <h:outputText value="#{dicomSeries.stageOneSeriesUid}"
                                              style="float: left"
                                />
                            </p:column>
                            <p:column
                                    id="seriesStageTwoUidColumn"
                                    headerText="#{msg.stage_two} #{msg.dicomSeries_seriesInstanceUID}"
                                    sortBy="#{dicomSeries.stageTwoSeriesUid}"
                                    filterBy="#{dicomSeries.stageTwoSeriesUid}"
                                    visible="false"
                            >
                                <h:outputText value="#{dicomSeries.stageTwoSeriesUid}"
                                              style="float: left"
                                />
                            </p:column>

                            <p:column
                                    headerText="#{msg.dicomSeries_details}"
                                    style="width:25px"
                            >
                                <p:commandButton
                                        oncomplete="PF('selectedStagedSeriesDetailsOverlayTableView').show('#{component.clientId}')"
                                        update="dicomStagedSeriesDialogForm:dicomStagedSeriesDialogFormTabView"
                                        icon="ui-icon-info"
                                        title="#{msg.dicomSeries_dicomDetails}"
                                >

                                    <f:setPropertyActionListener
                                            value="#{dicomSeries}"
                                            target="#{mbDicomLookup.selectedStagedSeries}"
                                    />
                                </p:commandButton>
                            </p:column>
                            <p:column
                                    headerText="#{msg.dicomSeries_modality}"
                                    sortBy="#{dicomSeries.seriesModality}"
                                    filterBy="#{dicomSeries.seriesModality}"
                            >
                                <h:outputText
                                        value="#{dicomSeries.seriesModality}"
                                        style="float: left;"
                                />
                            </p:column>
                            <p:column
                                    headerText="#{msg.dicomSeries_seriesDescription}"
                                    sortBy="#{dicomSeries.seriesDescription}"
                                    filterBy="#{dicomSeries.seriesDescription}"
                            >
                                <h:outputText
                                        id="dicomStagedSeriesDialogFormTableSeriesDescriptionColumn"
                                        value="#{dicomSeries.seriesDescription}"
                                        style="float: left"
                                />
                                <p:tooltip
                                        for="dicomStagedSeriesDialogFormTableSeriesDescriptionColumn"
                                        value="#{dicomSeries.toolTipValue}"
                                >
                                </p:tooltip>
                            </p:column>
                            <p:column
                                    id="colDicomSeriesDate"
                                    headerText="#{msg.dicomSeries_seriesDate}"
                                    sortBy="#{dicomSeries.getDateSeriesString()}"
                                    filterBy="#{dicomSeries.getDateSeriesString()}"
                                    style="text-align:center;"
                            >
                                <h:outputText
                                        value="#{dicomSeries.getDateSeriesString()}"
                                >
                                </h:outputText>
                            </p:column>
                            <p:column
                                    headerText="#{msg.dicomSeries_seriesTime}"
                                    sortBy="#{dicomSeries.getTimeSeries()}"
                                    filterBy="#{dicomSeries.getTimeSeriesString()}"
                                    visible="false"
                            >
                                <h:outputText value="#{dicomSeries.getTimeSeriesString()}">
                                </h:outputText>
                            </p:column>
                            <p:column
                                    headerText="#{msg.stage_one}"
                                    sortBy="#{dicomSeries.isStageOneRepresentation()}"
                                    filterBy="#{dicomSeries.isStageOneRepresentation()}"
                                    visible="#{mbDicomLookup.getCurrentStudyEdcCode().equals(Constants.study0EdcCode)}"
                                    style="width:30px"
                            >
                                <f:facet name="filter">
                                    <p:selectOneMenu
                                            onchange="PF('DicomStudyDetailTableWidget').filter()"
                                            label="filter"
                                    >
                                        <f:converter converterId="javax.faces.Boolean"/>
                                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue=""/>
                                        <f:selectItem itemLabel="#{msg.yes}" itemValue="true"/>
                                        <f:selectItem itemLabel="#{msg.no}" itemValue="false"/>
                                    </p:selectOneMenu>
                                </f:facet>
                                <p:selectBooleanButton
                                        value="#{dicomSeries.isStageOneRepresentation()}"
                                        onLabel="#{msg.yes}"
                                        offLabel="#{msg.no}"
                                        onIcon="ui-icon-check"
                                        offIcon="ui-icon-close"
                                        disabled="true"
                                        style="width:60px"
                                />
                            </p:column>
                            <p:column
                                    headerText="#{msg.stage_two}"
                                    sortBy="#{dicomSeries.isStageTwoRepresentation()}"
                                    filterBy="#{dicomSeries.isStageTwoRepresentation()}"
                                    visible="#{!mbDicomLookup.getCurrentStudyEdcCode().equals(Constants.study0EdcCode)}"
                                    style="width:30px"
                            >
                                <f:facet name="filter">
                                    <p:selectOneMenu
                                            onchange="PF('DicomStudyDetailTableWidget').filter()"
                                            label="filter"
                                    >
                                        <f:converter converterId="javax.faces.Boolean"/>
                                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue=""/>
                                        <f:selectItem itemLabel="#{msg.yes}" itemValue="true"/>
                                        <f:selectItem itemLabel="#{msg.no}" itemValue="false"/>
                                    </p:selectOneMenu>
                                </f:facet>
                                <p:selectBooleanButton
                                        value="#{dicomSeries.isStageTwoRepresentation()}"
                                        onLabel="#{msg.yes}"
                                        offLabel="#{msg.no}"
                                        onIcon="ui-icon-check"
                                        offIcon="ui-icon-close"
                                        disabled="true"
                                        style="width:60px"
                                />
                            </p:column>
                            <p:column
                                    headerText="#{msg.menu_commands}"
                                    style="width:30px"
                                    exportable="false"
                                    filterable="false"
                                    toggleable="false"
                            >
                                <p:commandButton
                                        id="downloadSeriesDataButton"
                                        icon="ui-icon-arrowthick-1-s"
                                        title="#{msg.menu_download}"
                                        action="#{mbDicomLookup.downloadDicomSeries()}"
                                        update=":growl"
                                        process="@this"
                                        immediate="true"
                                        ajax="false"
                                        disabled="#{!userContext.hasRole('ROLE_PACS_DOWNLOAD') or !dicomSeries.isStaged() }"
                                >
                                    <f:setPropertyActionListener
                                            value="#{dicomSeries}"
                                            target="#{mbDicomLookup.selectedStagedDicomSeries}"
                                    />
                                </p:commandButton>
                            </p:column>

                            <f:facet name="footer">
                                <h:outputText value="#{msg.search_results_status_0}"
                                              rendered="#{mbDicomLookup.stagedDicomSeries.size() == 0}"/>
                                <h:outputText value="#{msg.search_results_status_1}"
                                              rendered="#{mbDicomLookup.stagedDicomSeries.size() == 1}"/>
                                <h:outputFormat
                                        value="#{msg.search_results_status_n}"
                                        rendered="#{mbDicomLookup.stagedDicomSeries.size() > 1}"
                                >
                                    <f:param value="#{mbDicomLookup.stagedDicomSeries.size()}"/>
                                </h:outputFormat>
                                <h:outputText
                                        value=" #{msg.select_one_item}"
                                        rendered="#{mbDicomLookup.selectedDicomSeries.size() == 1}"
                                        style="float: right"/>

                                <h:outputFormat
                                        value="  #{msg.select_multiple_items}"
                                        rendered="#{mbDicomLookup.selectedDicomSeries.size() > 1}"
                                        style="float: right"
                                >
                                    <f:param value="#{mbDicomLookup.selectedDicomSeries.size()}"/>
                                </h:outputFormat>
                            </f:facet>
                        </p:dataTable>
                        <p:toolbar id="dicomStagedSeriesDialogFormToolbar">
                            <f:facet name="left">
                                <p:commandButton
                                        id="stageSelectedDicomSerie"
                                        icon="ui-icon-play"
                                        value="#{msg.menu_stage} #{msg.dicomSeries_plural}"
                                        title="#{msg.menu_stage}"
                                        disabled="#{mbDicomLookup.selectedDicomSeries.size() == 0 || !userContext.hasRole('ROLE_PACS_UPLOAD') || !mbDicomLookup.selectedStudyCanBeStaged()}"
                                        action="#{mbDicomLookup.stageChosenDicomSeries()}"
                                        oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDicomStudyEdit','dicomStagedSeriesDialogForm');"
                                />
                                <p:blockUI block="dicomStagedSeriesDialogForm" trigger="stageSelectedDicomSerie">
                                    #{msg.loading}<br/>
                                    <p:graphicImage name="icons/ajaxloading.gif"/>
                                </p:blockUI>
                            </f:facet>
                        </p:toolbar>
                        <p:overlayPanel widgetVar="selectedStagedSeriesDetailsOverlayTableView"
                                        id="selectedStagedSeriesDetailsOverlayTableView"
                                        my="left top"
                                        showEffect="fade"
                                        hideEffect="fade"
                                        dismissable="false"
                                        showCloseIcon="true"
                        >
                            <p:panelGrid>
                                <f:facet name="header">
                                    <h:outputText
                                            style="text-align:center;"
                                            value="#{msg.dicomSeries_details}"/>
                                </f:facet>
                                <p:dataList value="#{mbDicomLookup.selectedStagedSeries.getDetailsList()}"
                                            var="detail"
                                            scrollable="true"
                                >
                                    #{detail}
                                </p:dataList>
                            </p:panelGrid>
                        </p:overlayPanel>
                    </p:tab>
                    <p:tab title="RT View"
                           id="dicomStagedSeriesDialogFormTreeTableTab"
                           scrollable="true"
                           rendered="#{mbDicomLookup.getDicomSeriesTree().getChildCount() > 0}"
                    >
                        <!--                        <p:toolbar>-->
                        <!--                            <f:facet name="right">-->
                        <!--                                <p:commandButton-->
                        <!--                                        id="DicomStagedSeriesDialogFormTreeTableToggler"-->
                        <!--                                        type="button"-->
                        <!--                                        value="#{msg.menu_columns}"-->
                        <!--                                        style="float:right"-->
                        <!--                                        icon="ui-icon-calculator"/>-->
                        <!--                                <p:columnToggler-->
                        <!--                                        datasource="dicomStagedSeriesDialogFormTreeTable"-->
                        <!--                                        trigger="DicomStagedSeriesDialogFormTreeTableToggler"/>-->
                        <!--                            </f:facet>-->
                        <!--                        </p:toolbar>-->

                        <p:accordionPanel id="updateRTView" multiple="true" activeIndex="false">
                            <p:tab title="#{msg.search_criteria }">
                                <p:panelGrid
                                        id="pnlSearchCriteria"
                                        columnClasses="column"
                                        columns="2"
                                >
                                    <p:selectCheckboxMenu
                                            id="selectModalitiesFilterCheckboxMenu"
                                            value="#{mbDicomLookup.queriedDicomSeriesModality }"
                                            label="Filtered Modalities RT View"
                                            multiple="true"
                                            showHeader="false"
                                            title="Queried Modalities"
                                            style="padding: 3px"
                                    >
                                        <f:selectItems value="#{mbDicomLookup.availableSeriesModalities }"/>
                                        <!--                                    <p:ajax-->
                                        <!--                                            event="change"-->
                                        <!--                                            listener="#{mbDicomLookup.updateSeriesTreeWithDetails()}"-->
                                        <!--                                            onstart="PF('dicomStagedSeriesDialogFormBlockUi').show();"-->
                                        <!--                                            oncomplete="PF('dicomStagedSeriesDialogFormBlockUi').hide();"-->
                                        <!--                                            update="dicomStagedSeriesDialogForm:dicomStagedSeriesDialogFormTabView"-->
                                        <!--                                    />-->
                                    </p:selectCheckboxMenu>
                                    <p:commandButton
                                            id="updateRTViewWithSelectedModalities"
                                            title="#{msg.menu_update }"
                                            value="#{msg.menu_update}"
                                            action="#{mbDicomLookup.updateSeriesTreeWithDetails()}"
                                            icon="ui-icon-refresh"
                                            ajax="true"
                                            update="dicomStagedSeriesDialogForm:dicomStagedSeriesDialogFormTabView"
                                            onstart="PF('dicomStagedSeriesDialogFormBlockUi').show();"
                                            oncomplete="PF('dicomStagedSeriesDialogFormBlockUi').hide();"
                                            style="padding: 3px"
                                    />
                                </p:panelGrid>
                            </p:tab>
                        </p:accordionPanel>
                        <p:treeTable
                                id="dicomStagedSeriesDialogFormTreeTable"
                                value="#{mbDicomLookup.dicomSeriesTree}"
                                selection="#{mbDicomLookup.selectedDicomSeriesNodes}"
                                selectionMode="checkbox"
                                widgetVar="DicomSeriesDetailTreeTable"
                                rowIndexVar="rowIndexDicomSeriesDetailTreeTable"
                                var="dicomSeries"
                                dynamic="true"
                                liveResize="true"
                                resizableColumns="true"
                                sortMode="multiple"
                                paginator="true"
                                paginatorAlwaysVisible="false"
                                draggableColumns="false"
                                rows="10"
                                rowsPerPageTemplate="10,20,50"
                                emptyMessage="#{msg.search_empty}"
                        >
                            <p:ajax
                                    event="select"
                                    update="dicomStagedSeriesDialogForm:dicomStagedSeriesDialogFormTabView:stageSelectedDicomSeriesTreeView"/>
                            <p:ajax event="unselect"
                                    update="growl,dicomStagedSeriesDialogForm:dicomStagedSeriesDialogFormTabView:stageSelectedDicomSeriesTreeView"/>
                            <p:column
                                    selectionMode="multiple"
                                    exportable="false"
                                    toggleable="false"
                                    style="width:75px"
                            ></p:column>
                            <!--                            <p:column-->
                            <!--                                    id="seriesClinicalUidTreeTableColumn"-->
                            <!--                                    headerText="#{msg.clinical} #{msg.dicomSeries_seriesInstanceUID}"-->
                            <!--                                    sortBy="#{dicomSeries.clinicalSeriesUid}"-->
                            <!--                                    filterBy="#{dicomSeries.clinicalSeriesUid}"-->
                            <!--                                    visible="false"-->
                            <!--                            >-->
                            <!--                                <h:outputText value="#{dicomSeries.clinicalSeriesUid}"-->
                            <!--                                              style="float: left"-->
                            <!--                                />-->
                            <!--                            </p:column>-->
                            <!--                            <p:column-->
                            <!--                                    id="seriesStageOneUidTreeTableColumn"-->
                            <!--                                    headerText="#{msg.stage_one} #{msg.dicomSeries_seriesInstanceUID}"-->
                            <!--                                    sortBy="#{dicomSeries.stageOneSeriesUid}"-->
                            <!--                                    filterBy="#{dicomSeries.stageOneSeriesUid}"-->
                            <!--                                    visible="false"-->
                            <!--                            >-->
                            <!--                                <h:outputText value="#{dicomSeries.stageOneSeriesUid}"-->
                            <!--                                              style="float: left"-->
                            <!--                                />-->
                            <!--                            </p:column>-->
                            <!--                            <p:column-->
                            <!--                                    id="seriesStageTwoUidTreeTableColumn"-->
                            <!--                                    headerText="#{msg.stage_two} #{msg.dicomSeries_seriesInstanceUID}"-->
                            <!--                                    sortBy="#{dicomSeries.stageTwoSeriesUid}"-->
                            <!--                                    filterBy="#{dicomSeries.stageTwoSeriesUid}"-->
                            <!--                                    visible="false"-->
                            <!--                            >-->
                            <!--                                <h:outputText value="#{dicomSeries.stageTwoSeriesUid}"-->
                            <!--                                              style="float: left"-->
                            <!--                                />-->
                            <!--                            </p:column>-->


                            <p:column
                                    headerText="#{msg.dicomSeries_details}"
                                    style="width:25px"
                            >
                                <p:commandButton
                                        oncomplete="PF('selectedStagedSeriesDetailsOverlay').show('#{component.clientId}')"
                                        update="dicomStagedSeriesDialogForm:dicomStagedSeriesDialogFormTabView"
                                        icon="ui-icon-info"
                                        title="#{msg.dicomSeries_dicomDetails}"
                                >

                                    <f:setPropertyActionListener
                                            value="#{dicomSeries}"
                                            target="#{mbDicomLookup.selectedStagedSeries}"
                                    />
                                </p:commandButton>
                            </p:column>
                            <p:column
                                    headerText="#{msg.dicomSeries_modality}"
                                    sortBy="#{dicomSeries.seriesModality}"
                                    filterBy="#{dicomSeries.seriesModality}"
                            >
                                <h:outputText
                                        value="#{dicomSeries.seriesModality}"
                                        style="float: left;"
                                />
                            </p:column>
                            <p:column
                                    headerText="#{msg.dicomSeries_seriesDescription}"
                                    sortBy="#{dicomSeries.seriesDescription}"
                                    filterBy="#{dicomSeries.seriesDescription}"
                            >
                                <h:outputText
                                        id="dicomStagedSeriesDialogFormTreeTableDescriptionColumn"
                                        value="#{dicomSeries.seriesDescription}"
                                        style="float: left">

                                </h:outputText>
                                <p:tooltip
                                        for="dicomStagedSeriesDialogFormTreeTableDescriptionColumn"
                                        value="#{dicomSeries.toolTipValue}"
                                >
                                </p:tooltip>

                            </p:column>
                            <p:column
                                    headerText="#{msg.dicomSeries_seriesTime}"
                                    sortBy="#{dicomSeries.getTimeSeries()}"
                                    filterBy="#{dicomSeries.getTimeSeriesString()}"
                                    rendered="false"
                            >
                                <h:outputText value="#{dicomSeries.getTimeSeriesString()}">
                                </h:outputText>
                            </p:column>
                            <p:column
                                    headerText="#{msg.dicomSeries_seriesDate}"
                                    sortBy="#{dicomSeries.getDateSeriesString()}"
                                    filterBy="#{dicomSeries.getDateSeriesString()}"
                                    style="text-align:center;"
                            >
                                <h:outputText
                                        value="#{dicomSeries.getDateSeriesString()}"
                                >
                                </h:outputText>
                            </p:column>
                            <p:column
                                    headerText="#{msg.stage_one}"
                                    rendered="#{mbDicomLookup.getCurrentStudyEdcCode().equals(Constants.study0EdcCode)}"
                                    style="text-align:center; width:30px"
                            >
                                <p:triStateCheckbox
                                        headerText="#{msg.stage_one}"
                                        visible="#{mbDicomLookup.getCurrentStudyEdcCode().equals(Constants.study0EdcCode)}"
                                        value="#{dicomSeries.stagingState}"
                                        disabled="true"
                                        stateOneTitle="#{msg.not_staged}  #{dicomSeries.stagedImagesToAvailableImagesCount()}"
                                        stateTwoTitle="#{msg.complete}  #{dicomSeries.stagedImagesToAvailableImagesCount()}"
                                        stateThreeTitle="#{msg.complete} #{dicomSeries.stagedImagesToAvailableImagesCount()}"
                                />

                            </p:column>
                            <p:column
                                    headerText="#{msg.stage_two}"
                                    rendered="#{!mbDicomLookup.getCurrentStudyEdcCode().equals(Constants.study0EdcCode)}"
                                    style="text-align:center; width:30px"
                            >
                                <p:triStateCheckbox
                                        headerText="#{msg.stage_two}"
                                        visible="#{!mbDicomLookup.getCurrentStudyEdcCode().equals(Constants.study0EdcCode)}"
                                        value="#{dicomSeries.stagingState}"
                                        disabled="true"
                                        stateOneTitle="#{msg.not_staged}  #{dicomSeries.stagedImagesToAvailableImagesCount()}"
                                        stateTwoTitle="#{msg.complete}  #{dicomSeries.stagedImagesToAvailableImagesCount()}"
                                        stateThreeTitle="#{msg.complete} #{dicomSeries.stagedImagesToAvailableImagesCount()}"
                                />

                            </p:column>

                            <p:column
                                    headerText="#{msg.menu_commands}"
                                    style="width:30px"
                                    exportable="false"
                                    filterable="false"
                                    toggleable="false"
                            >
                                <p:commandButton
                                        id="downloadSeriesDataButton2"
                                        icon="ui-icon-arrowthick-1-s"
                                        title="#{msg.menu_download}"
                                        action="#{mbDicomLookup.downloadDicomSeries()}"
                                        update=":growl"
                                        process="@this"
                                        immediate="true"
                                        ajax="false"
                                        disabled="#{!userContext.hasRole('ROLE_PACS_DOWNLOAD') or !dicomSeries.isStaged() }"
                                >
                                    <f:setPropertyActionListener
                                            value="#{dicomSeries}"
                                            target="#{mbDicomLookup.selectedStagedDicomSeries}"
                                    />
                                </p:commandButton>
                                <p:commandButton
                                        oncomplete="PF('regionsOfInterestOverlay').show('#{component.clientId}')"
                                        update="dicomStagedSeriesDialogForm:dicomStagedSeriesDialogFormTabView"
                                        icon="ui-icon-circle-zoomin"
                                        title="#{msg.dicomSeries_regions_of_interest}"
                                        rendered="#{dicomSeries.getRegionsOfInterestList().size() > 0}"
                                >

                                    <f:setPropertyActionListener value="#{dicomSeries}"
                                                                 target="#{mbDicomLookup.selectedStagedSeries}"/>
                                </p:commandButton>
                            </p:column>
                        </p:treeTable>


                        <p:toolbar id="dicomStagedSeriesDialogTreeViewFormToolbar">
                            <f:facet name="left">
                                <p:commandButton
                                        id="stageSelectedDicomSeriesTreeView"
                                        icon="ui-icon-play"
                                        value="#{msg.menu_stage} #{msg.dicomSeries_plural}"
                                        title="#{msg.menu_stage}"
                                        disabled="#{!mbDicomLookup.hasSelectedDicomSeriesNodes() || !userContext.hasRole('ROLE_PACS_UPLOAD') || !mbDicomLookup.selectedStudyCanBeStaged()}"
                                        action="#{mbDicomLookup.stageChosenDicomSeriesFromTreeView()}"
                                        oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDicomStudyEdit','dicomStagedSeriesDialogForm');"
                                />
                                <p:blockUI block="dicomStagedSeriesDialogForm"
                                           trigger="stageSelectedDicomSeriesTreeView">
                                    #{msg.loading}<br/>
                                    <p:graphicImage name="icons/ajaxloading.gif"/>
                                </p:blockUI>
                            </f:facet>
                        </p:toolbar>
                        <p:overlayPanel widgetVar="regionsOfInterestOverlay"
                                        id="regionsOfInterestOverlay"
                                        my="right top"
                                        showEffect="fade"
                                        hideEffect="fade"
                                        dismissable="false"
                                        showCloseIcon="true"
                        >
                            <p:panelGrid>
                                <f:facet name="header">
                                    <h:outputText
                                            style="text-align:center;"
                                            value="Regions of Interest"/>
                                </f:facet>
                                <p:dataList value="#{mbDicomLookup.selectedStagedSeries.getRegionsOfInterestList()}"
                                            var="region"
                                            scrollable="true"
                                >
                                    #{region}
                                </p:dataList>
                            </p:panelGrid>

                        </p:overlayPanel>
                        <p:overlayPanel widgetVar="selectedStagedSeriesDetailsOverlay"
                                        id="selectedStagedSeriesDetailsOverlay"
                                        my="left top"
                                        showEffect="fade"
                                        hideEffect="fade"
                                        dismissable="false"
                                        showCloseIcon="true"
                        >
                            <p:panelGrid>
                                <f:facet name="header">
                                    <h:outputText
                                            style="text-align:center;"
                                            value="#{msg.dicomSeries_details}"/>
                                </f:facet>
                                <p:dataList value="#{mbDicomLookup.selectedStagedSeries.getDetailsList()}"
                                            var="detail"
                                            scrollable="true"
                                >
                                    #{detail}
                                </p:dataList>
                            </p:panelGrid>

                        </p:overlayPanel>
                    </p:tab>
                </p:tabView>
            </h:form>
        </p:dialog>

        <!-- Submit from dialog -->
        <script type="text/javascript">
            function handleSubmitRequest(xhr, status, args, dialogName, formName) {
                var dialog = jQuery('#' + dialogName);
                if (args.validationFailed) {
                    dialog.effect("shake", {times: 3}, 100);
                } else {
                    clearForm(formName);

                    PF('editEntityDialog').hide();
                }
            }

            function clearForm(formName) {
                jQuery('#' + formName).each(function () {
                    this.reset();
                });
            }
        </script>

    </ui:define>

</ui:composition>