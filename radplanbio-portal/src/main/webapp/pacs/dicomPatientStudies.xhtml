<?xml version="1.0" encoding="UTF-8" ?>

<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:p="http://primefaces.org/ui"
        template="/WEB-INF/layouts/main.xhtml"
>

    <!-- Definition of breadcrumbs place holder -->
    <ui:define name="breadcrumbs">
        <p:breadCrumb>
            <p:menuitem value="#{msg.home}" title="#{msg.home}" url="/home.faces"/>
            <p:menuitem value="#{msg.pacs}" title="#{msg.pacs} - medical imaging" url="#"/>
            <p:menuitem value="DICOM #{msg.study_plural}" title="DICOM #{msg.study_plural}"
                        url="/pacs/dicomPatientStudies.faces"/>
        </p:breadCrumb>
    </ui:define>

    <!-- Definition of the page content place holder -->
    <ui:define name="content">

        <!-- RPB Study DICOM data -->
        <p:tabView id="tabView" activeIndex="#{mbDicomStudies.tab.activeIndex}">
            <!-- DICOM Study Subjects -->
            <p:tab title="#{msg.studySubject_plural}">

                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Left -->
                    <p:toolbarGroup align="left">

                        <!-- Reload -->
                        <p:commandButton
                                id="reloadDicomSubjectsButton"
                                value="#{msg.menu_reload}"
                                title="#{msg.studySubject_reload}"
                                icon="ui-icon-refresh"
                                action="#{mbDicomStudies.load}"
                                ajax="true"
                                update=":form:tabView:dtDicomSubjects, :growl"
                        />
                        <p:blockUI block="form:tabView" trigger="form:tabView:reloadDicomSubjectsButton">
                            Processing<br/><p:graphicImage name="icons/ajaxloading.gif"/>
                        </p:blockUI>
                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                                value="#{msg.menu_print}"
                                title="#{msg.studySubject_print}"
                                icon="ui-icon-print"
                        >
                            <p:printer target="dtDicomSubjects"/>
                        </p:commandButton>
                        <p:commandButton
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                onclick="target='_blank'"
                                ajax="false"
                                immediate="true"
                                action="#{mbMain.navigateToHelp('x1-240003')}"
                        />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- DICOM Study Subjects -->
                <p:dataTable
                        id="dtDicomSubjects"
                        var="subject"
                        value="#{mbDicomStudies.entityList}"
                        widgetVar="studySubjectsTable"
                        resizableColumns="true"
                        paginator="true"
                        draggableColumns="false"
                        rows="15"
                        rowsPerPageTemplate="15,25,50"
                        emptyMessage="#{msg.search_empty}"
                        filteredValue="#{mbDicomStudies.filteredEntities}"
                        selection="#{mbDicomStudies.selectedEntity}"
                        selectionMode="single"
                        rowKey="#{subject.studySubjectId}"
                        rowIndexVar="rowIndex"
                        sortMode="multiple"
                        sortBy="#{mbDicomStudies.preSortOrder}"
                        disabledTextSelection="false"
                >

                    <!--AJAX onclick on datatable row -->
                    <p:ajax event="rowSelect"
                            listener="#{mbDicomStudies.loadSelectedSubjectDetails()}"
                            update=":form:tabView:dtStudyEvents, :form:tabView:dtDicomStudies, :growl"/>
                    <!-- Table header -->
                    <f:facet name="header">
                        <p:commandButton id="btnEntitiesToggler" value="#{msg.menu_columns}" style="float:right"
                                         icon="ui-icon-calculator"/>
                        <p:columnToggler datasource="dtDicomSubjects"
                                         trigger=":form:tabView:dtDicomSubjects:btnEntitiesToggler">
                            <p:ajax event="toggle" listener="#{mbDicomStudies.onEntityToggle}"/>
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false">
                        <h:outputText value="#{rowIndex + 1}"/>
                    </p:column>

                    <!-- StudySubject ID -->
                    <p:column
                            id="colStudySubjectId"
                            headerText="#{msg.studySubject_studySubjectId}"
                            sortBy="#{subject.studySubjectId}"
                            filterBy="#{subject.studySubjectId}"
                            visible="#{mbDicomStudies.columnVisibilityList[0]}"
                    >
                        <h:outputText value="#{subject.studySubjectId}" style="float: left;"/>
                    </p:column>

                    <!-- PID -->
                    <p:column
                            headerText="#{msg.studySubject_personId}"
                            sortBy="#{subject.pid}"
                            filterBy="#{subject.pid}"
                            visible="#{mbDicomStudies.columnVisibilityList[1]}"
                    >
                        <h:outputText style="font-family:consolas, courier new,monospace;float: left;"
                                      value="#{subject.pid}"/>
                    </p:column>

                    <!-- Secondary ID -->
                    <p:column
                            headerText="#{msg.studySubject_secondaryId}"
                            sortBy="#{subject.secondaryId}"
                            filterBy="#{subject.secondaryId}"
                            visible="#{mbDicomStudies.columnVisibilityList[2]}"
                    >
                        <h:outputText value="#{subject.secondaryId}" style="float: left;"/>
                    </p:column>

                    <!-- Gender -->
                    <p:column
                            headerText="#{msg.studySubject_gender}"
                            sortBy="#{subject.sex}"
                            filterBy="#{subject.sex}"
                            filterMatchMode="in"
                            visible="#{mbDicomStudies.columnVisibilityList[3]}"
                    >
                        <f:facet name="filter">
                            <p:selectCheckboxMenu
                                    label="Options"
                                    onchange="PF('studySubjectsTable').filter()"
                                    panelStyle="width:50px"
                                    scrollHeight="50"
                            >
                                <f:selectItem itemLabel="m" itemValue="m"/>
                                <f:selectItem itemLabel="f" itemValue="f"/>
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{subject.sex}"/>
                    </p:column>

                    <!-- Enrollment Date -->
                    <p:column
                            headerText="#{msg.studySubject_enrollmentDate}"
                            sortBy="#{subject.dateEnrollment}"
                            filterBy="#{subject.dateEnrollmentString}"
                            filterMatchMode="contains"
                            visible="#{mbDicomStudies.columnVisibilityList[4]}"
                    >
                        <h:outputText value="#{subject.dateEnrollmentString}"/>
                    </p:column>

                    <!-- Commands -->
                    <p:column
                            headerText="#{msg.menu_commands}"
                            exportable="false"
                            toggleable="false"
                    >
                        <!-- Redirect -->
                        <p:commandButton
                                title="#{msg.person_patient} Lookup"
                                icon="ui-icon-arrowthick-1-e"
                                immediate="true"
                                process="@this"
                                actionListener="#{mbMain.redirectToPid(subject)}"
                                update=":growl"
                                disabled="!#{userContext.hasRole('ROLE_PID_USER')}"
                        />
                    </p:column>

                    <!-- Footer -->
                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}"
                                      rendered="#{mbDicomStudies.entityList.size() == 0}"/>
                        <h:outputText value="#{msg.search_results_status_1}"
                                      rendered="#{mbDicomStudies.entityList.size() == 1}"/>
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbDicomStudies.entityList.size() > 1}"
                        >
                            <f:param value="#{mbDicomStudies.entityList.size()}"/>
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>
                <p:blockUI block="form:tabView"
                           trigger="form:tabView:dtDicomSubjects"
                >
                    Processing<br/><p:graphicImage name="icons/ajaxloading.gif"/>
                </p:blockUI>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto;">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtDicomSubjects" fileName="#{msg.studySubject_plural}"/>
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtDicomSubjects" fileName="#{msg.studySubject_plural}"/>
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- DICOM Study Events -->
            <p:tab title="#{msg.studyEvent_plural}">

                <!-- Toolbar -->
                <p:toolbar>

                    <!-- Left -->
                    <p:toolbarGroup align="left">

                        <!-- Reload -->
                        <p:commandButton
                                id="reloadSubjectEventsButton"
                                value="#{msg.menu_reload}"
                                title="#{msg.studyEvent_reload}"
                                icon="ui-icon-refresh"
                                style="float: left;"
                                immediate="true"
                                ajax="true"
                                action="#{mbDicomStudies.loadSelectedSubjectDetails}"
                                update=":form:tabView:dtStudyEvents, :growl, :dlgAssignDicomStudy"
                                oncomplete="PF('subjectEventsTable').filter()"
                        />
                        <p:blockUI block="form:tabView" trigger="form:tabView:reloadSubjectEventsButton">
                            Processing<br/><p:graphicImage name="icons/ajaxloading.gif"/>
                        </p:blockUI>
                    </p:toolbarGroup>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                                value="#{msg.menu_print}"
                                title="#{msg.studyEvent_print}"
                                icon="ui-icon-print"
                        >
                            <p:printer target="dtStudyEvents"/>
                        </p:commandButton>
                        <p:commandButton
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                onclick="target='_blank'"
                                ajax="false"
                                immediate="true"
                                action="#{mbMain.navigateToHelp('x1-240003')}"
                        />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- DICOM Subject Events -->
                <p:dataTable
                        id="dtStudyEvents"
                        var="event"
                        value="#{mbDicomStudies.selectedEntity.getEventOccurrencesForEvenDefs(mbDicomStudies.dicomEventDefinitions)}"
                        widgetVar="subjectEventsTable"
                        resizableColumns="true"
                        paginator="true"
                        draggableColumns="false"
                        rows="15"
                        rowsPerPageTemplate="15,25,50"
                        emptyMessage="#{msg.search_empty}"
                        filteredValue="#{mbStudyEvents.filteredEntities}"
                        selection="#{mbDicomStudies.selectedDicomEventData}"
                        selectionMode="single"
                        rowKey="#{event.studyEventOid}#{event.studyEventRepeatKey}"
                        rowIndexVar="rowIndex"
                        sortMode="multiple"
                        sortBy="#{mbStudyEvents.preSortOrder}"
                        disabledTextSelection="false"
                >

                    <!--AJAX onclick on datatable row -->
                    <p:ajax event="rowSelect" listener="#{mbDicomStudies.loadDicomStudies()}"
                            update=":form:tabView:dtDicomStudies, :growl, :dlgAssignDicomStudy"/>

                    <!-- Table header -->
                    <f:facet name="header">
                        <h:outputText
                                value="#{mbDicomStudies.selectedEntity.studySubjectId}-[#{mbDicomStudies.selectedEntity.pid}]"
                                style="float:left"/>
                        <p:commandButton id="btnEventsEntitiesToggler" value="#{msg.menu_columns}" style="float:right"
                                         icon="ui-icon-calculator"/>
                        <p:columnToggler datasource="dtStudyEvents"
                                         trigger=":form:tabView:dtStudyEvents:btnEventsEntitiesToggler">
                            <p:ajax event="toggle" listener="#{mbStudyEvents.onEntityToggle}"/>
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false">
                        <h:outputText value="#{rowIndex + 1}"/>
                    </p:column>

                    <!-- Study Event Name -->
                    <p:column
                            id="colEventName"
                            headerText="#{msg.studyEvent_name}"
                            sortBy="#{event.eventDefinition.name}"
                            filterBy="#{event.eventDefinition.name}"
                            visible="#{mbStudyEvents.columnVisibilityList[0]}"
                    >
                        <h:outputText value="#{event.eventDefinition.name}" style="float: left;"/>
                        <h:outputText
                                value="[#{event.studyEventRepeatKey}]"
                                rendered="#{event.eventDefinition.isRepeating}"
                                style="float: left;"
                        />
                    </p:column>

                    <!-- Study Event Description -->
                    <p:column
                            headerText="#{msg.studyEvent_description}"
                            sortBy="#{event.eventDefinition.description}"
                            visible="#{mbStudyEvents.columnVisibilityList[1]}"
                    >
                        <h:outputText value="#{event.eventDefinition.description}" style="float: left;"/>
                    </p:column>

                    <!-- Category -->
                    <p:column
                            headerText="#{msg.studyEvent_category}"
                            sortBy="#{event.eventDefinition.category}"
                            visible="#{mbStudyEvents.columnVisibilityList[2]}"
                    >
                        <h:outputText value="#{event.eventDefinition.category}" style="float: left;"/>
                    </p:column>

                    <!-- Type -->
                    <p:column
                            headerText="#{msg.studyEvent_type}"
                            sortBy="#{event.eventDefinition.type}"
                            visible="#{mbStudyEvents.columnVisibilityList[3]}"
                    >
                        <h:outputText value="#{event.eventDefinition.type}" style="float: left;"/>
                    </p:column>

                    <!-- Repeating -->
                    <p:column
                            headerText="#{msg.studyEvent_repeating}"
                            sortBy="#{event.eventDefinition.isRepeating}"
                            filterBy="#{event.eventDefinition.isRepeating}"
                            filterMatchMode="equals"
                            visible="#{mbStudyEvents.columnVisibilityList[4]}"
                    >
                        <f:facet name="filter">
                            <p:selectOneButton onchange="PF('subjectEventsTable').filter()">
                                <f:converter converterId="javax.faces.Boolean"/>
                                <f:selectItem itemLabel="#{msg.yes}" itemValue="true"/>
                                <f:selectItem itemLabel="#{msg.no}" itemValue="false"/>
                            </p:selectOneButton>
                        </f:facet>
                        <p:selectBooleanButton
                                value="#{event.eventDefinition.isRepeating}"
                                onLabel="#{msg.yes}"
                                offLabel="#{msg.no}"
                                onIcon="ui-icon-check"
                                offIcon="ui-icon-close"
                                disabled="true"
                        />
                    </p:column>

                    <!-- Start Date -->
                    <p:column
                            id="colEventStartDate"
                            headerText="#{msg.studyEvent_startDate}"
                            sortBy="#{event.comparableStartDate}"
                            filterBy="#{event.comparableStartDateString}"
                            visible="#{mbStudyEvents.columnVisibilityList[5]}"
                            filterMatchMode="contains"
                    >
                        <h:outputText value="#{event.comparableStartDateString}"/>
                    </p:column>

                    <!-- Status -->
                    <p:column
                            headerText="#{msg.studyEvent_status}"
                            sortBy="#{event.status}"
                            visible="#{mbStudyEvents.columnVisibilityList[6]}"
                    >
                        <h:outputText value="#{event.status}" style="float: left;"/>
                    </p:column>

                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}"
                                      rendered="#{mbDicomStudies.selectedEntity.getEventOccurrencesForEvenDefs(mbDicomStudies.dicomEventDefinitions).size() == 0}"/>
                        <h:outputText value="#{msg.search_results_status_1}"
                                      rendered="#{mbDicomStudies.selectedEntity.getEventOccurrencesForEvenDefs(mbDicomStudies.dicomEventDefinitions).size() == 1}"/>
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbDicomStudies.selectedEntity.getEventOccurrencesForEvenDefs(mbDicomStudies.dicomEventDefinitions).size() > 1}"
                        >
                            <f:param
                                    value="#{mbDicomStudies.selectedEntity.getEventOccurrencesForEvenDefs(mbDicomStudies.dicomEventDefinitions).size()}"/>
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <p:blockUI block="form:tabView"
                           trigger="form:tabView:dtStudyEvents"
                >
                    Processing<br/><p:graphicImage name="icons/ajaxloading.gif"/>
                </p:blockUI>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto;">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtStudyEvents" fileName="#{msg.studyEvent_plural}"/>
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtStudyEvents" fileName="#{msg.studyEvent_plural}"/>
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- DICOM Studies -->
            <p:tab title="DICOM">

                <!-- Toolbar -->
                <p:toolbar>
                    <!-- Left -->
                    <p:toolbarGroup align="left">
                        <!-- Reload -->
                        <p:commandButton
                                id="reloadDicomStudyButton"
                                value="#{msg.menu_reload}"
                                title="#{msg.menu_reload}"
                                icon="ui-icon-refresh"
                                action="#{mbDicomStudies.reloadDataFromEdcSystem()}"
                                ajax="true"
                                update=":form:tabView:dtDicomStudies, :growl"
                        />
                        <!-- Opens dialog for assigning Dicom study -->
                        <p:commandButton
                                id="assignDicomStudyButton"
                                value="#{msg.menu_new}"
                                title="#{msg.dicomStudy_new}"
                                icon="ui-icon-document"
                                style="float: left;"
                                immediate="true"
                                process="@this"
                                oncomplete="PF('assignDicomStudyDialog').show();"
                                update=":growl, :dlgAssignDicomStudy, :assignDicomStudyForm"
                                ajax="true"
                                disabled="#{!userContext.hasRole('ROLE_ADMIN')}"
                        />
                        <p:blockUI block="form:tabView" trigger="form:tabView:assignDicomStudyButton">
                            Processing<br/><p:graphicImage name="icons/ajaxloading.gif"/>
                        </p:blockUI>
                        <p:blockUI block="form:tabView" trigger="form:tabView:reloadDicomStudyButton">
                            Processing<br/><p:graphicImage name="icons/ajaxloading.gif"/>
                        </p:blockUI>
                    </p:toolbarGroup>

                    <!-- Rigth -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                                value="#{msg.menu_print}"
                                title="#{msg.dicomStudy_print}"
                                icon="ui-icon-print"
                        >
                            <p:printer target="dtDicomStudies"/>
                        </p:commandButton>
                        <p:commandButton
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                onclick="target='_blank'"
                                ajax="false"
                                immediate="true"
                                action="#{mbMain.navigateToHelp('x1-240003')}"
                        />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- DICOM studies -->
                <p:dataTable
                        id="dtDicomStudies"
                        var="study"
                        value="#{mbDicomStudies.dicomStudyList}"
                        widgetVar="studiesTable"
                        resizableColumns="true"
                        paginator="true"
                        draggableColumns="false"
                        liveResize="true"
                        rows="15"
                        rowsPerPageTemplate="15,25,50"
                        emptyMessage="#{msg.search_empty}"
                        selection="#{mbDicomStudy.selectedEntity}"
                        selectionMode="single"
                        rowKey="#{study.studyInstanceUID}"
                        rowIndexVar="rowIndex"
                        filteredValue="#{mbDicomStudy.filteredEntities}"
                        sortMode="multiple"
                        sortBy="#{mbDicomStudy.preSortOrder}"
                        disabledTextSelection="false"
                        style="width: auto;"
                >

                    <!-- Table header -->
                    <f:facet name="header">
                        <h:outputText
                                value="#{mbDicomStudies.selectedEntity.studySubjectId}-[#{mbDicomStudies.selectedEntity.pid}] / "
                                style="float:left"/>
                        <h:outputText value="#{mbDicomStudies.selectedDicomEventData.eventDefinition.name}"
                                      style="float: left;"/>
                        <h:outputText value="[#{mbDicomStudies.selectedDicomEventData.studyEventRepeatKey}]"
                                      rendered="#{mbDicomStudies.selectedDicomEventData.eventDefinition.isRepeating}"
                                      style="float: left;"/>
                        <p:commandButton id="btnDicomStudyEntitiesToggler" value="#{msg.menu_columns}"
                                         style="float:right" icon="ui-icon-calculator"/>
                        <p:columnToggler datasource="dtDicomStudies"
                                         trigger=":form:tabView:dtDicomStudies:btnDicomStudyEntitiesToggler">
                            <p:ajax event="toggle" listener="#{mbDicomStudy.onEntityToggle}"/>
                        </p:columnToggler>
                    </f:facet>

                    <!-- Row expansion -->
                    <p:column exportable="false" toggleable="false" filterable="false">
                        <p:rowToggler/>
                    </p:column>

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false">
                        <f:facet name="header">
                            <h:outputText value="#"/>
                        </f:facet>
                        <h:outputText value="#{rowIndex + 1}"/>
                    </p:column>

                    <!-- eCRF DICOM study label -->
                    <p:column
                            id="colDicomStudyLabel"
                            headerText="eCRF label"
                            sortBy="#{study.crfItemDefinition.label}"
                            filterBy="#{study.crfItemDefinition.label}"
                            filterMatchMode="contains"
                            visible="#{mbDicomStudies.dicomStudyColumnVisibilityList[0]}"
                    >
                        <h:outputText value="#{study.crfItemDefinition.label}" style="float: left;"/>
                    </p:column>

                    <!-- DICOM study description-->
                    <p:column
                            headerText="#{msg.dicomStudy_studyDescription}"
                            sortBy="#{study.studyDescription}"
                            visible="#{mbDicomStudies.dicomStudyColumnVisibilityList[1]}"
                    >
                        <h:outputText value="#{study.studyDescription}" style="float: left;"/>
                    </p:column>

                    <!-- DICOM study type deduced from series modalities -->
                    <p:column
                            headerText="#{msg.dicomStudy_modalities}"
                            sortBy="#{study.studyType}"
                            filterBy="#{study.studyType}"
                            filterMatchMode="contains"
                            visible="#{mbDicomStudies.dicomStudyColumnVisibilityList[2]}"
                    >
                        <h:outputText value="#{study.studyType}" style="float: left;"/>
                    </p:column>

                    <!-- Date -->
                    <p:column
                            headerText="#{msg.dicomStudy_studyDate}"
                            sortBy="#{study.dateStudy}"
                            filterBy="#{study.dateStudyString}"
                            filterMatchMode="contains"
                            visible="#{mbDicomStudies.dicomStudyColumnVisibilityList[3]}"
                    >
                        <h:outputText value="#{study.dateStudyString}"/>
                    </p:column>

                    <!-- DICOM study instace UID -->
                    <p:column
                            id="colDicomStudyUid"
                            headerText="#{msg.dicomStudy_studyInstanceUID}"
                            sortBy="#{study.studyInstanceUID}"
                            filterBy="#{study.studyInstanceUID}"
                            filterMatchMode="contains"
                            visible="#{mbDicomStudies.dicomStudyColumnVisibilityList[4]}"
                    >
                        <h:outputText value="#{study.studyInstanceUID}" style="float: left;"/>
                    </p:column>

                    <p:column
                            headerText="#{msg.menu_commands}"
                            exportable="false"
                            toggleable="false"
                    >

                        <!-- Download -->
                        <p:commandButton
                                title="#{msg.menu_download}"
                                icon="ui-icon-arrowthick-1-s"
                                update=":growl"
                                process="@this"
                                immediate="true"
                                ajax="false"
                                action="#{mbDicomStudies.downloadDicomStudy(mbDicomStudies.selectedEntity.pid, study.studyInstanceUID, study.studySeries.size())}"
                                disabled="#{!userContext.hasRole('ROLE_PACS_DOWNLOAD')}"
                        />

                    </p:column>

                    <!-- DicomSeries -->
                    <p:rowExpansion>

                        <p:dataTable
                                id="dtDicomSeries"
                                var="dicomSeries"
                                value="#{study.studySeries}"
                                widgetVar="dicomSeriesTable"
                                resizableColumns="true"
                                draggableColumns="false"
                                liveResize="true"
                                paginator="true"
                                rows="15"
                                rowsPerPageTemplate="15,25,50"
                                emptyMessage="#{msg.search_empty}"
                                selection="#{mbDicomSerie.selectedEntity}"
                                selectionMode="single"
                                rowKey="#{dicomSeries.seriesInstanceUID}"
                                rowIndexVar="subRowIndex"
                                filteredValue="#{mbDicomSerie.filteredEntities}"
                                sortMode="multiple"
                                sortBy="#{mbDicomSerie.preSortOrder}"
                                disabledTextSelection="false"
                        >

                            <!-- Table header -->
                            <f:facet name="header">
                                <p:commandButton id="btnDicomSeriesEntitiesToggler" value="#{msg.menu_columns}"
                                                 style="float:right" icon="ui-icon-calculator"/>
                                <p:columnToggler datasource="dtDicomSeries"
                                                 trigger=":form:tabView:dtDicomStudies:dtDicomSeries:btnDicomSeriesEntitiesToggler">
                                    <p:ajax event="toggle" listener="#{mbDicomSerie.onEntityToggle}"/>
                                </p:columnToggler>
                            </f:facet>

                            <!-- Row -->
                            <p:column headerText="#" toggleable="false" exportable="false">
                                <h:outputText value="#{subRowIndex + 1}"/>
                            </p:column>

                            <!-- SeriesInstance UID -->
                            <p:column
                                    id="colDicomSerieUid"
                                    headerText="#{msg.dicomSeries_seriesInstanceUID}"
                                    sortBy="#{dicomSeries.seriesInstanceUID}"
                                    filterBy="#{dicomSeries.seriesInstanceUID}"
                                    filterMatchMode="contains"
                                    visible="#{mbDicomSerie.columnVisibilityList[0]}"
                            >
                                <h:outputText value="#{dicomSeries.seriesInstanceUID}" style="float: left;"/>
                            </p:column>

                            <!-- Description -->
                            <p:column
                                    headerText="#{msg.dicomSeries_seriesDescription}"
                                    sortBy="#{dicomSeries.seriesDescription}"
                                    filterBy="#{dicomSeries.seriesDescription}"
                                    filterMatchMode="contains"
                                    visible="#{mbDicomSerie.columnVisibilityList[1]}"
                            >
                                <h:outputText value="#{dicomSeries.seriesDescription}" style="float: left;"/>
                            </p:column>

                            <!-- Modality -->
                            <p:column
                                    headerText="#{msg.dicomSeries_modality}"
                                    sortBy="#{dicomSeries.seriesModality}"
                                    filterBy="#{dicomSeries.seriesModality}"
                                    filterMatchMode="contains"
                                    visible="#{mbDicomSerie.columnVisibilityList[2]}"
                            >
                                <h:outputText value="#{dicomSeries.seriesModality}" style="float: left;"/>
                            </p:column>

                            <!-- Time -->
                            <p:column
                                    headerText="#{msg.dicomSeries_seriesTime}"
                                    sortBy="#{dicomSeries.timeSeries}"
                                    filterBy="#{dicomSeries.timeSeriesString}"
                                    filterMatchMode="contains"
                                    visible="#{mbDicomSerie.columnVisibilityList[3]}"
                            >
                                <h:outputText value="#{dicomSeries.timeSeriesString}"/>
                            </p:column>

                            <p:column
                                    headerText="#{msg.menu_commands}"
                                    exportable="false"
                                    toggleable="false"
                            >

                                <!-- Download -->
                                <p:commandButton
                                        title="#{msg.menu_download}"
                                        icon="ui-icon-arrowthick-1-s"
                                        update=":growl"
                                        process="@this"
                                        immediate="true"
                                        ajax="false"
                                        action="#{mbDicomStudies.downloadDicomSeries(mbDicomStudies.selectedEntity.pid, study.studyInstanceUID, dicomSeries.seriesInstanceUID)}"
                                        disabled="#{!userContext.hasRole('ROLE_PACS_DOWNLOAD')}"
                                />

                            </p:column>

                            <!-- Footer -->
                            <f:facet name="footer">
                                <h:outputText value="#{msg.search_results_status_0}"
                                              rendered="#{study.studySeries.size() == 0}"/>
                                <h:outputText value="#{msg.search_results_status_1}"
                                              rendered="#{study.studySeries.size() == 1}"/>
                                <h:outputFormat
                                        value="#{msg.search_results_status_n}"
                                        rendered="#{study.studySeries.size() > 1}"
                                >
                                    <f:param value="#{study.studySeries.size()}"/>
                                </h:outputFormat>
                            </f:facet>
                        </p:dataTable>
                    </p:rowExpansion>

                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}"
                                      rendered="#{mbDicomStudies.dicomStudyList.size() == 0}"/>
                        <h:outputText value="#{msg.search_results_status_1}"
                                      rendered="#{mbDicomStudies.dicomStudyList.size() == 1}"/>
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbDicomStudies.dicomStudyList.size() > 1}"
                        >
                            <f:param value="#{mbDicomStudies.dicomStudyList.size()}"/>
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}" style="width: auto;">
                    <h:commandLink>
                        <p:graphicImage library="img" name="excel.png" title="xls"/>
                        <p:dataExporter type="xls" target="dtDicomStudies" fileName="DICOM-#{msg.study_plural}"/>
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage library="img" name="csv.png" title="csv"/>
                        <p:dataExporter type="csv" target="dtDicomStudies" fileName="DICOM-#{msg.study_plural}"/>
                    </h:commandLink>
                </p:panel>
            </p:tab>
        </p:tabView>
    </ui:define>

    <!-- Definition of dialogs place holder -->
    <ui:define name="dialogs">

        <!-- New -->
        <p:dialog
                id="dlgAssignDicomStudy"
                header="#{msg.dicomStudy_assign}"
                widgetVar="assignDicomStudyDialog"
                resizable="true"
                height="90%"
                width="70%"
                ajax="true"
                closeOnEscape="true"
                modal="true"
                maximizable="true"
        >
            <p:ajax event="close"
                    listener="#{mbDicomStudies.clearDlgAssignDicomStudy()}"
                    update=":form:tabView:dtDicomStudies"
                    oncomplete="PF('assignDicomStudyWizard').loadStep(PF('assignDicomStudyWizard').cfg.steps[0])"
            />
            <h:form id="assignDicomStudyForm">
                <p:blockUI block="assignDicomStudyForm" trigger="assignDicomStudyForm:performAssigningDicomStudyButton">
                    Processing<br/><p:graphicImage name="icons/ajaxloading.gif"/>
                </p:blockUI>
                <p:growl id="growl" sticky="true" showDetail="true"/>
                <p:messages id="assign-dicom-study-form-messages" showDetail="true" autoUpdate="true" closable="true"/>
                <p:wizard
                        id="assignDicomStudyWizard"
                        widgetVar="assignDicomStudyWizard"
                        flowListener="#{mbDicomStudies.onFlowProcess}"
                >
                    <p:tab
                            title="#{msg.menu_selection}"
                            id="UploadSlotAssignment"
                    >
                        <p:panel>
                            <p:panelGrid
                                    id="studyMetaDataOverview"
                                    columns="2"
                                    cellpadding="4"
                                    style="width: 100%"
                            >
                                <!-- Subject Study/StudySite -->
                                <h:outputLabel value="#{msg.study}:" for="txtStudyNew"/>
                                <h:outputText
                                        id="txtStudyNew"
                                        value="#{mbDicomStudies.rpbStudy.name} (#{mbDicomStudies.rpbStudy.getTagValue('EDC-code')})"
                                        title="#{mbDicomStudies.selectedEntity.study.oid}"
                                />
                                <!-- Subject PartnerSite -->
                                <h:outputLabel value="#{msg.partnerSite}:" for="txtPartnerSiteNew"/>
                                <h:outputText
                                        id="txtPartnerSiteNew"
                                        value="#{mbDicomStudies.selectedSubjectSite.name} (#{mbDicomStudies.selectedSubjectSite.identifier})"
                                        title="#{mbDicomStudies.selectedSubjectSite.description}"
                                />
                                <!-- Subject -->
                                <h:outputLabel value="#{msg.studySubject}:" for="txtStudySubjectNew"/>
                                <h:outputText
                                        id="txtStudySubjectNew"
                                        value="#{mbDicomStudies.selectedEntity.studySubjectId} - [#{mbDicomStudies.selectedEntity.pid}]"
                                        title="#{mbDicomStudies.selectedEntity.subjectKey}"
                                />
                                <!-- DICOM Event -->
                                <h:outputLabel value="#{msg.studyEvent}:" for="txtStudyEventNew"/>
                                <h:outputText
                                        id="txtStudyEventNew"
                                        value="#{mbDicomStudies.selectedDicomEventData.eventDefinition.name}[#{mbDicomStudies.selectedDicomEventData.studyEventRepeatKey}]"
                                        title="#{mbDicomStudies.selectedDicomEventData.eventDefinition.oid}"
                                        style="float: left;"
                                />
                                <!-- DICOM Study Item -->
                                <h:outputLabel
                                        value="#{msg.dicomStudy_studySeries_upload_slot}: #{msg.label_required_suffix} "
                                        for="cmbDicomItemsNew"/>
                                <p:selectOneMenu
                                        id="cmbDicomItemsNew"
                                        value="#{mbDicomStudies.uploadSlotItemDefinition}"
                                        converter="omnifaces.SelectItemsConverter"
                                        style="width:400px"
                                        required="true"
                                        var="item"
                                        requiredMessage="#{msg.dicomStudy} #{msg.validation_required}!"
                                >
                                    <p:ajax
                                            event="itemSelect"
                                            update="assignDicomStudyForm:assignDicomStudyWizard"
                                            listener="#{mbDicomStudies.loadAssignableDicomStudies()}"
                                            onstart="PF('dtAssignableDicomStudiesBlockUi').show()"
                                            oncomplete="PF('dtAssignableDicomStudiesBlockUi').hide()"
                                    />
                                    <f:selectItem
                                            itemLabel="#{msg.search_select_one}"
                                            itemValue="#{null}"
                                    />
                                    <f:selectItems
                                            value="#{mbDicomStudies.loadUploadSlots()}"
                                            var="item"
                                            itemValue="#{item}"
                                            itemLabel="#{item.label}"
                                            itemDescription="#{item.oid} -> #{(mbDicomStudies.findAssociatedDicomStudies(item.oid)).getStudyInstanceUID()}"
                                    />
                                    <p:column headerText="#{msg.itemData_label}">
                                        <h:outputText value="#{item.label}"/>
                                    </p:column>
                                    <p:column headerText="#{msg.itemData_description}">
                                        <h:outputText value="#{item.description}"/>
                                    </p:column>
                                    <p:column headerText="#{msg.dicomStudy}">
                                        <h:outputText
                                                value="#{(mbDicomStudies.findAssociatedDicomStudies(item.oid)).getStudyDescription()}"
                                        />
                                    </p:column>
                                </p:selectOneMenu>
                            </p:panelGrid>
                            <p:dataTable
                                    id="dtAssignableDicomStudies"
                                    var="study"
                                    value="#{mbDicomStudies.getAssignableDicomStudyCandidates()}"
                                    widgetVar="assignableDicomStudiesTable"
                                    resizableColumns="true"
                                    draggableColumns="false"
                                    liveResize="true"
                                    paginator="true"
                                    paginatorAlwaysVisible="true"
                                    rows="5"
                                    rowsPerPageTemplate="5,10,15"
                                    emptyMessage="#{msg.search_empty}"
                                    rowKey="#{study.studyInstanceUID}"
                                    rowIndexVar="rowIndex"
                                    sortMode="single"
                                    ajax="true"
                                    selection="#{mbDicomStudies.associatedDicomStudy}"
                                    rowStyleClass="#{study.studyInstanceUID.equals((mbDicomStudies.findAssociatedDicomStudies(mbDicomStudies.uploadSlotItemDefinition.oid)).getStudyInstanceUID())  ? 'ui-marked-table-entry' : null}"
                            >
                                <f:facet name="header">
                                    "#{msg.dicomStudy_plural}"
                                    <p:commandButton id="dtAssignableDicomStudiesToggler" value="#{msg.menu_columns}"
                                                     style="float:right" icon="ui-icon-calculator"/>
                                    <p:columnToggler datasource="dtAssignableDicomStudies"
                                                     trigger="dtAssignableDicomStudiesToggler">
                                    </p:columnToggler>
                                </f:facet>
                                <p:column
                                        selectionMode="single"
                                        toggleable="false"
                                        style="width:16px"
                                >
                                </p:column>
                                <p:column style="width:10px"
                                          exportable="false"
                                          filterable="false"
                                          toggleable="false"
                                >
                                    <p:rowToggler/>
                                </p:column>
                                <p:column headerText="#"
                                          exportable="false"
                                          toggleable="false"
                                          style="width:10px">
                                    <h:outputText
                                            value="#{rowIndex + 1}"
                                            style="float: left;"
                                    />
                                </p:column>
                                <p:column
                                        headerText="#{msg.dicomStudy_studyInstanceUID}"
                                        sortBy="#{study.studyInstanceUID}"
                                        filterBy="#{study.studyInstanceUID}"
                                        filterMatchMode="in"
                                        visible="false"
                                ><h:outputText
                                        style="font-family:consolas, courier new,monospace;float: left;"
                                        value="#{study.studyInstanceUID}"/>
                                </p:column>
                                <p:column
                                        headerText="#{msg.study_description}"
                                        sortBy="#{study.studyDescription}"
                                        filterBy="#{study.studyDescription}"
                                        filterMatchMode="in"
                                ><h:outputText
                                        value="#{mbDicomStudies.removeEdcCodePrefix(study.studyDescription)}"
                                        style="float: left;"
                                />
                                </p:column>
                                <p:column
                                        headerText="#{msg.dicomStudy_studyDate}"
                                        sortBy="#{study.getDateStudy()}"
                                        filterBy="#{study.getDateStudyString()}"
                                        filterMatchMode="contains"
                                        style="width:35px"
                                >
                                    <h:outputText
                                            value="#{study.getDateStudyString()}"
                                    >
                                    </h:outputText>
                                </p:column>
                                <p:column
                                        headerText="#{msg.dicomStudy_modalities}"
                                        sortBy="#{study.getStudyType()}"
                                        filterBy="#{study.getStudyType()}"
                                        filterMatchMode="contains"
                                >
                                    <h:outputText
                                            value="#{study.getStudyType()}"
                                            style="float: left;"
                                    >
                                    </h:outputText>
                                </p:column>
                                <f:facet name="footer">
                                </f:facet>
                                <p:rowExpansion>
                                    <p:toolbar>
                                        <p:toolbarGroup
                                                style="float:right"
                                        >
                                            <p:commandButton
                                                    id="dtAssignableDicomStudiesSubTableToggler"
                                                    type="button"
                                                    value="#{msg.menu_columns}"
                                                    style="float:right"
                                                    icon="ui-icon-calculator"/>
                                            <p:columnToggler
                                                    datasource="dtAssignableDicomStudiesSubtable"
                                                    trigger="dtAssignableDicomStudiesSubTableToggler"/>
                                        </p:toolbarGroup>
                                    </p:toolbar>
                                    <p:dataTable
                                            id="dtAssignableDicomStudiesSubtable"
                                            sortMode="multiple"
                                            var="dicomSeries"
                                            value="#{study.studySeries}"
                                            widgetVar="dtAssignableDicomStudiesSubtable"
                                            resizableColumns="true"
                                            liveResize="true"
                                            paginator="true"
                                            paginatorAlwaysVisible="false"
                                            draggableColumns="false"
                                            rows="5"
                                            rowsPerPageTemplate="5,10,15"
                                            emptyMessage="#{msg.search_empty}"
                                            rowIndexVar="rowIndexSubTable"
                                            ajax="true"
                                            rowKey="#{dicomSeries.seriesInstanceUID}"
                                    >
                                        <f:facet name="header">
                                        </f:facet>

                                        <p:column headerText="#"
                                                  exportable="false"
                                                  toggleable="false"
                                                  style="width:10px">
                                            <h:outputText
                                                    value="#{rowIndexSubTable + 1}"
                                                    style="float: left;"
                                            />
                                        </p:column>
                                        <p:column
                                                id="seriesUidColumn"
                                                headerText="#{msg.dicomSeries_seriesInstanceUID}"
                                                sortBy="#{dicomSeries.seriesInstanceUID}"
                                                filterBy="#{dicomSeries.seriesInstanceUID}"
                                                visible="false"
                                        >
                                            <h:outputText value="#{dicomSeries.seriesInstanceUID}"
                                                          style="float: left"
                                            />
                                        </p:column>
                                        <p:column
                                                headerText="#{msg.dicomSeries_seriesDescription}"
                                                sortBy="#{dicomSeries.seriesDescription}"
                                                filterBy="#{dicomSeries.seriesDescription}"
                                        >
                                            <h:outputText
                                                    value="#{mbDicomStudies.removeEdcCodePrefix(dicomSeries.getUserViewSeriesDescription())}"
                                                    style="float: left"
                                            />
                                        </p:column>
                                        <p:column
                                                headerText="#{msg.dicomSeries_modality}"
                                                sortBy="#{dicomSeries.seriesModality}"
                                                filterBy="#{dicomSeries.seriesModality}"
                                        >
                                            <h:outputText
                                                    value="#{dicomSeries.seriesModality}"
                                                    style="float: left;"
                                            />
                                        </p:column>
                                        <p:column
                                                headerText="#{msg.dicomSeries_seriesTime}"
                                                sortBy="#{dicomSeries.getTimeSeries()}"
                                                filterBy="#{dicomSeries.getTimeSeriesString()}"
                                        >
                                            <h:outputText value="#{dicomSeries.getTimeSeriesString()}">
                                            </h:outputText>
                                        </p:column>
                                        <f:facet name="footer">
                                            <h:outputText value="#{msg.search_results_status_0}"
                                                          rendered="#{study.studySeries.size() == 0}"/>
                                            <h:outputText value="#{msg.search_results_status_1}"
                                                          rendered="#{study.studySeries.size() == 1}"/>
                                            <h:outputFormat
                                                    value="#{msg.search_results_status_n}"
                                                    rendered="#{study.studySeries.size() > 1}"
                                            >
                                                <f:param value="#{study.studySeries.size()}"/>
                                            </h:outputFormat>
                                        </f:facet>
                                    </p:dataTable>
                                </p:rowExpansion>
                            </p:dataTable>
                            <p:blockUI widgetVar="dtAssignableDicomStudiesBlockUi" block="dtAssignableDicomStudies"
                                       trigger="dtAssignableDicomStudies">
                                Processing<br/><p:graphicImage name="icons/ajaxloading.gif"/>
                            </p:blockUI>
                        </p:panel>
                    </p:tab>
                    <p:tab
                            title="#{msg.menu_summary}"
                            id="AssignmentConfirmation"
                    >
                        <p:panel>
                            <p:panelGrid
                                    id="assignment-confirmation-overview"
                                    columns="2"
                                    style="width: 100%"
                            >
                                <!-- Subject Study/StudySite -->
                                <h:outputLabel value="#{msg.study}:" for="txtStudyNew"/>
                                <h:outputText
                                        id="AssignmentConfirmationOverviewTxtStudyNew"
                                        value="#{mbDicomStudies.rpbStudy.name} (#{mbDicomStudies.rpbStudy.getTagValue('EDC-code')})"
                                        title="#{mbDicomStudies.selectedEntity.study.oid}"
                                />
                                <!-- Subject PartnerSite -->
                                <h:outputLabel value="#{msg.partnerSite}:" for="txtPartnerSiteNew"/>
                                <h:outputText
                                        id="AssignmentConfirmationOverviewTxtPartnerSiteNew"
                                        value="#{mbDicomStudies.selectedSubjectSite.name} (#{mbDicomStudies.selectedSubjectSite.identifier})"
                                        title="#{mbDicomStudies.selectedSubjectSite.description}"
                                />
                                <!-- Subject -->
                                <h:outputLabel value="#{msg.studySubject}:" for="txtStudySubjectNew"/>
                                <h:outputText
                                        id="AssignmentConfirmationOverviewTxtStudySubjectNew"
                                        value="#{mbDicomStudies.selectedEntity.studySubjectId} - [#{mbDicomStudies.selectedEntity.pid}]"
                                        title="#{mbDicomStudies.selectedEntity.subjectKey}"
                                />
                                <!-- DICOM Event -->
                                <h:outputLabel value="#{msg.studyEvent}:" for="txtStudyEventNew"/>
                                <h:outputText
                                        id="AssignmentConfirmationOverviewTxtStudyEventNew"
                                        value="#{mbDicomStudies.selectedDicomEventData.eventDefinition.name}[#{mbDicomStudies.selectedDicomEventData.studyEventRepeatKey}]"
                                        title="#{mbDicomStudies.selectedDicomEventData.eventDefinition.oid}"
                                        style="float: left;"
                                />
                                <h:outputLabel
                                        value="#{msg.dicomStudy_studySeries_upload_slot}"
                                        for="AssignmentConfirmationOverviewCmbDicomItemsNew"/>
                                <h:outputText
                                        id="AssignmentConfirmationOverviewCmbDicomItemsNew"
                                        value="#{mbDicomStudies.uploadSlotItemDefinition.label}"
                                        title="#{mbDicomStudies.uploadSlotItemDefinition.itemOid}"
                                        style="float: left;"
                                />
                                <h:outputLabel
                                        value="#{msg.dicomStudy}"
                                        for="AssignmentConfirmationOverviewAssociatedStudy"/>
                                <h:outputText
                                        id="AssignmentConfirmationOverviewAssociatedStudy"
                                        value="#{mbDicomStudies.associatedDicomStudy.studyDescription}"
                                        title="#{mbDicomStudies.associatedDicomStudy.studyInstanceUID}"
                                        style="float: left;"
                                />
                            </p:panelGrid>
                            <f:facet name="footer">
                                <p:commandButton
                                        id="performAssigningDicomStudyButton"
                                        value="#{msg.dicomStudy_assign}"
                                        action="#{mbDicomStudies.assignSeriesToUploadSlot}"
                                        update="growl"
                                        process="@this"
                                        oncomplete="PF('assignDicomStudyDialog').hide(); PF('assignDicomStudyWizard').loadStep(PF('assignDicomStudyWizard').cfg.steps[0]);"
                                />
                            </f:facet>
                        </p:panel>
                    </p:tab>
                </p:wizard>
            </h:form>
        </p:dialog>


        <!-- Submit from dialog -->
        <script type="text/javascript">
            function handleSubmitRequest(xhr, status, args, dialogName, formName) {
                dialog = jQuery('#' + dialogName);
                if (args.validationFailed) {
                    dialog.effect("shake", {times: 3}, 100);
                } else {
                    clearForm(formName);

                    PF('newDicomDialog').hide();
                }
            }

            function clearForm(formName) {
                jQuery('#' + formName).each(function () {
                    this.reset();
                });
            }
        </script>
    </ui:define>
</ui:composition>