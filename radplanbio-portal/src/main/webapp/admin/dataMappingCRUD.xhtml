<?xml version="1.0" encoding="UTF-8" ?>

<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:fn="http://java.sun.com/jsp/jstl/functions"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:p="http://primefaces.org/ui"
        template="/WEB-INF/layouts/main.xhtml"
        >

    <!-- Definition of breadcrumbs place holder -->
    <ui:define name="breadcrumbs">
        <p:breadCrumb>
            <p:menuitem value="#{msg.home}" title="#{msg.home}" url="/home.faces" />
            <p:menuitem value="#{msg.administration}" title="#{msg.administration}" url="#" />
            <p:menuitem value="EDC" title="Electronic Data Capture System" url="#" />
            <p:menuitem value="Data mapping" title="Define maping for study data import/export" url="/admin/dataMappingCRUD.faces" />
        </p:breadCrumb>
    </ui:define>

    <!-- Definition of page content place holder -->
    <ui:define name="content">
        <p:tabView id="tabView">

            <!-- RadPlanBio data mapping definitions -->
            <p:tab title="Mapping definitions">

                <!-- Data mapping definitions toolbar -->
                <p:toolbar>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                                value="#{msg.menu_print}"
                                title="Print data mappings"
                                icon="ui-icon-print"
                                >
                            <p:printer target="dtEntities" />
                        </p:commandButton>

                        <p:commandButton
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                disabled="True"
                                />
                    </p:toolbarGroup>

                    <!-- Left -->
                    <p:toolbarGroup align="left">

                        <!-- New -->
                        <p:commandButton
                            value="#{msg.menu_new}"
                            title="Create a new mapping definition [ctrl+shift+n]"
                            icon="ui-icon-document"
                            oncomplete="PF('newMappingDialog').show();"
                            style="float: left;"
                            immediate="true"
                            update=":newMappingForm:newDisplay"
                            process="@this"
                            actionListener="#{mbDataMapping.prepareNewEntity}"
                            />
                        <p:hotkey
                            bind="ctrl+shift+n"
                            oncomplete="PF('newMappingDialog').show();"
                            immediate="true"
                            update=":newMappingForm:newDisplay"
                            process="@this"
                            actionListener="#{mbDataMapping.prepareNewEntity}"
                            />

                        <!-- Reload -->
                        <p:commandButton
                            value="#{msg.menu_reload}"
                            title="Reload mapping definitions [ctrl+shift+r]"
                            icon="ui-icon-refresh"
                            immediate="true"
                            process="@this"
                            update=":form:tabView:dtEntities, :growl"
                            actionListener="#{mbDataMapping.load}"
                            />
                        <p:hotkey
                            bind="ctrl+shift+r"
                            immediate="true"
                            process="@this"
                            update=":form:tabView:dtEntities, :growl"
                            actionListener="#{mbDataMapping.load}"
                            />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- RadPlanBio data mappings definitions table -->
                <p:dataTable
                        id="dtEntities"
                        var="entity"
                        value="#{mbDataMapping.entityList}"
                        widgetVar="entitiesTable"
                        resizableColumns="true"
                        draggableColumns="false"
                        paginator="true"
                        rows="15"
                        rowsPerPageTemplate="15,25,50"
                        emptyMessage="#{msg.search_empty}"
                        selection="#{mbDataMapping.selectedEntity}"
                        selectionMode="single"
                        rowKey="#{entity.id}"
                        rowIndexVar="rowIndex"
                        filteredValue="#{mbDataMapping.filteredEntities}"
                        sortMode="multiple"
                        sortBy="#{mbDataMapping.preSortOrder}"
                        disabledTextSelection="false"
                        >

                    <!--AJAX onclick on datatable row-->
                    <p:ajax event="rowSelect" update=":form:tabView:dtRecords" />

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- Mapping definition name -->
                    <p:column
                            id="colMappingDefName"
                            sortBy="#{entity.name}"
                            filterBy="#{entity.name}"
                            filterMatchMode="contains"
                            >
                        <f:facet name="header">
                            <h:outputText value="Name" />
                        </f:facet>
                        <h:outputText value="#{entity.name}" />
                    </p:column>

                    <!-- Mapping type -->
                    <p:column
                            sortBy="#{entity.type}"
                            filterBy="#{entity.type}"
                            filterMatchMode="contains"
                            style="width:10%"
                            >
                        <f:facet name="header">
                            <h:outputText value="Type" />
                        </f:facet>
                        <h:outputText value="#{entity.type}" />
                    </p:column>

                    <!-- Mapping from -->
                    <p:column
                            sortBy="#{entity.sourceType}"
                            filterBy="#{entity.sourceType}"
                            filterMatchMode="contains"
                            style="width:5%"
                            >
                        <f:facet name="header">
                            <h:outputText value="From" />
                        </f:facet>
                        <h:outputText value="#{entity.sourceType}" />
                    </p:column>

                    <!-- Mapping to -->
                    <p:column
                            sortBy="#{entity.targetType}"
                            filterBy="#{entity.targetType}"
                            filterMatchMode="contains"
                            style="width:5%"
                            >
                        <f:facet name="header">
                            <h:outputText value="To" />
                        </f:facet>
                        <h:outputText value="#{entity.targetType}" />
                    </p:column>

                    <!-- Mapping coverage -->
                    <p:column>
                        <f:facet name="header">
                            <h:outputText value="Coverage" />
                        </f:facet>
                        <h:outputText value="#{entity.targetCountCoveredWithMapping()}/#{entity.targetCount()}" />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                            headerText="#{msg.menu_commands}"
                            exportable="false"
                            toggleable="false"
                            style="width:17%"
                            >
                        <!-- Clone -->
                        <p:commandButton title="Clone"
                                         icon="ui-icon-copy"
                                         immediate="true"
                                         process="@this"
                                         update=":form:tabView:dtEntities, :growl"
                                         actionListener="#{mbDataMapping.doCloneEntity}"
                                >
                            <f:setPropertyActionListener
                                    value="#{entity}"
                                    target="#{mbDataMapping.selectedEntity}"
                                    />
                        </p:commandButton>

                        <!-- Edit -->
                        <p:commandButton
                                title="#{msg.menu_edit}"
                                icon="ui-icon-contact"
                                update=":editMappingForm:editDisplay"
                                immediate="true"
                                process="@this"
                                oncomplete="PF('editMappingDialog').show();"
                                >
                            <f:setPropertyActionListener
                                    value="#{entity}"
                                    target="#{mbDataMapping.selectedEntity}"
                                    />
                        </p:commandButton>

                        <!-- Delete -->
                        <p:commandButton
                                title="#{msg.menu_delete}"
                                icon="ui-icon-trash"
                                update=":deleteMappingForm:deleteDisplay"
                                oncomplete="PF('deleteMappingDialog').show();"
                                immediate="true"
                                process="@this"
                                >
                            <f:setPropertyActionListener
                                    value="#{entity}"
                                    target="#{mbDataMapping.selectedEntity}"
                                    />
                        </p:commandButton>
                    </p:column>

                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbDataMapping.entityList.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbDataMapping.entityList.size() == 1}" />
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbDataMapping.entityList.size() > 1}"
                                >
                            <f:param value="#{mbDataMapping.entityList.size()}" />
                        </h:outputFormat>
                    </f:facet>
                </p:dataTable>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}">
                    <h:commandLink>
                        <p:graphicImage value="/resources/img/excel.png" title="xls" />
                        <p:dataExporter type="xls" target="dtEntities" fileName="dataMappings" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage value="/resources/img/csv.png" title="csv" />
                        <p:dataExporter type="csv" target="dtEntities" fileName="dataMappings" />
                    </h:commandLink>
                </p:panel>
            </p:tab>

            <!-- Mapping records of selected definitions -->
            <p:tab title="Mapping records">

                <!-- Data mapping records toolbar -->
                <p:toolbar>

                    <!-- Right -->
                    <p:toolbarGroup align="right">
                        <p:commandButton
                                value="#{msg.menu_print}"
                                title="Print mapping records"
                                icon="ui-icon-print"
                                >
                            <p:printer target="dtRecords" />
                        </p:commandButton>

                        <p:commandButton
                                id="btnMappingRecordsHelp"
                                value="#{msg.menu_help}"
                                title="#{msg.menu_help}"
                                icon="ui-icon-help"
                                disabled="True"
                                />
                    </p:toolbarGroup>

                    <!-- Left -->
                    <p:toolbarGroup align="left">

                        <!-- New -->
                        <p:commandButton
                                value="#{msg.menu_new}"
                                title="Create a new mapping record [ctrl+shift+n]"
                                icon="ui-icon-document"
                                oncomplete="PF('newRecordDialog').show();"
                                style="float: left;"
                                immediate="true"
                                update=":newRecordForm:newRecordDisplay"
                                process="@this"
                                actionListener="#{mbDataMapping.prepareNewRecord}"
                                />
                        <p:hotkey
                                bind="ctrl+shift+n"
                                immediate="true"
                                process="@this"
                                oncomplete="PF('newRecordDialog').show();"
                                update=":newRecordForm:newRecordDisplay"
                                actionListener="#{mbDataMapping.prepareNewRecord}"
                                />
                    </p:toolbarGroup>
                </p:toolbar>

                <!-- RadPlanBio data mappings records table -->
                <p:dataTable
                        id="dtRecords"
                        var="record"
                        value="#{mbDataMapping.selectedEntity.mappingRecords}"
                        widgetVar="recordsTable"
                        resizableColumns="false"
                        draggableColumns="false"
                        paginator="true"
                        rows="15"
                        rowsPerPageTemplate="15,25,50"
                        emptyMessage="#{msg.search_empty}"
                        selection="#{mbDataMapping.selectedRecord}"
                        selectionMode="single"
                        rowKey="#{record.id}"
                        rowIndexVar="rowIndex"
                        filteredValue="#{mbDataMapping.filteredRecords}"
                        sortMode="multiple"
                        sortBy="#{mbMappingRecord.preSortOrder}"
                        disabledTextSelection="false"
                        >

                    <!-- Row -->
                    <p:column headerText="#" exportable="false" toggleable="false" style="width:5%">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <!-- Mapping record source -->
                    <p:column
                            id="colSourceLabel"
                            sortBy="#{record.source.label}"
                            filterBy="#{record.source.label}"
                            filterMatchMode="contains"
                            >
                        <f:facet name="header">
                            <h:outputText value="Source" />
                        </f:facet>
                        <h:outputText value="#{record.source.label}" />
                    </p:column>

                    <!-- Mapping record target -->
                    <p:column
                            sortBy="#{record.target.label}"
                            filterBy="#{record.target.label}"
                            filterMatchMode="contains"
                            >
                        <f:facet name="header">
                            <h:outputText value="Target" />
                        </f:facet>
                        <h:outputText value="#{record.target.label}" />
                    </p:column>

                    <!-- Mapping record priority -->
                    <p:column
                            sortBy="#{record.priority}"
                            filterBy="#{record.priority}"
                            filterMatchMode="equals"
                            >
                        <f:facet name="header">
                            <h:outputText value="Priority" />
                        </f:facet>
                        <h:outputText value="#{record.priority}" />
                    </p:column>

                    <!-- Commands -->
                    <p:column
                            headerText="#{msg.menu_commands}"
                            exportable="false"
                            toggleable="false"
                            style="width:17%"
                            >
                        <!-- Edit -->
                        <p:commandButton
                                title="Edit"
                                icon="ui-icon-contact"
                                update=":editRecordForm:editRecordDisplay"
                                oncomplete="PF('editRecordDialog').show();"
                                immediate="true"
                                process="@this"
                                >
                            <f:setPropertyActionListener
                                    value="#{record}"
                                    target="#{mbDataMapping.selectedRecord}"
                                    />
                        </p:commandButton>

                        <!-- Delete -->
                        <p:commandButton
                                title="Delete"
                                icon="ui-icon-trash"
                                update=":deleteRecordForm:deleteRecordDisplay"
                                oncomplete="PF('deleteRecordDialog').show();"
                                immediate="true"
                                process="@this"
                                >
                            <f:setPropertyActionListener
                                    value="#{record}"
                                    target="#{mbDataMapping.selectedRecord}"
                                    />
                        </p:commandButton>
                    </p:column>

                    <f:facet name="footer">
                        <h:outputText value="#{msg.search_results_status_0}" rendered="#{mbDataMapping.selectedEntity.mappingRecords.size() == 0}" />
                        <h:outputText value="#{msg.search_results_status_1}" rendered="#{mbDataMapping.selectedEntity.mappingRecords.size() == 1}" />
                        <h:outputFormat
                                value="#{msg.search_results_status_n}"
                                rendered="#{mbDataMapping.selectedEntity.mappingRecords.size() > 1}"
                                >
                            <f:param value="#{mbDataMapping.selectedEntity.mappingRecords.size()}" />
                        </h:outputFormat>
                    </f:facet>

                </p:dataTable>

                <!-- Export -->
                <p:panel header="#{msg.menu_export}">
                    <h:commandLink>
                        <p:graphicImage value="/resources/img/excel.png" title="xls" />
                        <p:dataExporter type="xls" target="dtRecords" fileName="dataMappingRecords" />
                    </h:commandLink>
                    <h:commandLink>
                        <p:graphicImage value="/resources/img/csv.png" title="csv" />
                        <p:dataExporter type="csv" target="dtRecords" fileName="dataMappingRecords" />
                    </h:commandLink>
                </p:panel>
            </p:tab>
        </p:tabView>
    </ui:define>

    <!-- Definition of dialogs place holder -->
    <ui:define name="dialogs">

        <!-- New -->
        <p:dialog
            id="dlgNewMapping"
            header="Create a new data mapping definition"
            widgetVar="newMappingDialog"
            resizable="false"
            ajax="true"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >

            <h:form id="newMappingForm">
                <p:panelGrid
                    id="newDisplay"
                    columns="2"
                    cellpadding="4"
                    style="margin:0 auto;"
                    >

                    <!-- OpenClinica active study -->
                    <h:outputLabel value="Study: *" for="txtStudyNew" />
                    <h:outputText id="txtStudyNew" value="#{mbMain.activeStudy.uniqueIdentifier}" />

                    <!-- Name of mapping definition -->
                    <h:outputLabel value="Name: *" for="txtMappingName" />
                    <h:inputText
                        id="txtMappingName"
                        value="#{mbDataMapping.newEntity.name}"
                        required="true"
                        requiredMessage="Mapping name is mandatory"
                        />

                    <!-- Description -->
                    <h:outputLabel value="Description:" for="txtMappingDescription" />
                    <h:inputTextarea
                        id="txtMappingDescription"
                        value="#{mbDataMapping.newEntity.description}"
                        />

                    <!-- Mapping Type -->
                    <h:outputLabel value="Type: *" for="cmbMappingType" />
                    <p:selectOneMenu
                            id="cmbMappingType"
                            value="#{mbDataMapping.newEntity.type}"
                            required="true"
                            requiredMessage="You have to choose mapping type, it is mandatory!"
                            style="width:250px"
                            rendered="#{mbDataMapping.newEntity != null}"
                            >
                        <!-- AJAX update on selection changed -->
                        <p:ajax listener="#{mbDataMapping.selectedMappingTypeChanged}" update=":newMappingForm:cmbMappingSourceType, :newMappingForm:cmbMappingTargetType" />
                        <f:selectItem
                                itemLabel="#{msg.search_select_one}"
                                itemValue="-1"
                                noSelectionOption="true"
                                />
                        <f:selectItems value="#{mbDataMapping.getMappingTypeValues()}" />
                    </p:selectOneMenu>

                    <!-- Source Type -->
                    <h:outputLabel value="Source type: *" for="cmbMappingSourceType" />
                    <p:selectOneMenu
                        id="cmbMappingSourceType"
                        value="#{mbDataMapping.newEntity.sourceType}"
                        required="true"
                        requiredMessage="You have to choose mapping source type, it is mandatory!"
                        style="width:250px"
                        rendered="#{mbDataMapping.newEntity != null}"
                        disabled="#{mbDataMapping.newEntity.type == 'EXPORT'}"
                        >
                        <f:selectItems value="#{mbDataMapping.getMappingItemTypeValues()}" />
                    </p:selectOneMenu>

                    <!-- Target Type -->
                    <h:outputLabel value="Target type: *" for="cmbMappingTargetType" />
                    <p:selectOneMenu
                            id="cmbMappingTargetType"
                            value="#{mbDataMapping.newEntity.targetType}"
                            required="true"
                            requiredMessage="You have to choose mapping target type, it is mandatory!"
                            style="width:250px"
                            rendered="#{mbDataMapping.newEntity != null}"
                            disabled="#{mbDataMapping.newEntity.type == 'IMPORT'}"
                            >
                        <f:selectItems value="#{mbDataMapping.getMappingItemTypeValues()}" />
                    </p:selectOneMenu>

                    <!-- Filename -->
                    <h:outputLabel for="txtFileName" value="File name: *" />
                    <p:inputText
                            id="txtFileName"
                            value="#{mbDataMapping.uploadedFile.fileName}"
                            style="width:500px"
                            disabled="true"
                            required="true"
                            requiredMessage="You have upload data file before continuing!"
                            />

                    <!-- Upload data definition file -->
                    <h:outputLabel
                            for="uploadImportFile"
                            rendered="#{mbDataMapping.uploadedFile == null}"
                            />
                    <p:fileUpload id="uploadImportFile"
                                  fileUploadListener="#{mbDataMapping.handleUpload}"
                                  rendered="#{mbDataMapping.uploadedFile == null}"
                                  mode="advanced"
                                  update=":growl, :newMappingForm:txtFileName, :newMappingForm:btnLoadMappedItems"
                                  label="Choose a file or drag and drop it here:"
                                  sizeLimit="10048576"
                                  auto="false"
                                  allowTypes="/(\.|\/)(xml|csv)$/"
                                  invalidSizeMessage="The maximum file size allowed is 10 Megabyte!"
                                  invalidFileMessage="You are allowed to upload only (xml, csv files)!"
                                  dragDropSupport="true"
                                  fileLimit="1"
                            />

                    <!-- Data transformation process -->
                    <p:commandButton
                            id="btnLoadMappedItems"
                            value="Load"
                            title="Load mapped data items"
                            icon="ui-icon-play"
                            disabled="#{mbDataMapping.uploadedFile == null}"
                            actionListener="#{mbDataMapping.loadMappedItems}"
                            update=":growl, :newMappingForm:dlSourceDefs, :newMappingForm:dlTargetDefs"
                            process="@this newMappingForm"
                            />
                    <h:outputText value="" />

                    <!-- Source data definitions -->
                    <h:outputLabel for="dlSourceDefs" value="Source definitions: *" />
                    <p:dataList
                            id="dlSourceDefs"
                            value="#{mbDataMapping.newEntity.sourceItemDefinitions}"
                            var="itemDef"
                            type="ordered"
                            itemType="none"
                            paginator="true"
                            rows="5"
                            styleClass="paginated"
                            disabled="#{mbDataMapping.uploadedFile == null}"
                            >
                        #{itemDef.label}
                    </p:dataList>

                    <!-- Target data definitions -->
                    <h:outputLabel for="dlTargetDefs" value="Target definitions: *" />
                    <p:dataList
                            id="dlTargetDefs"
                            value="#{mbDataMapping.newEntity.targetItemDefinitions}"
                            var="itemDef"
                            type="ordered"
                            itemType="none"
                            paginator="true"
                            rows="5"
                            styleClass="paginated"
                            disabled="#{mbDataMapping.uploadedFile == null}"
                            >
                        #{itemDef.label}
                    </p:dataList>

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                            value="#{msg.menu_save}"
                            update=":form:tabView:dtEntities, :growl"
                            icon="ui-icon-disk"
                            actionListener="#{mbDataMapping.doCreateEntity}"
                            oncomplete=" handleSubmitRequest(xhr, status, args, 'dlgNewMapping','newMappingForm');"
                            process="@this newMappingForm"
                            />
                        <p:commandButton value="#{msg.menu_reset}" type="reset" icon="ui-icon-close" />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Edit -->
        <p:dialog
            id="dlgMappingEdit"
            header="Edit data mapping definition"
            widgetVar="editMappingDialog"
            resizable="false"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >
            <h:form id="editMappingForm">
                <p:panelGrid
                    id="editDisplay"
                    columns="2"
                    cellpadding="4"
                    style="margin:0 auto;"
                    >

                    <!-- OpenClinica active study -->
                    <h:outputLabel value="Study: *" for="txtStudyEdit" />
                    <h:outputText id="txtStudyEdit" value="#{mbMain.activeStudy.uniqueIdentifier}" />

                    <!-- Name of mapping definition -->
                    <h:outputLabel value="Name: *" for="txtMappingNameEdit" />
                    <h:inputText
                            id="txtMappingNameEdit"
                            value="#{mbDataMapping.selectedEntity.name}"
                            required="true"
                            requiredMessage="Mapping name is mandatory"
                            />

                    <!-- Description -->
                    <h:outputLabel value="Description:" for="txtMappingDescriptionEdit" />
                    <h:inputTextarea
                            id="txtMappingDescriptionEdit"
                            value="#{mbDataMapping.selectedEntity.description}"
                            />

                    <!-- Mapping Type -->
                    <h:outputLabel value="Type: *" for="txtMappingTypeEdit" />
                    <h:outputText id="txtMappingTypeEdit" value="#{mbDataMapping.selectedEntity.type}" />

                    <!-- Source Type -->
                    <h:outputLabel value="Source type: *" for="txtMappingSourceTypeEdit" />
                    <h:outputText id="txtMappingSourceTypeEdit" value="#{mbDataMapping.selectedEntity.sourceType}" />

                    <!-- Target Type -->
                    <h:outputLabel value="Target type: *" for="txtMappingTargetTypeEdit" />
                    <h:outputText id="txtMappingTargetTypeEdit" value="#{mbDataMapping.selectedEntity.targetType}" />

                    <!-- Possibility to  add more columns for CSV sources -->
                    <h:outputLabel value="Commands:" />
                    <!-- Toolbar -->
                    <p:toolbar>
                        <!-- Left -->
                        <p:toolbarGroup align="left">
                            <!-- New -->
                            <p:commandButton
                                    title="#{msg.menu_new}}"
                                    icon="ui-icon-document"
                                    immediate="true"
                                    process="@this"
                                    update=":editMappingForm:txtSourceItemName, :editMappingForm:txtEditSourceItemName, :editMappingForm:btnSaveSourceItemDef, :editMappingForm:btnCancelSourceItemDef, :editMappingForm:btnRemoveSourceItemDef"
                                    actionListener="#{mbDataMapping.prepareNewSourceItemDefition}"
                                    />

                            <!-- Edit -->
                            <p:commandButton
                                    id="btnEditSourceItemDef"
                                    title="Edit"
                                    icon="ui-icon-contact"
                                    update=":editMappingForm:btnSaveSourceItemDef, :editMappingForm:btnCancelSourceItemDef"
                                    immediate="true"
                                    process="@this"
                                    actionListener="#{mbDataMapping.editSourceItemDefinition}"
                                    disabled="#{mbDataMapping.selectedSourceItemDef == null || mbDataMapping.newSourceItemDef != null}"
                                    />

                            <!-- Remove -->
                            <p:commandButton
                                    id="btnRemoveSourceItemDef"
                                    title="Remove"
                                    icon="ui-icon-trash"
                                    update=":editMappingForm:dtSourceDefsEdit"
                                    immediate="true"
                                    process="@this"
                                    actionListener="#{mbDataMapping.removeSourceItemDefinition}"
                                    disabled="#{mbDataMapping.selectedSourceItemDef == null || mbDataMapping.newSourceItemDef != null}"
                                    />

                            <!-- Commit-->
                            <p:commandButton
                                    id="btnSaveSourceItemDef"
                                    title="Add source item definition"
                                    icon="ui-icon-disk"
                                    process="@this editMappingForm"
                                    update=":editMappingForm:dtSourceDefsEdit, :editMappingForm:txtSourceItemName, :editMappingForm:txtEditSourceItemName, :editMappingForm:btnSaveSourceItemDef, :editMappingForm:btnRemoveSourceItemDef, :editMappingForm:btnCancelSourceItemDef, :growl"
                                    actionListener="#{mbDataMapping.saveSourceItemDefinition}"
                                    disabled="#{mbDataMapping.newSourceItemDef == null and mbDataMapping.selectedSourceItemDef == null}"
                                    />

                            <!-- Cancel -->
                            <p:commandButton
                                    id="btnCancelSourceItemDef"
                                    title="Reset"
                                    icon="ui-icon-close"
                                    immediate="true"
                                    process="@this"
                                    update=":editMappingForm:dtSourceDefsEdit, :editMappingForm:txtSourceItemName, :editMappingForm:txtEditSourceItemName, :editMappingForm:btnSaveSourceItemDef, :editMappingForm:btnRemoveSourceItemDef, :editMappingForm:btnCancelSourceItemDef, :growl"
                                    actionListener="#{mbDataMapping.cancelSourceItemDefinition}"
                                    disabled="#{mbDataMapping.newSourceItemDef == null and mbDataMapping.selectedSourceItemDef == null}"
                                    />

                        </p:toolbarGroup>
                    </p:toolbar>

                    <!-- Show this line only when edition or adding new source item definition -->
                    <h:outputLabel
                            value="New source item: *"
                            for="txtSourceItemName"
                            />
                    <p:inputText
                            id="txtSourceItemName"
                            value="#{mbDataMapping.newSourceItemDef.label}"
                            required="true"
                            disabled="#{mbDataMapping.newSourceItemDef == null}"
                            />

                    <h:outputLabel
                            value="Selected source item:"
                            for="txtEditSourceItemName"
                            />
                    <p:inputText
                            id="txtEditSourceItemName"
                            value="#{mbDataMapping.selectedSourceItemDef.label}"
                            disabled="#{mbDataMapping.selectedSourceItemDef == null}"
                            />

                    <!-- Source data definitions -->
                    <h:outputLabel for="dtSourceDefsEdit" value="Source definitions: *" />
                    <p:dataTable
                            id="dtSourceDefsEdit"
                            value="#{mbDataMapping.selectedEntity.sourceItemDefinitions}"
                            widgetVar="sourceItemDefTable"
                            var="sourceItemDef"
                            type="ordered"
                            itemType="none"
                            paginator="true"
                            rows="5"
                            styleClass="paginated"
                            emptyMessage="No source item definitions found with given criteria"
                            filteredValue="#{mbDataMapping.filteredSourceItemDefs}"
                            selection="#{mbDataMapping.selectedSourceItemDef}"
                            selectionMode="single"
                            rowKey="#{sourceItemDef.label}"
                            rowIndexVar="sidRowIndex"
                            >
                        <!--AJAX onclick on datatable row-->
                        <p:ajax event="rowSelect" update=":editMappingForm:txtEditSourceItemName, :editMappingForm:btnRemoveSourceItemDef, :editMappingForm:btnEditSourceItemDef" />

                        <!-- Row -->
                        <p:column
                                style="width:3%"
                                exportable="false"
                                >
                            <f:facet name="header">
                                <h:outputText value="#" />
                            </f:facet>
                            <h:outputText value="#{sidRowIndex + 1}" />
                        </p:column>

                        <!-- Item definition label -->
                        <p:column
                                sortBy="#{sourceItemDef.label}"
                                filterBy="#{sourceItemDef.label}"
                                filterMatchMode="contains"
                                >
                            <f:facet name="header">
                                <h:outputText value="Label" />
                            </f:facet>
                            <h:outputText value="#{sourceItemDef.label}" />
                        </p:column>

                        <f:facet name="footer">
                            In total there are #{fn:length(mbDataMapping.selectedEntity.sourceItemDefinitions)} source item definitions for this mapping.
                        </f:facet>
                    </p:dataTable>

                    <!-- Target data definitions -->
                    <h:outputLabel for="dtTargetDefsEdit" value="Target definitions: *" />
                    <p:dataTable
                            id="dtTargetDefsEdit"
                            value="#{mbDataMapping.selectedEntity.targetItemDefinitions}"
                            widgetVar="targetItemDefTable"
                            var="targetItemDef"
                            type="ordered"
                            itemType="none"
                            paginator="true"
                            rows="5"
                            styleClass="paginated"
                            emptyMessage="No target item definition found with given criteria"
                            filteredValue="#{mbDataMapping.filteredTargetItemDefs}"
                            selection="#{mbDataMapping.selectedTargetItemDef}"
                            selectionMode="single"
                            rowKey="#{targetItemDef.label}"
                            rowIndexVar="tidRowIndex"
                            >
                        <!-- Row -->
                        <p:column
                                style="width:3%"
                                exportable="false"
                                >
                            <f:facet name="header">
                                <h:outputText value="#" />
                            </f:facet>
                            <h:outputText value="#{tidRowIndex + 1}" />
                        </p:column>

                        <!-- Item definition label -->
                        <p:column
                                sortBy="#{targetItemDef.label}"
                                filterBy="#{targetItemDef.label}"
                                filterMatchMode="contains"
                                >
                            <f:facet name="header">
                                <h:outputText value="Label" />
                            </f:facet>
                            <h:outputText value="#{targetItemDef.label}" />
                        </p:column>

                        <f:facet name="footer">
                            In total there are #{fn:length(mbDataMapping.selectedEntity.targetItemDefinitions)} target item definitions for this mapping.
                        </f:facet>
                    </p:dataTable>

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                            id="btnMappingUpdate"
                            value="#{msg.menu_update}"
                            update=":form:tabView:dtEntities, :growl"
                            icon="ui-icon-disk"
                            oncomplete="handleSubmitRequest(xhr, status, args, 'dlgMappingEdit','editMappingForm');"
                            actionListener="#{mbDataMapping.doUpdateEntity}"
                            process="@this editMappingForm"
                            />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Delete -->
        <p:dialog
            id="dlgDeleteMapping"
            header="Data mapping definition"
            widgetVar="deleteMappingDialog"
            resizable="false"
            appendToBody="true"
            modal="true"
            closeOnEscape="true"
            >
            <h:form id="deleteMappingForm">
                <p:panelGrid
                        id="deleteDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- OpenClinica active study -->
                    <h:outputLabel value="Study: *" for="txtStudy" />
                    <h:outputText id="txtStudy" value="#{mbMain.activeStudy.uniqueIdentifier}" />

                    <!-- Name of mapping definition -->
                    <h:outputLabel value="Name: *" for="txtMappingNameDelete" />
                    <h:outputText id="txtMappingNameDelete" value="#{mbDataMapping.selectedEntity.name}" />

                    <!-- Description -->
                    <h:outputLabel value="Description:" for="txtMappingDescriptionDelete" />
                    <h:outputText id="txtMappingDescriptionDelete" value="#{mbDataMapping.selectedEntity.description}" />

                    <!-- Mapping Type -->
                    <h:outputLabel value="Type: *" for="txtMappingTypeDelete" />
                    <h:outputText id="txtMappingTypeDelete" value="#{mbDataMapping.selectedEntity.type}" />

                    <!-- Source Type -->
                    <h:outputLabel value="Source type: *" for="txtMappingSourceTypeDelete" />
                    <h:outputText id="txtMappingSourceTypeDelete" value="#{mbDataMapping.selectedEntity.sourceType}" />

                    <!-- Target Type -->
                    <h:outputLabel value="Target type: *" for="txtMappingTargetTypeDelete" />
                    <h:outputText id="txtMappingTargetTypeDelete" value="#{mbDataMapping.selectedEntity.targetType}" />

                    <h:outputLabel for="dlSourceDefsDelete" value="Source definitions: *" />
                    <p:dataList
                            id="dlSourceDefsDelete"
                            value="#{mbDataMapping.selectedEntity.sourceItemDefinitions}"
                            var="itemDef"
                            type="ordered"
                            itemType="none"
                            paginator="true"
                            rows="5"
                            styleClass="paginated"
                            >
                        #{itemDef.label}
                    </p:dataList>

                    <!-- Target data definitions -->
                    <h:outputLabel for="dlTargetDefsDelete" value="Target definitions: *" />
                    <p:dataList
                            id="dlTargetDefsDelete"
                            value="#{mbDataMapping.selectedEntity.targetItemDefinitions}"
                            var="itemDef"
                            type="ordered"
                            itemType="none"
                            paginator="true"
                            rows="5"
                            styleClass="paginated"
                            >
                        #{itemDef.label}
                    </p:dataList>

                    <!-- Commands-->
                    <f:facet name="footer">
                        <p:commandButton
                            id="btnMappingDelete"
                            value="#{msg.menu_delete}"
                            update=":form:tabView:dtEntities, :growl"
                            icon="ui-icon-trash"
                            oncomplete="handleSubmitRequest(xhr, status, args, 'dlgDeleteMapping','deleteMappingForm');"
                            actionListener="#{mbDataMapping.doDeleteEntity}"
                            process="@this deleteMappingForm"
                            />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- New Record -->
        <p:dialog
                id="dlgNewRecord"
                header="Create a new data mapping record"
                widgetVar="newRecordDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >

            <h:form id="newRecordForm">
                <p:panelGrid
                        id="newRecordDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- OpenClinica active study -->
                    <h:outputLabel value="Study: *" for="txtStudyNewRecord" />
                    <h:outputText id="txtStudyNewRecord" value="#{mbMain.activeStudy.uniqueIdentifier}" />

                    <!-- Selected mapping -->
                    <h:outputLabel value="Mapping: *" for="txtMappingNewRecord" />
                    <h:outputText id="txtMappingNewRecord" value="#{mbDataMapping.selectedEntity.name}" title="#{mbDataMapping.selectedEntity.description}" />

                    <!-- Mapping source data item -->
                    <h:outputLabel value="Source: *" for="cmbSource" />
                    <p:selectOneMenu
                        id="cmbSource"
                        value="#{mbDataMapping.newRecord.source}"
                        converter="#{mappedItemConverter}"
                        filter="true"
                        filterMatchMode="contains"
                        required="true"
                        requiredMessage="You have to select a source item definition, it is mandatory!"
                        rendered="#{mbDataMapping.newRecord != null}"
                        style="width:400px"
                        var="d"
                        >
                        <f:selectItem itemLabel="#{msg.search_select_one}" itemValue="-1" noSelectionOption="true" />
                        <f:selectItems
                            value="#{mbDataMapping.selectedEntity.sourceItemDefinitions}"
                            var="def"
                            itemLabel="#{def.label}"
                            itemValue="#{def}"
                            />
                        <p:column style="width:10%">
                            <h:outputText styleClass="ui-icon ui-icon-circle-check" rendered="#{mbDataMapping.selectedEntity.recordForSourceExists(d)}" />
                        </p:column>
                        <p:column>
                            <h:outputText value="#{d.label}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Mapping target data item -->
                    <h:outputLabel value="Target: *" for="cmbTarget" />
                    <p:selectOneMenu
                            id="cmbTarget"
                            value="#{mbDataMapping.newRecord.target}"
                            converter="#{mappedItemConverter}"
                            filter="true"
                            filterMatchMode="contains"
                            required="true"
                            requiredMessage="You have to select a target item definition, it is mandatory!"
                            rendered="#{mbDataMapping.newRecord != null}"
                            style="width:400px"
                            var="d"
                            >
                        <!-- AJAX update on selection changed -->
                        <p:ajax listener="#{mbDataMapping.selectedTargetChanged}"
                                update=":newRecordForm" />

                        <f:selectItem
                                itemLabel="#{msg.search_select_one}"
                                itemValue="-1"
                                noSelectionOption="true"
                                />
                        <f:selectItems
                                value="#{mbDataMapping.selectedEntity.targetItemDefinitions}"
                                var="def"
                                itemLabel="#{def.label}"
                                itemValue="#{def}"
                                />
                        <p:column style="width:10%">
                            <h:outputText styleClass="ui-icon ui-icon-circle-check" rendered="#{mbDataMapping.selectedEntity.recordForTargetExists(d)}" />
                        </p:column>
                        <p:column>
                            <h:outputText value="#{d.label}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Mapping record priority -->
                    <h:outputLabel value="Priority:" />
                    <p:spinner value="#{mbDataMapping.newRecord.priority}" />

                    <!-- In case of IMPORT, target is definitelly ODM, additional parameter can be required -->
                    <h:outputLabel value="SE repeat key:" rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}" />
                    <h:inputText
                            id="txtSeRepeatKey"
                            value="#{mbDataMapping.newRecordTargetSeRepeatKey}"
                            rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}"
                            />
                    <h:outputLabel value="IG repeat key:" rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}" />
                    <h:inputText
                            id="txtIgRepeatKey"
                            value="#{mbDataMapping.newRecordTargetIgRepeatKey}"
                            rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}"
                            />

                    <!-- Default value -->
                    <h:outputLabel value="Default value:" for="txtDefaultValue" />
                    <h:inputText id="txtDefaultValue" value="#{mbDataMapping.newRecord.defaultValue}" />

                    <!-- Multi value separator (in case of import, only when target is multicode) -->
                    <h:outputLabel
                            id="lblMultiValueSeparator"
                            value="Multi value spearator:"
                            for="txtMultiValueSeparator"
                            rendered="#{mbDataMapping.targetItemDef.multiSelectListDef != null}"
                            />
                    <h:inputText
                            id="txtMultiValueSeparator"
                            value="#{mbDataMapping.newRecord.multiValueSeparator}"
                            rendered="#{mbDataMapping.targetItemDef.multiSelectListDef != null}"
                            />

                    <!-- Source Date format string (in case of import, only when target is date or pdate) -->
                    <h:outputLabel
                            id="lblDateFormatString"
                            value="Source date format string:"
                            for="txtDateFormatString"
                            rendered="#{mbDataMapping.targetIsDate}"
                            />
                    <h:inputText
                            id="txtDateFormatString"
                            value="#{mbDataMapping.newRecord.dateFormatString}"
                            rendered="#{mbDataMapping.targetIsDate}"
                            />

                    <!-- Code re-mapping toolbar -->
                    <h:outputLabel
                            id="lblReMapCommandsNew"
                            value="Commands:"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            />
                    <p:toolbar
                            id="toolbarReMapCommandsNew"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            >
                        <!-- Left -->
                        <p:toolbarGroup align="left">
                            <!-- Autocode -->
                            <p:commandButton
                                    id="btnAddAllCodeMapNew"
                                    title="Add all codes (automap)"
                                    icon="ui-icon-play"
                                    actionListener="#{mbDataMapping.addAllCodes}"
                                    update=":growl, :newRecordForm:dtCodeMap, :newRecordForm:txtSourceCode, :newRecordForm:ddlTargetCode, :newRecordForm:txtTargetCode"
                                    immediate="true"
                                    process="@this"
                                    />

                            <!-- Add -->
                            <p:commandButton
                                    id="btnAddCodeMapNew"
                                    title="Add code mapping"
                                    icon="ui-icon-plus"
                                    actionListener="#{mbDataMapping.addCodeMapping}"
                                    update=":growl, :newRecordForm:dtCodeMap, :newRecordForm:txtSourceCode, :newRecordForm:ddlTargetCode, :newRecordForm:txtTargetCode"
                                    process="@this txtSourceCode txtTargetCode ddlTargetCode"
                                    />

                            <!-- Remove -->
                            <p:commandButton
                                    id="btnRemoveCodeMapNew"
                                    title="Remove code mapping"
                                    icon="ui-icon-minus"
                                    actionListener="#{mbDataMapping.removeCodeMapping}"
                                    update=":growl, :newRecordForm:dtCodeMap, :newRecordForm:ddlTargetCode"
                                    immediate="true"
                                    process="@this"
                                    disabled="#{mbDataMapping.selectedCodeMap == null}"
                                    />
                        </p:toolbarGroup>
                    </p:toolbar>

                    <!-- Source item code (for codded items + subject gender (that is also coded - but not as ODM data element)) -->
                    <h:outputLabel
                            id="lblSourceCode"
                            value="Source code:"
                            for="txtSourceCode"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            />
                    <h:inputText
                            id="txtSourceCode"
                            value="#{mbDataMapping.sourceCode}"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            />

                    <!-- Target code in case of IMPORT, target will be ODM -->
                    <h:outputLabel
                            id="lblTargetCode"
                            value="Target code:"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            />
                    <p:selectOneMenu
                            id="ddlTargetCode"
                            value="#{mbDataMapping.targetCode}"
                            filter="true"
                            filterMatchMode="contains"
                            required="true"
                            requiredMessage="You have to select a target item code, it is mandatory!"
                            rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT' and mbDataMapping.targetIsCoded and mbDataMapping.targetItemDef != null}"
                            style="width:400px"
                            >
                        <f:selectItem
                                itemLabel="#{msg.search_select_one}"
                                itemValue="-1"
                                />
                        <f:selectItems
                                value="#{mbDataMapping.targetItemDef.getListItems()}"
                                var="item"
                                itemLabel="#{item.codedValue} [#{item.decodedText}]"
                                itemValue="#{item.codedValue}"
                                />
                    </p:selectOneMenu>

                    <!-- Target target can be whatever -->
                    <h:inputText
                            id="txtTargetCode"
                            value="#{mbDataMapping.targetCode}"
                            rendered="#{mbDataMapping.targetItemDef == null and mbDataMapping.targetIsCoded}"
                            />

                    <!-- Code Map Table -->
                    <h:outputLabel
                            value="Code mappings:"
                            for="dtCodeMapEdit"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            />
                    <p:dataTable
                            id="dtCodeMap"
                            value="#{mbDataMapping.newRecord.mappingAsList()}"
                            widgetVar="editCodeMapTable"
                            var="editMapDef"
                            type="ordered"
                            itemType="none"
                            paginator="True"
                            rows="5"
                            styleClass="paginated"
                            emptyMessage="No code mapping rules found with given criteria"
                            filteredValue="#{mbDataMapping.filteredCodes}"
                            selection="#{mbDataMapping.selectedCodeMap}"
                            selectionMode="single"
                            rowKey="#{editMapDef.key}"
                            rowIndexVar="editCmRowIndex"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            >

                        <!--AJAX onclick on datatable row-->
                        <p:ajax event="rowSelect" update=":newRecordForm:btnRemoveCodeMapNew"/>

                        <!-- Row -->
                        <p:column
                                style="width:3%"
                                exportable="false"
                                >
                            <f:facet name="header">
                                <h:outputText value="#" />
                            </f:facet>
                            <h:outputText value="#{editCmRowIndex + 1}" />
                        </p:column>

                        <!-- Map key -->
                        <p:column
                                sortBy="#{editMapDef.key}"
                                filterBy="#{editMapDef.key}"
                                filterMatchMode="contains"
                                >
                            <f:facet name="header">
                                <h:outputText value="Source Key" />
                            </f:facet>
                            <h:outputText value="#{editMapDef.key}" />
                        </p:column>

                        <!-- Map value -->
                        <p:column
                                sortBy="#{editMapDef.value}"
                                filterBy="#{editMapDef.value}"
                                filterMatchMode="contains"
                                >
                            <f:facet name="header">
                                <h:outputText value="Taret Value" />
                            </f:facet>
                            <h:outputText value="#{editMapDef.value}" />
                        </p:column>

                        <f:facet name="footer">
                            In total there are #{fn:length(mbDataMapping.selectedRecord.mappingAsList())} code map definitions for this mapping record.
                        </f:facet>
                    </p:dataTable>

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_save}"
                                update=":form:tabView:dtRecords, :growl"
                                icon="ui-icon-disk"
                                actionListener="#{mbDataMapping.doCreateRecordEntity}"
                                oncomplete=" handleSubmitRequest(xhr, status, args, 'dlgNewRecord','newRecordForm');"
                                process="@this newRecordForm"
                                />
                        <p:commandButton value="#{msg.menu_reset}" type="reset" icon="ui-icon-close" />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Edit Record -->
        <p:dialog
                id="dlgEditRecord"
                header="Edit the selected data mapping record"
                widgetVar="editRecordDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >
            <h:form id="editRecordForm">
                <p:panelGrid
                        id="editRecordDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >
                    <!-- OpenClinica active study -->
                    <h:outputLabel value="Study: *" for="txtStudyEditRecord" />
                    <h:outputText id="txtStudyEditRecord" value="#{mbMain.activeStudy.uniqueIdentifier}" />

                    <!-- Selected mapping -->
                    <h:outputLabel value="Mapping: *" for="txtMappingEditRecord" />
                    <h:outputText id="txtMappingEditRecord" value="#{mbDataMapping.selectedEntity.name}" title="#{mbDataMapping.selectedEntity.description}" />

                    <!-- Mapping source data item -->
                    <h:outputLabel value="Source: *" for="cmbEditSource" />
                    <p:selectOneMenu
                            id="cmbEditSource"
                            value="#{mbDataMapping.selectedRecord.source}"
                            converter="#{mappedItemConverter}"
                            filter="true"
                            filterMatchMode="contains"
                            required="true"
                            requiredMessage="You have to select a source item definition, it is mandatory!"
                            rendered="#{mbDataMapping.selectedRecord != null}"
                            style="width:350px"
                            var="sourceDef"
                            >
                        <f:selectItems
                                value="#{mbDataMapping.selectedEntity.sourceItemDefinitions}"
                                var="sd"
                                itemLabel="#{sd.label}"
                                itemValue="#{sd}"
                                />
                        <p:column style="width:10%">
                            <h:outputText styleClass="ui-icon ui-icon-circle-check" rendered="#{mbDataMapping.selectedEntity.recordForSourceExists(sourceDef)}" />
                        </p:column>
                        <p:column>
                            <h:outputText value="#{sourceDef.label}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Mapping target data item -->
                    <h:outputLabel value="Target: *" for="cmbEditTarget" />
                    <p:selectOneMenu
                            id="cmbEditTarget"
                            value="#{mbDataMapping.selectedRecord.target}"
                            converter="#{mappedItemConverter}"
                            filter="true"
                            filterMatchMode="contains"
                            required="true"
                            requiredMessage="You have to select a target item definition, it is mandatory!"
                            rendered="#{mbDataMapping.selectedRecord != null}"
                            style="width:350px"
                            var="targetDef"
                            >
                        <!-- AJAX update on selection changed -->
                        <!-- When target is codified, it should be possible to recode the source data -->
                        <p:ajax
                            listener="#{mbDataMapping.selectedTargetChanged}"
                            update=":editRecordForm"
                            />

                        <f:selectItems
                            value="#{mbDataMapping.selectedEntity.targetItemDefinitions}"
                            var="td"
                            itemLabel="#{td.label}"
                            itemValue="#{td}"
                            />
                        <p:column style="width:10%">
                            <h:outputText styleClass="ui-icon ui-icon-circle-check" rendered="#{mbDataMapping.selectedEntity.recordForTargetExists(targetDef)}" />
                        </p:column>
                        <p:column>
                            <h:outputText value="#{targetDef.label}" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- Mapping record priority -->
                    <h:outputLabel value="Priority:" for="txtPriority" />
                    <p:spinner
                            id="txtPriority"
                            value="#{mbDataMapping.selectedRecord.priority}"
                            />

                    <!-- In case of IMPORT, target is definitelly ODM, additional parameter can be necessary -->
                    <h:outputLabel
                            value="SE repeat key:"
                            for="txtSeRepeatKeyEdit"
                            rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}"
                            />
                    <h:inputText
                            id="txtSeRepeatKeyEdit"
                            value="#{mbDataMapping.selectedRecordTargetSeRepeatKey}"
                            title="Repeating study event occurence number"
                            rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}"
                            />
                    <h:outputLabel
                            value="IG repeat key:"
                            for="txtIgRepeatKeyEdit"
                            rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}"
                            />
                    <h:inputText
                            id="txtIgRepeatKeyEdit"
                            value="#{mbDataMapping.selectedRecordTargetIgRepeatKey}"
                            title="Repeating item row number in grid"
                            rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}"
                            />

                    <!-- Default value -->
                    <h:outputLabel value="Default value:" for="txtDefaultValueEdit" />
                    <h:inputText id="txtDefaultValueEdit" value="#{mbDataMapping.selectedRecord.defaultValue}" />

                    <!-- Multi value separator (in case of import, only when target is multicode) -->
                    <h:outputLabel
                            value="Multi value spearator:"
                            for="txtMultiValueSeparatorEdit"
                            rendered="#{mbDataMapping.targetItemDef.multiSelectListDef != null}"
                            />
                    <h:inputText
                            id="txtMultiValueSeparatorEdit"
                            value="#{mbDataMapping.selectedRecord.multiValueSeparator}"
                            rendered="#{mbDataMapping.targetItemDef.multiSelectListDef != null}"
                            />

                    <!-- Source Date format string (in case of import, only when target is date or pdate) -->
                    <h:outputLabel
                            value="Source date format string:"
                            for="txtDateFormatStringEdit"
                            rendered="#{mbDataMapping.targetIsDate}"
                            />
                    <h:inputText
                            id="txtDateFormatStringEdit"
                            value="#{mbDataMapping.selectedRecord.dateFormatString}"
                            rendered="#{mbDataMapping.targetIsDate}"
                            />

                    <!-- Code re-mapping toolbar -->
                    <h:outputLabel
                            id="lblReMapCommands"
                            value="Commands:"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            />
                    <p:toolbar
                            id="toolbarReMapCommands"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            >
                        <!-- Left -->
                        <p:toolbarGroup align="left">
                            <!-- Autocode -->
                            <p:commandButton
                                    id="btnAddAllCodeMapEdit"
                                    title="Add all codes (automap)"
                                    icon="ui-icon-play"
                                    actionListener="#{mbDataMapping.addAllCodes}"
                                    update=":growl, :editRecordForm:dtCodeMapEdit, :editRecordForm:txtSourceCodeEdit, :editRecordForm:ddlTargetCodeEdit, :editRecordForm:txtTargetCodeEdit"
                                    immediate="true"
                                    process="@this"
                                    />

                            <!-- Add -->
                            <p:commandButton
                                    id="btnAddCodeMapEdit"
                                    title="Add code mapping"
                                    icon="ui-icon-plus"
                                    actionListener="#{mbDataMapping.addCodeMapping}"
                                    update=":growl, :editRecordForm:dtCodeMapEdit, :editRecordForm:txtSourceCodeEdit, :editRecordForm:ddlTargetCodeEdit, :editRecordForm:txtTargetCodeEdit"
                                    process="@this txtSourceCodeEdit txtTargetCodeEdit ddlTargetCodeEdit"
                                    />

                            <!-- Remove -->
                            <p:commandButton
                                    id="btnRemoveCodeMapEdit"
                                    title="Remove code mapping"
                                    icon="ui-icon-minus"
                                    actionListener="#{mbDataMapping.removeCodeMapping}"
                                    update=":growl, :editRecordForm:dtCodeMapEdit, :editRecordForm:ddlTargetCodeEdit"
                                    immediate="true"
                                    process="@this"
                                    disabled="#{mbDataMapping.selectedCodeMap == null}"
                                    />
                        </p:toolbarGroup>
                    </p:toolbar>

                    <!-- Source item code (for codded items + subject gender (that is also coded - but not as ODM data element)) -->
                    <h:outputLabel
                            value="Source code:"
                            for="txtSourceCodeEdit"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            />
                    <h:inputText
                            id="txtSourceCodeEdit"
                            value="#{mbDataMapping.sourceCode}"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            />

                    <!-- Target code in case of IMPORT, target will be ODM -->
                    <h:outputLabel
                            value="Target code:"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            />
                    <p:selectOneMenu
                            id="ddlTargetCodeEdit"
                            value="#{mbDataMapping.selectedOdmTargetCode}"
                            converter="#{transientConverter}"
                            filter="true"
                            filterMatchMode="contains"
                            required="true"
                            requiredMessage="You have to select a target item code, it is mandatory!"
                            rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT' and mbDataMapping.targetIsCoded and mbDataMapping.targetItemDef != null}"
                            style="width:450px"
                            var="editTargetCode"
                            >

                        <f:selectItems
                                value="#{mbDataMapping.targetItemDef.getListItems()}"
                                var="item"
                                itemLabel="#{item.codedValue} [#{item.decodedText}]"
                                itemValue="#{item}"
                                />
                        <p:column style="width:10%">
                            <h:outputText
                                    styleClass="ui-icon ui-icon-circle-check"
                                    rendered="#{mbDataMapping.selectedRecord.recodeForTargetExists(editTargetCode.codedValue)}"
                                    />
                        </p:column>
                        <p:column>
                            <h:outputText value="#{editTargetCode.codedValue} [#{editTargetCode.decodedText}]" />
                        </p:column>
                    </p:selectOneMenu>

                    <!-- SS_GENDER or export mapping -->
                    <h:inputText
                            id="txtTargetCodeEdit"
                            value="#{mbDataMapping.targetCode}"
                            rendered="#{mbDataMapping.targetItemDef == null and mbDataMapping.targetIsCoded}"
                            />

                    <!-- Code Map Table -->
                    <h:outputLabel
                            value="Code mappings:"
                            for="dtCodeMapEdit"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            />
                    <p:dataTable
                            id="dtCodeMapEdit"
                            value="#{mbDataMapping.selectedRecord.mappingAsList()}"
                            widgetVar="editCodeMapTable"
                            var="editMapDef"
                            type="ordered"
                            itemType="none"
                            paginator="True"
                            rows="5"
                            styleClass="paginated"
                            emptyMessage="No code mapping rules found with given criteria"
                            filteredValue="#{mbDataMapping.filteredCodes}"
                            selection="#{mbDataMapping.selectedCodeMap}"
                            selectionMode="single"
                            rowKey="#{editMapDef.key}"
                            rowIndexVar="editCmRowIndex"
                            rendered="#{mbDataMapping.targetIsCoded}"
                            >

                        <!--AJAX onclick on datatable row-->
                        <p:ajax event="rowSelect" update=":editRecordForm:btnRemoveCodeMapEdit"/>

                        <!-- Row -->
                        <p:column
                                style="width:3%"
                                exportable="false"
                                >
                            <f:facet name="header">
                                <h:outputText value="#" />
                            </f:facet>
                            <h:outputText value="#{editCmRowIndex + 1}" />
                        </p:column>

                        <!-- Map key -->
                        <p:column
                                sortBy="#{editMapDef.key}"
                                filterBy="#{editMapDef.key}"
                                filterMatchMode="contains"
                                >
                            <f:facet name="header">
                                <h:outputText value="Source Key" />
                            </f:facet>
                            <h:outputText value="#{editMapDef.key}" />
                        </p:column>

                        <!-- Map value -->
                        <p:column
                                sortBy="#{editMapDef.value}"
                                filterBy="#{editMapDef.value}"
                                filterMatchMode="contains"
                                >
                            <f:facet name="header">
                                <h:outputText value="Taret Value" />
                            </f:facet>
                            <h:outputText value="#{editMapDef.value}" />
                        </p:column>

                        <f:facet name="footer">
                            In total there are #{fn:length(mbDataMapping.selectedRecord.mappingAsList())} code map definitions for this mapping record.
                        </f:facet>
                    </p:dataTable>

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_update}"
                                update=":form:tabView:dtRecords, :growl"
                                icon="ui-icon-disk"
                                actionListener="#{mbDataMapping.doUpdateRecordEntity}"
                                oncomplete=" handleSubmitRequest(xhr, status, args, 'dlgEditRecord','editRecordForm');"
                                process="@this txtMultiValueSeparatorEdit txtPriority txtDateFormatStringEdit txtDefaultValueEdit"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Delete Record-->
        <p:dialog
                id="dlgDeleteRecord"
                header="Delete the selected data mapping record"
                widgetVar="deleteRecordDialog"
                resizable="false"
                ajax="true"
                appendToBody="true"
                modal="true"
                closeOnEscape="true"
                >
            <h:form id="deleteRecordForm">
                <p:panelGrid
                        id="deleteRecordDisplay"
                        columns="2"
                        cellpadding="4"
                        style="margin:0 auto;"
                        >

                    <!-- OpenClinica active study -->
                    <h:outputLabel value="Study: *" for="txtStudyDeleteRecord" />
                    <h:outputText id="txtStudyDeleteRecord" value="#{mbMain.activeStudy.uniqueIdentifier}" />

                    <!-- Selected mapping -->
                    <h:outputLabel value="Mapping: *" for="txtMappingDeleteRecord" />
                    <h:outputText id="txtMappingDeleteRecord" value="#{mbDataMapping.selectedEntity.name}" title="#{mbDataMapping.selectedEntity.description}" />

                    <!-- Mapping source data item -->
                    <h:outputLabel value="Source: *" for="txtDeleteSource" />
                    <h:outputText id="txtDeleteSource" value="#{mbDataMapping.selectedRecord.source.label}" />

                    <!-- Mapping target data item -->
                    <h:outputLabel value="Target: *" for="txtDeleteTarget" />
                    <h:outputText id="txtDeleteTarget" valu="#{mbDataMapping.selectedRecord.target.label}" />

                    <!-- Mapping record priority -->
                    <h:outputLabel value="Priority:" for="txtDeletePriority"/>
                    <h:outputText id="txtDeletePriority" valu="#{mbDataMapping.selectedRecord.priority}" />

                    <!-- In case of IMPORT, target is definitelly ODM, additional parameter can be required -->
                    <h:outputLabel value="SE repeat key:" rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}" />
                    <h:outputText
                            id="txtSeRepeatKeyDelete"
                            value="#{mbDataMapping.selectedRecordTargetSeRepeatKey}"
                            rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}"
                            />
                    <h:outputLabel value="IG repeat key:" rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}" />
                    <h:outputText
                            id="txtIgRepeatKeyDelete"
                            value="#{mbDataMapping.selectedRecordTargetIgRepeatKey}"
                            rendered="#{mbDataMapping.selectedEntity.type == 'IMPORT'}"
                            />

                    <!-- Default value -->
                    <h:outputLabel value="Default value:" for="txtDefaultValueDelete" />
                    <h:outputText id="txtDefaultValueDelete" value="#{mbDataMapping.selectedRecord.defaultValue}" />

                    <!-- Multi value separator -->
                    <h:outputLabel value="Multi value spearator:" for="txtMultiValueSeparatorDelete" />
                    <h:outputText id="txtMultiValueSeparatorDelete" value="#{mbDataMapping.selectedRecord.multiValueSeparator}" />

                    <!-- Source Date format string -->
                    <h:outputLabel value="Source date format string:" for="txtDateFormatStringDelete" />
                    <h:outputText id="txtDateFormatStringDelete" value="#{mbDataMapping.selectedRecord.dateFormatString}" />

                    <!-- Code Map -->
                    <h:outputLabel value="Code map:" for="dlCodeMapDelete" />
                    <p:dataList
                            id="dlCodeMapDelete"
                            value="#{mbDataMapping.selectedRecord.mapping}"
                            var="mapDef"
                            type="ordered"
                            >
                        <f:facet name="header">
                            Code mappings
                        </f:facet>
                        #{mapDef}
                    </p:dataList>

                    <!-- Commands -->
                    <f:facet name="footer">
                        <p:commandButton
                                value="#{msg.menu_delete}"
                                update=":form:tabView:dtRecords, :growl"
                                icon="ui-icon-disk"
                                actionListener="#{mbDataMapping.doDeleteRecordEntity}"
                                oncomplete=" handleSubmitRequest(xhr, status, args, 'dlgDeleteRecord','deleteRecordForm');"
                                process="@this deleteRecordForm"
                                />
                    </f:facet>
                </p:panelGrid>
            </h:form>
        </p:dialog>

        <!-- Submit from dialog -->
        <script type="text/javascript">
            function handleSubmitRequest(xhr, status, args, dialogName, formName) {
                dialog = jQuery('#'+dialogName);
                if(args.validationFailed) {
                    dialog.effect("shake", { times:3 }, 100);
                } else {
                    clearForm(formName);

                    PF('newMappingDialog').hide();
                    PF('deleteMappingDialog').hide();
                    PF('editMappingDialog').hide();

                    PF('newRecordDialog').hide();
                    PF('editRecordDialog').hide();
                    PF('deleteRecordDialog').hide();
                }
            }
            function clearForm(formName) {
                jQuery('#'+formName).each(function() {
                    this.reset();
                });
            }
        </script>
    </ui:define>
</ui:composition>